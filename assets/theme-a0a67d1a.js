var F=Object.defineProperty;var I=(u,o,l)=>o in u?F(u,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):u[o]=l;var U=(u,o,l)=>(I(u,typeof o!="symbol"?o+"":o,l),l);import{U as A}from"./Utils-45e0ac39.js";import{T as G,a as H,D as J}from"./ThemeViewGUI-6a7b40d0.js";import{L as N,S as W}from"./Checkbox-95d1bef9.js";import{Q as M,H as Z,F as z,C as P}from"./Tr-f3889a5f.js";import{V as Q,a4 as D}from"./preload-helper-8e11edef.js";import{L as B}from"./LocalStorageSource-152a04ab.js";import{g as q}from"./_commonjsHelpers-de833af9.js";import{ac as K,ad as X,ae as Y,ab as E,l as $,a8 as j,al as V}from"./SubtleLink-e2b00750.js";import{q as ee,a as te,c as ne,d as oe,D as ie}from"./questions-3ec576a2.js";import{k as _}from"./index-a4314705.js";import{C as re}from"./Constants-66b06235.js";import"./UIEventSource-b2e0ae35.js";import"./OsmConnection-419e8a8f.js";import"./FeatureSwitchState-87405268.js";import"./placeholder-aed0cfa1.js";import"./index-44f7831e.js";import"./Loading-4888c235.js";import"./tw-merge-2cd9e3ed.js";import"./MvtSource-c54d0bd3.js";import"./Add-fc09a14b.js";import"./LanguagePicker-99e74106.js";import"./Dropdown-0d9db6f0.js";import"./Community-091541a2.js";import"./Filterview-a8d22b17.js";import"./PrivacyPolicy-9707167a.js";import"./BackButton-b763c3b3.js";import"./Login-ebcf4fd9.js";var O={exports:{}};O.exports;(function(u){var o=function(){var l=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",R={};function p(n,r){if(!R[n]){R[n]={};for(var d=0;d<n.length;d++)R[n][n.charAt(d)]=d}return R[n][r]}var t={compressToBase64:function(n){if(n==null)return"";var r=t._compress(n,6,function(d){return e.charAt(d)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(n){return n==null?"":n==""?null:t._decompress(n.length,32,function(r){return p(e,n.charAt(r))})},compressToUTF16:function(n){return n==null?"":t._compress(n,15,function(r){return l(r+32)})+" "},decompressFromUTF16:function(n){return n==null?"":n==""?null:t._decompress(n.length,16384,function(r){return n.charCodeAt(r)-32})},compressToUint8Array:function(n){for(var r=t.compress(n),d=new Uint8Array(r.length*2),a=0,s=r.length;a<s;a++){var g=r.charCodeAt(a);d[a*2]=g>>>8,d[a*2+1]=g%256}return d},decompressFromUint8Array:function(n){if(n==null)return t.decompress(n);for(var r=new Array(n.length/2),d=0,a=r.length;d<a;d++)r[d]=n[d*2]*256+n[d*2+1];var s=[];return r.forEach(function(g){s.push(l(g))}),t.decompress(s.join(""))},compressToEncodedURIComponent:function(n){return n==null?"":t._compress(n,6,function(r){return v.charAt(r)})},decompressFromEncodedURIComponent:function(n){return n==null?"":n==""?null:(n=n.replace(/ /g,"+"),t._decompress(n.length,32,function(r){return p(v,n.charAt(r))}))},compress:function(n){return t._compress(n,16,function(r){return l(r)})},_compress:function(n,r,d){if(n==null)return"";var a,s,g={},b={},L="",x="",y="",T=2,w=3,m=2,h=[],i=0,f=0,c;for(c=0;c<n.length;c+=1)if(L=n.charAt(c),Object.prototype.hasOwnProperty.call(g,L)||(g[L]=w++,b[L]=!0),x=y+L,Object.prototype.hasOwnProperty.call(g,x))y=x;else{if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(a=0;a<m;a++)i=i<<1,f==r-1?(f=0,h.push(d(i)),i=0):f++;for(s=y.charCodeAt(0),a=0;a<8;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1}else{for(s=1,a=0;a<m;a++)i=i<<1|s,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=0;for(s=y.charCodeAt(0),a=0;a<16;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1}T--,T==0&&(T=Math.pow(2,m),m++),delete b[y]}else for(s=g[y],a=0;a<m;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1;T--,T==0&&(T=Math.pow(2,m),m++),g[x]=w++,y=String(L)}if(y!==""){if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(a=0;a<m;a++)i=i<<1,f==r-1?(f=0,h.push(d(i)),i=0):f++;for(s=y.charCodeAt(0),a=0;a<8;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1}else{for(s=1,a=0;a<m;a++)i=i<<1|s,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=0;for(s=y.charCodeAt(0),a=0;a<16;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1}T--,T==0&&(T=Math.pow(2,m),m++),delete b[y]}else for(s=g[y],a=0;a<m;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1;T--,T==0&&(T=Math.pow(2,m),m++)}for(s=2,a=0;a<m;a++)i=i<<1|s&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,s=s>>1;for(;;)if(i=i<<1,f==r-1){h.push(d(i));break}else f++;return h.join("")},decompress:function(n){return n==null?"":n==""?null:t._decompress(n.length,32768,function(r){return n.charCodeAt(r)})},_decompress:function(n,r,d){var a=[],s=4,g=4,b=3,L="",x=[],y,T,w,m,h,i,f,c={val:d(0),position:r,index:1};for(y=0;y<3;y+=1)a[y]=y;for(w=0,h=Math.pow(2,2),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;switch(w){case 0:for(w=0,h=Math.pow(2,8),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;f=l(w);break;case 1:for(w=0,h=Math.pow(2,16),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;f=l(w);break;case 2:return""}for(a[3]=f,T=f,x.push(f);;){if(c.index>n)return"";for(w=0,h=Math.pow(2,b),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;switch(f=w){case 0:for(w=0,h=Math.pow(2,8),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;a[g++]=l(w),f=g-1,s--;break;case 1:for(w=0,h=Math.pow(2,16),i=1;i!=h;)m=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),w|=(m>0?1:0)*i,i<<=1;a[g++]=l(w),f=g-1,s--;break;case 2:return x.join("")}if(s==0&&(s=Math.pow(2,b),b++),a[f])L=a[f];else if(f===g)L=T+T.charAt(0);else return null;x.push(L),a[g++]=T+L.charAt(0),s--,T=L,s==0&&(s=Math.pow(2,b),b++)}}};return t}();u!=null&&(u.exports=o)})(O);var ae=O.exports;const k=q(ae);class se extends E{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(o,l){var R;if(typeof o=="string"||o.builtin!==void 0)return o;l=l.enter(o.id);let e={...o};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags);for(const p of e.presets??[]){const t=p.preciseInput;typeof t=="boolean"?delete p.preciseInput:t!==void 0&&(delete t.preferredBackground,p.snapToLayer=t.snapToLayer,delete t.snapToLayer,t.maxSnapDistance&&(p.maxSnapDistance=t.maxSnapDistance,delete t.maxSnapDistance),Object.keys(t).length==0&&delete p.preciseInput),typeof p.snapToLayer=="string"&&(p.snapToLayer=[p.snapToLayer])}if(e.tagRenderings!==void 0){let p=0;for(const t of e.tagRenderings)t&&(p++,!(typeof t=="string"||t.builtin!==void 0||t.rewrite!==void 0)&&t.id===void 0&&(t["#"]!==void 0?(t.id=t["#"],delete t["#"]):((R=t.freeform)==null?void 0:R.key)!==void 0?t.id=e.id+"-"+t.freeform.key:t.id="tr-"+p))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let p=["point"],t=e.wayHandling??0;if(t!==0&&(p=["point","centroid"]),e.icon??e.label!==void 0){const n={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:p,rotation:e.rotation};e.mapRendering.push(n)}if(t!==1){const n={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(n).length>0&&e.mapRendering.push(n)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const v=e.source;delete v.isOsmCache,delete v.maxCacheAge,delete v.widenFactor;for(const p of e.mapRendering??[]){p.iconOverlays!==void 0&&(p.iconBadges=p.iconOverlays);for(const t of p.iconBadges??[])t.badge!==!0&&l.enters("iconBadges","badge").warn("Non-overlay element"),delete t.badge}if(e.mapRendering){const p=[],t=[];for(const n of e.mapRendering)n.location?p.push(n):t.push(n);e.pointRendering=p,e.lineRendering=t,delete e.mapRendering}for(const p of e.pointRendering??[]){const t=p;if(t.icon)try{let r=t.icon;Object.keys(r).length===1&&r.render!==void 0&&(r=r.render);const d=A.NoEmpty(r.split(";"));t.marker=d.map(a=>{if(a.startsWith("http"))return{icon:a};const[s,g]=a.split(":");return{icon:s,color:g}}),delete t.icon}catch{console.error("Could not handle icon in",o.id),t.marker=[{icon:t.icon}],delete t.icon}let n=t.iconSize;if(n&&(Object.keys(t.iconSize).length===1&&t.iconSize.render!==void 0&&(n=t.iconSize.render),typeof n=="string"&&["bottom","center","top"].some(r=>n.endsWith(r)))){const r=n.split(",").map(d=>d.toLowerCase().trim());t.anchor=r.pop(),t.iconSize=r.join(",")}}if(e.pointRendering)for(const p of e.pointRendering)for(const t in p)p[t]&&typeof p[t].render=="string"&&Object.keys(p[t]).length===1&&(p[t]=p[t].render);if(e.lineRendering)for(const p of e.lineRendering)for(const t in p)p[t]&&typeof p[t].render=="string"&&Object.keys(p[t]).length===1&&(p[t]=p[t].render);return e}}class le extends E{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(o,l){const e={...o};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return l.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=A.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class ce extends K{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new le,new X("layers",new Y(new se)))}}const S=class S{static getCustomDefinition(){const o=decodeURIComponent(S.loadCustomThemeParam.data);if(o.startsWith("http"))return o;if(o!=="false"){const l=Z.hash.data;try{return JSON.parse(atob(l)),atob(l)}catch{return JSON.parse(A.UnMinify(k.decompressFromBase64(l))),A.UnMinify(k.decompressFromBase64(l))}}}static async GetLayout(){const o=decodeURIComponent(S.loadCustomThemeParam.data);if(o.startsWith("http"))return await S.LoadRemoteTheme(o);if(o!=="false")return S.LoadLayoutFromHash(S.loadCustomThemeParam);let l;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(l=e,e.endsWith(".html")&&(l=e.substr(0,e.length-5)),console.log("Using layout",l)),l=M.GetQueryParameter("layout",l,"The layout to load into MapComplete").data;const v=Q.allKnownLayouts.get(l==null?void 0:l.toLowerCase());if(v===void 0)throw"No builtin map theme with name "+l+" exists";return v}static LoadLayoutFromHash(o){var t,n;let l=location.hash.substr(1),e;const v=B.Get("user-layout-"+((t=o.data)==null?void 0:t.replace(" ","_")));((n=v.data)==null?void 0:n.length)<10&&v.setData(void 0);const R=B.Get("last-loaded-user-layout");l.length<10?l=v.data??R.data:(console.log("Saving hash to local storage"),R.setData(l),v.setData(l));try{e=JSON.parse(atob(l))}catch{e=JSON.parse(A.UnMinify(k.decompressFromBase64(l)))}const p=S.prepCustomTheme(e);return o.setData(p.id),p}static getSharedTagRenderings(){const o=new Map;for(const l of ee.tagRenderings)o.set(l.id,l);return o}static prepCustomTheme(o,l,e){if(o.layers===void 0&&o.tagRenderings!==void 0){const n=o.pointRendering.map(d=>{var a,s;return(s=(a=d==null?void 0:d.marker)==null?void 0:a.find(g=>g.icon!==void 0))==null?void 0:s.icon}).find(d=>d!==void 0)??"bug",r=new j(n).render.txt;o={id:o.id,description:o.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:r,title:o.name,layers:[o]}}const v=new Map;for(const t in D.layers){const n=D.layers[t];v.set(n.id,n)}const R={tagRenderings:S.getSharedTagRenderings(),sharedLayers:v,publicLayers:new Set};o=new ce().convertStrict(o);const p=o;return o=new V(S._knownImages).convertStrict(o),o.enableNoteImports=o.enableNoteImports??!1,o=new te(R).convertStrict(o),console.log("The layoutconfig is ",o),o.id=e??o.id,new ne().convertStrict(o),new oe(new ie(new Set,t=>!0),"",!1).convertStrict(o),new N(o,!1,{definitionRaw:JSON.stringify(p,null,"  "),definedAtUrl:l})}static async LoadRemoteTheme(o){console.log("Downloading map theme from ",o),new z(`Downloading the theme from the <a href="${o}">link</a>...`).AttachTo("maindiv");let l=await A.downloadJson(o),e=l.id;const v=new URL(o);return v.hostname==="localhost"||v.hostname==="127.0.0.1"||(e=o),console.log("Loaded remote link:",o),S.prepCustomTheme(l,o,e)}};U(S,"_knownImages",new Set(Array.from($).map(o=>o.path))),U(S,"loadCustomThemeParam",M.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let C=S;function de(){try{const u=document.createElement("canvas");return!!window.WebGLRenderingContext&&(u.getContext("webgl")||u.getContext("experimental-webgl"))}catch{return!1}}async function fe(){try{const u=new URL(re.VectorTileServer).host,o=await A.downloadJson("https://"+u+"/summary/status.json");return new Set(o.layers)}catch(u){return console.error("Could not get MVT available layers due to",u),new Set}}async function pe(){try{if(!de())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[u,o]=await Promise.all([C.GetLayout(),await fe()]);console.log("The available layers on server are",Array.from(o));const l=new G(u,o);new _(H,{state:l}).AttachTo("maindiv")}catch(u){console.error("Error while initializing: ",u,u.stack);const o=C.getCustomDefinition();new P([new z(u).SetClass("block alert"),(o==null?void 0:o.length)>0?new W(new _(J),"Download the raw file").onClick(()=>A.offerContentsAsDownloadableFile(C.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}pe().then(u=>{});
//# sourceMappingURL=theme-a0a67d1a.js.map
