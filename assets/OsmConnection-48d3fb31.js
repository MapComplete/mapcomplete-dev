var E=Object.defineProperty;var O=(s,e,t)=>e in s?E(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var d=(s,e,t)=>(O(s,typeof e!="symbol"?e+"":e,t),t);import{s as C}from"./store.legacy-2a1c0432.js";import{L as T,U as m,S as L}from"./LocalStorageSource-df033e8b.js";import{U as p}from"./Utils-81aafc52.js";import{C as k}from"./Constants-992b16aa.js";function x(s){var e={};e.authenticated=function(){return!!n("oauth2_access_token")},e.logout=function(){return n("oauth2_access_token",""),n("oauth_token",""),n("oauth_token_secret",""),n("oauth_request_token_secret",""),e},e.authenticate=function(a){if(e.authenticated()){a(null,e);return}e.logout(),I(function(o){t(o,a)})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((a,o)=>{var l=(u,c)=>{u?o(new Error(u)):a(c)};I(u=>t(u,l))}))};function t(a,o){var l=M(),u=s.url+"/oauth2/authorize?"+P({client_id:s.client_id,redirect_uri:s.redirect_uri,response_type:"code",scope:s.scope,state:l,code_challenge:a.code_challenge,code_challenge_method:a.code_challenge_method});if(s.singlepage){if(!C.enabled){var c=new Error("local storage unavailable, but require in singlepage mode");c.status="pkce-localstorage-unavailable",o(c);return}var f=y(window.location.search.slice(1));f.code?e.bootstrapToken(f.code,o):(n("oauth2_state",l),n("oauth2_pkce_code_verifier",a.code_verifier),window.location=u)}else{var h=600,g=550,w=[["width",h],["height",g],["left",window.screen.width/2-h/2],["top",window.screen.height/2-g/2]].map(function(_){return _.join("=")}).join(","),v=window.open("about:blank","oauth_window",w);e.popupWindow=v,v.location=u,v||(c=new Error("Popup was blocked"),c.status="popup-blocked",o(c))}window.authComplete=function(_){var b=y(_.split("?")[1]);if(b.state!==l){c=new Error("Invalid state"),c.status="invalid-state",o(c);return}r(b.code,a.code_verifier,S),delete window.authComplete};function S(_,b){if(s.done(),_){o(_);return}var U=JSON.parse(b.response);n("oauth2_access_token",U.access_token),o(null,e)}}function r(a,o,l){var u=s.url+"/oauth2/token?"+P({client_id:s.client_id,redirect_uri:s.redirect_uri,grant_type:"authorization_code",code:a,code_verifier:o});e.rawxhr("POST",u,null,null,null,l),s.loading()}e.bringPopupWindowToFront=function(){var a=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),a=!0)}catch{}return a},e.bootstrapToken=function(a,o){var l=n("oauth2_state");n("oauth2_state","");var u=y(window.location.search.slice(1));if(u.state!==l){var c=new Error("Invalid state");c.status="invalid-state",o(c);return}var f=n("oauth2_pkce_code_verifier");n("oauth2_pkce_code_verifier",""),r(a,f,h);function h(g,w){if(s.done(),g){o(g);return}var v=JSON.parse(w.response);n("oauth2_access_token",v.access_token),o(null,e)}},e.fetch=function(a,o){if(e.authenticated())return l();return s.auto?e.authenticateAsync().then(l):Promise.reject(new Error("not authenticated"));function l(){return o=o||{},o.headers||(o.headers={"Content-Type":"application/x-www-form-urlencoded"}),o.headers.Authorization="Bearer "+n("oauth2_access_token"),fetch(a,o)}},e.xhr=function(a,o){if(e.authenticated())return l();if(s.auto){e.authenticate(l);return}else{o("not authenticated",null);return}function l(){var c=a.prefix!==!1?s.url+a.path:a.path;return e.rawxhr(a.method,c,n("oauth2_access_token"),a.content,a.headers,u)}function u(c,f){c?o(c):f.responseXML?o(c,f.responseXML):o(c,f.response)}},e.rawxhr=function(a,o,l,u,c,f){c=c||{"Content-Type":"application/x-www-form-urlencoded"},l&&(c.Authorization="Bearer "+l);var h=new XMLHttpRequest;h.onreadystatechange=function(){h.readyState===4&&h.status!==0&&(/^20\d$/.test(h.status)?f(null,h):f(h,null))},h.onerror=function(w){f(w,null)},h.open(a,o,!0);for(var g in c)h.setRequestHeader(g,c[g]);return h.send(u),h},e.preauth=function(a){return a&&a.access_token&&n("oauth2_access_token",a.access_token),e},e.options=function(a){return arguments.length?(s=a,s.url=s.url||"https://www.openstreetmap.org",s.auto=s.auto||!1,s.singlepage=s.singlepage||!1,s.loading=s.loading||function(){},s.done=s.done||function(){},e.preauth(s)):s};var n;if(C.enabled)n=function(a,o){if(arguments.length===1)return C.get(s.url+a);if(arguments.length===2)return C.set(s.url+a,o)};else{var i={};n=function(a,o){if(arguments.length===1)return i[s.url+a];if(arguments.length===2)return i[s.url+a]=o}}return e.options(s),e}function P(s){return Object.keys(s).filter(function(e){return s[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(s[e])}).join("&")}function y(s){for(var e=0;e<s.length&&(s[e]==="?"||s[e]==="#");)e++;return s=s.slice(e),s.split("&").reduce(function(t,r){var n=r.split("=");return n.length===2&&(t[n[0]]=decodeURIComponent(n[1])),t},{})}function A(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function I(s){var e;if(A()){var t=window.crypto.getRandomValues(new Uint8Array(32));e=D(t.buffer);var r=Uint8Array.from(Array.from(e).map(function(a){return a.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",r).then(function(a){var o=D(a);s({code_challenge:o,code_verifier:e,code_challenge_method:"S256"})})}else{var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var i=0;i<64;i++)e+=n[Math.floor(Math.random()*n.length)];s({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function M(){var s;if(A()){var e=window.crypto.getRandomValues(new Uint8Array(32));s=D(e.buffer)}else{var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";s="";for(var r=0;r<64;r++)s+=t[Math.floor(Math.random()*t.length)]}return s}function D(s){return btoa(String.fromCharCode.apply(null,new Uint8Array(s))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class N{constructor(e,t){d(this,"preferences",T.GetParsed("all-osm-preferences",{}));d(this,"preferenceSources",new Map);d(this,"auth");d(this,"userDetails");d(this,"longPreferences",{});this.auth=e,this.userDetails=t.userDetails;const r=this;t.OnLoggedIn(()=>r.UpdatePreferences())}GetLongPreference(e,t="mapcomplete-"){if(this.longPreferences[t+e]!==void 0)return this.longPreferences[t+e];const r=new m(void 0,"long-osm-preference:"+t+e);this.longPreferences[t+e]=r;const n=t+e+"-combined",i={prefix:""},a=this.GetPreference(n+"-length","",i);if((n+"-length").length>255)throw"This preference key is too long, it has "+e.length+" characters, but at most "+(255-7-9-t.length)+" characters are allowed";const o=this;r.addCallback(u=>{if(u===void 0||u==="")return;if(u===null){console.error("Deleting "+n);let f=parseInt(a.data);for(let h=0;h<f;h++)o.GetPreference(n+"-"+h,"",i).setData("");o.GetPreference(n+"-length","",i).setData("");return}let c=0;for(;u!=="";){if(u===void 0||u==="undefined")throw"Got 'undefined' or a literal string containing 'undefined' for a long preference with name "+e;if(c>100)throw"This long preference is getting very long... ";o.GetPreference(n+"-"+c,"",i).setData(u.substr(0,255)),u=u.substr(255),c++}a.setData(""+c)});function l(u){if(Object.keys(o.preferences.data).length===0)return;const c=Number(u);if(c>100)throw"Length to long";let f="";for(let h=0;h<c;h++){const g=n+"-"+h;o.preferences.data[g]===void 0&&console.warn("Detected a broken combined preference:",g,"is undefined",o.preferences),f+=o.preferences.data[g]??""}r.setData(f)}return a.addCallback(u=>{l(Number(u))}),this.preferences.addCallbackAndRun(u=>{l(Number(a.data))}),r}GetPreference(e,t=void 0,r){const n=(r==null?void 0:r.prefix)??"mapcomplete-";if(e.startsWith(n)&&n!==""&&console.trace("A preference was requested which has a duplicate prefix in its key. This is probably a bug"),e=n+e,e=e.replace(/[:\\\/"' {}.%]/g,""),e.length>=255)throw"Preferences: key length to big";const i=this.preferenceSources.get(e);if(i!==void 0)return i;this.userDetails.data.loggedIn&&this.preferences.data[e]===void 0&&this.UpdatePreferences();const a=new m(this.preferences.data[e]??t,"osm-preference:"+e);return a.addCallback(o=>{this.UploadPreference(e,o)}),this.preferences.addCallbackD(o=>{const l=o[e];l!==void 0&&a.setData(l)}),this.preferenceSources.set(e,a),a}ClearPreferences(){let e=!1;const t=this;this.preferences.addCallback(r=>{if(console.log("Cleaning preferences..."),Object.keys(r).length==0||e)return;e=!0;const n=["mapcomplete-"];for(const i in r)n.some(o=>i.startsWith(o))&&(console.log("Clearing ",i),t.GetPreference(i,"",{prefix:""}).setData(""));e=!1})}UpdatePreferences(){const e=this;this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},function(t,r){if(t){console.log("Could not load preferences",t);return}const n=r.getElementsByTagName("preference");for(let i=0;i<n.length;i++){const a=n[i],o=a.getAttribute("k"),l=a.getAttribute("v");e.preferences.data[o]=l}e.preferenceSources.forEach((i,a)=>{const o=e.preferences.data[a];o===void 0&&i.data!==void 0?e.UploadPreference(a,i.data):i.setData(o)}),e.preferences.ping()})}UploadPreference(e,t){if(!this.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(this.preferences.data[e]===t)return;const r=this;if(console.debug("Updating preference",e," to ",p.EllipsesAfter(t,15)),t===void 0||t===""){this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}}},function(n){if(n){console.warn("Could not remove preference",n);return}delete r.preferences.data[e],r.preferences.ping(),console.debug("Preference ",e,"removed!")});return}this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}},content:t},function(n){if(n){console.warn(`Could not set preference "${e}"'`,n);return}r.preferences.data[e]=t,r.preferences.ping(),console.debug(`Preference ${e} written!`)})}}class R{constructor(e){d(this,"loggedIn",!1);d(this,"name","Not logged in");d(this,"uid");d(this,"csCount",0);d(this,"img");d(this,"unreadMessages",0);d(this,"totalMessages",0);d(this,"home");d(this,"backend");d(this,"account_created");d(this,"tracesCount",0);d(this,"description");this.backend=e}}class j{constructor(e){d(this,"auth");d(this,"userDetails");d(this,"isLoggedIn");d(this,"gpxServiceIsOnline",new m("unknown"));d(this,"apiIsOnline",new m("unknown"));d(this,"loadingStatus",new m("not-attempted"));d(this,"preferencesHandler");d(this,"_oauth_config");d(this,"_dryRun");d(this,"fakeUser");d(this,"_onLoggedIn",[]);d(this,"_iframeMode");d(this,"_singlePage");d(this,"isChecking",!1);var r;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=k.osmAuthConfig,console.debug("Using backend",this._oauth_config.url),this._iframeMode=p.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new m(new R(this._oauth_config.url),"userDetails"),e.fakeUser){const n=this.userDetails.data;n.csCount=5678,n.loggedIn=!0,n.unreadMessages=0,n.name="Fake user",n.totalMessages=42}const t=this;if(this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(n=>n.loggedIn&&(t.apiIsOnline.data==="unknown"||t.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(n=>{t.userDetails.data.loggedIn==!1&&n==!0&&t.AttemptLogin()}),this._dryRun=e.dryRun??new m(!1),this.updateAuthObject(),this.preferencesHandler=new N(this.auth,this),((r=e.oauth_token)==null?void 0:r.data)!==void 0){console.log(e.oauth_token.data);const n=this;this.auth.bootstrapToken(e.oauth_token.data,i=>{console.log("Called back: ",i),n.AttemptLogin()},this.auth),e.oauth_token.setData(void 0)}this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,t=void 0,r){return this.preferencesHandler.GetPreference(e,t,r)}GetLongPreference(e,t="mapcomplete-"){return this.preferencesHandler.GetLongPreference(e,t)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted")}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}const e=this;console.log("Trying to log in..."),this.updateAuthObject(),T.Get("location_before_login").setData(p.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},function(t,r){var c;if(t!=null){console.log(t),e.loadingStatus.setData("error"),t.status==401&&(console.log("Clearing tokens..."),e.auth.logout(),e.LogOut());return}if(r==null){e.loadingStatus.setData("error");return}e.CheckForMessagesContinuously();let n=r.getElementsByTagName("user")[0],i=e.userDetails.data;i.loggedIn=!0,console.log("Login completed, userinfo is ",n),i.name=n.getAttribute("display_name"),i.account_created=n.getAttribute("account_created"),i.uid=Number(n.getAttribute("id")),i.csCount=Number.parseInt(n.getElementsByTagName("changesets")[0].getAttribute("count")??0),i.tracesCount=Number.parseInt(n.getElementsByTagName("traces")[0].getAttribute("count")??0),i.img=void 0;const a=n.getElementsByTagName("img");a!==void 0&&a[0]!==void 0&&(i.img=a[0].getAttribute("href"));const o=n.getElementsByTagName("description");o!==void 0&&o[0]!==void 0&&(i.description=(c=o[0])==null?void 0:c.innerHTML);const l=n.getElementsByTagName("home");if(l!==void 0&&l[0]!==void 0){const f=parseFloat(l[0].getAttribute("lat")),h=parseFloat(l[0].getAttribute("lon"));i.home={lat:f,lon:h}}e.loadingStatus.setData("logged-in");const u=n.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];i.unreadMessages=parseInt(u.getAttribute("unread")),i.totalMessages=parseInt(u.getAttribute("count")),e.userDetails.ping();for(const f of e._onLoggedIn)f(e.userDetails.data);e._onLoggedIn=[]})}async interact(e,t,r,n){return new Promise((i,a)=>{this.auth.xhr({method:t,options:{header:r},content:n,path:`/api/0.6/${e}`},function(o,l){o!==null?a(o):i(l)})})}async post(e,t,r){return await this.interact(e,"POST",r,t)}async put(e,t,r){return await this.interact(e,"PUT",r,t)}async get(e,t){return await this.interact(e,"GET",t)}closeNote(e,t){let r="";return(t??"")!==""&&(r="?text="+encodeURIComponent(t)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",t),new Promise(n=>{n()})):this.post(`notes/${e}/close${r}`)}reopenNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",t),new Promise(n=>{n()});let r="";return(t??"")!==""&&(r="?text="+encodeURIComponent(t)),this.post(`notes/${e}/reopen${r}`)}async openNote(e,t,r){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",r),new Promise(l=>{window.setTimeout(()=>l({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const n=`lat=${e}&lon=${t}&text=${encodeURIComponent(r)}`,i=await this.post("notes.json",n,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}),o=JSON.parse(i).properties;return console.log("OPENED NOTE",o),o}async uploadGpxTrack(e,t){var u;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise((c,f)=>{window.setTimeout(()=>c({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const r={file:e,description:t.description??"",tags:((u=t.labels)==null?void 0:u.join(","))??"",visibility:t.visibility},n={file:'; filename="'+(t.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},i="987654";let a="";for(const c in r)a+="--"+i+`\r
`,a+='Content-Disposition: form-data; name="'+c+'"',n[c]!==void 0&&(a+=n[c]),a+=`\r
\r
`,a+=r[c]+`\r
`;a+="--"+i+`--\r
`;const o=await this.post("gpx/create",a,{"Content-Type":"multipart/form-data; boundary="+i,"Content-Length":a.length}),l=JSON.parse(o);return console.log("Uploaded GPX track",l),{id:l}}addCommentToNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",t,"to  note ",e),new Promise(r=>{r()});if((t??"")==="")throw"Invalid text!";return new Promise((r,n)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(t)}`},function(i,a){i!==null?n(i):r()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const t=T.Get("location_before_login");e(t.data)})}updateAuthObject(){let e=!1;try{(p.runningFromConsole||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches)&&(e=!0)}catch(r){console.warn("Detecting standalone mode failed",r,". Assuming in browser and not worrying furhter")}const t=this._iframeMode||e||!this._singlePage;this.auth=new x({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes",redirect_uri:p.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!t,auto:!0})}CheckForMessagesContinuously(){const e=this;this.isChecking||(this.isChecking=!0,L.Chronic(5*60*1e3).addCallback(t=>{e.isLoggedIn.data&&(console.log("Checking for messages"),e.AttemptLogin())}))}UpdateCapabilities(){const e=this;this.FetchCapabilities().then(({api:t,gpx:r})=>{e.apiIsOnline.setData(t),e.gpxServiceIsOnline.setData(r)})}async FetchCapabilities(){if(p.runningFromConsole)return{api:"online",gpx:"online"};const e=await p.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const t=e.content,n=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("status")[0],i=n.getAttribute("api"),a=n.getAttribute("gpx");return{api:i,gpx:a}}}export{j as O};
