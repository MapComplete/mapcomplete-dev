var G=Object.defineProperty;var N=(m,t,s)=>t in m?G(m,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):m[t]=s;var U=(m,t,s)=>(N(m,typeof t!="symbol"?t+"":t,s),s);import{U as A}from"./Utils-45e0ac39.js";import{T as H,a as J,D as W}from"./ThemeViewGUI-a63971ca.js";import{L as Z,S as P}from"./Checkbox-95d1bef9.js";import{Q as B,H as Q,F as z,C as q}from"./Tr-f3889a5f.js";import{V as K,a4 as D}from"./preload-helper-c6e1eadb.js";import{L as E}from"./LocalStorageSource-152a04ab.js";import{g as X}from"./_commonjsHelpers-de833af9.js";import{ac as Y,ad as $,ae as j,ab as I,l as V,a8 as ee,al as te}from"./SubtleLink-e2b00750.js";import{q as ne,a as oe,c as ie,d as re,D as ae}from"./questions-ac32b3df.js";import{k as _}from"./index-a4314705.js";import{C as se}from"./Constants-66b06235.js";import"./UIEventSource-b2e0ae35.js";import"./OsmConnection-403e0151.js";import"./FeatureSwitchState-87405268.js";import"./placeholder-fc55ecdb.js";import"./index-44f7831e.js";import"./Loading-4888c235.js";import"./tw-merge-2cd9e3ed.js";import"./MvtSource-c54d0bd3.js";import"./Add-fc09a14b.js";import"./LanguagePicker-99e74106.js";import"./Dropdown-0d9db6f0.js";import"./Community-091541a2.js";import"./Filterview-a8d22b17.js";import"./PrivacyPolicy-9707167a.js";import"./BackButton-b763c3b3.js";import"./Login-ebcf4fd9.js";let k=(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en").substr(0,2);function F(m){var s;let t=0;for(const e of Array.from(m.children))((s=e.attributes.getNamedItem("lang"))==null?void 0:s.value)===k&&t++;t===0&&(k="en");for(const e of Array.from(m.children)){const g=e.attributes.getNamedItem("lang");g!==void 0&&g.value!==k&&e.parentElement.removeChild(e)}}F(document.getElementById("descriptions-while-loading"));F(document.getElementById("default-title"));var M={exports:{}};M.exports;(function(m){var t=function(){var s=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",R={};function p(o,r){if(!R[o]){R[o]={};for(var d=0;d<o.length;d++)R[o][o.charAt(d)]=d}return R[o][r]}var n={compressToBase64:function(o){if(o==null)return"";var r=n._compress(o,6,function(d){return e.charAt(d)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:n._decompress(o.length,32,function(r){return p(e,o.charAt(r))})},compressToUTF16:function(o){return o==null?"":n._compress(o,15,function(r){return s(r+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:n._decompress(o.length,16384,function(r){return o.charCodeAt(r)-32})},compressToUint8Array:function(o){for(var r=n.compress(o),d=new Uint8Array(r.length*2),a=0,l=r.length;a<l;a++){var y=r.charCodeAt(a);d[a*2]=y>>>8,d[a*2+1]=y%256}return d},decompressFromUint8Array:function(o){if(o==null)return n.decompress(o);for(var r=new Array(o.length/2),d=0,a=r.length;d<a;d++)r[d]=o[d*2]*256+o[d*2+1];var l=[];return r.forEach(function(y){l.push(s(y))}),n.decompress(l.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":n._compress(o,6,function(r){return g.charAt(r)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),n._decompress(o.length,32,function(r){return p(g,o.charAt(r))}))},compress:function(o){return n._compress(o,16,function(r){return s(r)})},_compress:function(o,r,d){if(o==null)return"";var a,l,y={},b={},L="",x="",w="",T=2,v=3,u=2,h=[],i=0,f=0,c;for(c=0;c<o.length;c+=1)if(L=o.charAt(c),Object.prototype.hasOwnProperty.call(y,L)||(y[L]=v++,b[L]=!0),x=w+L,Object.prototype.hasOwnProperty.call(y,x))w=x;else{if(Object.prototype.hasOwnProperty.call(b,w)){if(w.charCodeAt(0)<256){for(a=0;a<u;a++)i=i<<1,f==r-1?(f=0,h.push(d(i)),i=0):f++;for(l=w.charCodeAt(0),a=0;a<8;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1}else{for(l=1,a=0;a<u;a++)i=i<<1|l,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=0;for(l=w.charCodeAt(0),a=0;a<16;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1}T--,T==0&&(T=Math.pow(2,u),u++),delete b[w]}else for(l=y[w],a=0;a<u;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1;T--,T==0&&(T=Math.pow(2,u),u++),y[x]=v++,w=String(L)}if(w!==""){if(Object.prototype.hasOwnProperty.call(b,w)){if(w.charCodeAt(0)<256){for(a=0;a<u;a++)i=i<<1,f==r-1?(f=0,h.push(d(i)),i=0):f++;for(l=w.charCodeAt(0),a=0;a<8;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1}else{for(l=1,a=0;a<u;a++)i=i<<1|l,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=0;for(l=w.charCodeAt(0),a=0;a<16;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1}T--,T==0&&(T=Math.pow(2,u),u++),delete b[w]}else for(l=y[w],a=0;a<u;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1;T--,T==0&&(T=Math.pow(2,u),u++)}for(l=2,a=0;a<u;a++)i=i<<1|l&1,f==r-1?(f=0,h.push(d(i)),i=0):f++,l=l>>1;for(;;)if(i=i<<1,f==r-1){h.push(d(i));break}else f++;return h.join("")},decompress:function(o){return o==null?"":o==""?null:n._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,r,d){var a=[],l=4,y=4,b=3,L="",x=[],w,T,v,u,h,i,f,c={val:d(0),position:r,index:1};for(w=0;w<3;w+=1)a[w]=w;for(v=0,h=Math.pow(2,2),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;switch(v){case 0:for(v=0,h=Math.pow(2,8),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;f=s(v);break;case 1:for(v=0,h=Math.pow(2,16),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;f=s(v);break;case 2:return""}for(a[3]=f,T=f,x.push(f);;){if(c.index>o)return"";for(v=0,h=Math.pow(2,b),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;switch(f=v){case 0:for(v=0,h=Math.pow(2,8),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;a[y++]=s(v),f=y-1,l--;break;case 1:for(v=0,h=Math.pow(2,16),i=1;i!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=d(c.index++)),v|=(u>0?1:0)*i,i<<=1;a[y++]=s(v),f=y-1,l--;break;case 2:return x.join("")}if(l==0&&(l=Math.pow(2,b),b++),a[f])L=a[f];else if(f===y)L=T+T.charAt(0);else return null;x.push(L),a[y++]=T+L.charAt(0),l--,T=L,l==0&&(l=Math.pow(2,b),b++)}}};return n}();m!=null&&(m.exports=t)})(M);var le=M.exports;const O=X(le);class ce extends I{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(t,s){var R;if(typeof t=="string"||t.builtin!==void 0)return t;s=s.enter(t.id);let e={...t};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags);for(const p of e.presets??[]){const n=p.preciseInput;typeof n=="boolean"?delete p.preciseInput:n!==void 0&&(delete n.preferredBackground,p.snapToLayer=n.snapToLayer,delete n.snapToLayer,n.maxSnapDistance&&(p.maxSnapDistance=n.maxSnapDistance,delete n.maxSnapDistance),Object.keys(n).length==0&&delete p.preciseInput),typeof p.snapToLayer=="string"&&(p.snapToLayer=[p.snapToLayer])}if(e.tagRenderings!==void 0){let p=0;for(const n of e.tagRenderings)n&&(p++,!(typeof n=="string"||n.builtin!==void 0||n.rewrite!==void 0)&&n.id===void 0&&(n["#"]!==void 0?(n.id=n["#"],delete n["#"]):((R=n.freeform)==null?void 0:R.key)!==void 0?n.id=e.id+"-"+n.freeform.key:n.id="tr-"+p))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let p=["point"],n=e.wayHandling??0;if(n!==0&&(p=["point","centroid"]),e.icon??e.label!==void 0){const o={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:p,rotation:e.rotation};e.mapRendering.push(o)}if(n!==1){const o={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(o).length>0&&e.mapRendering.push(o)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const g=e.source;delete g.isOsmCache,delete g.maxCacheAge,delete g.widenFactor;for(const p of e.mapRendering??[]){p.iconOverlays!==void 0&&(p.iconBadges=p.iconOverlays);for(const n of p.iconBadges??[])n.badge!==!0&&s.enters("iconBadges","badge").warn("Non-overlay element"),delete n.badge}if(e.mapRendering){const p=[],n=[];for(const o of e.mapRendering)o.location?p.push(o):n.push(o);e.pointRendering=p,e.lineRendering=n,delete e.mapRendering}for(const p of e.pointRendering??[]){const n=p;if(n.icon)try{let r=n.icon;Object.keys(r).length===1&&r.render!==void 0&&(r=r.render);const d=A.NoEmpty(r.split(";"));n.marker=d.map(a=>{if(a.startsWith("http"))return{icon:a};const[l,y]=a.split(":");return{icon:l,color:y}}),delete n.icon}catch{console.error("Could not handle icon in",t.id),n.marker=[{icon:n.icon}],delete n.icon}let o=n.iconSize;if(o&&(Object.keys(n.iconSize).length===1&&n.iconSize.render!==void 0&&(o=n.iconSize.render),typeof o=="string"&&["bottom","center","top"].some(r=>o.endsWith(r)))){const r=o.split(",").map(d=>d.toLowerCase().trim());n.anchor=r.pop(),n.iconSize=r.join(",")}}if(e.pointRendering)for(const p of e.pointRendering)for(const n in p)p[n]&&typeof p[n].render=="string"&&Object.keys(p[n]).length===1&&(p[n]=p[n].render);if(e.lineRendering)for(const p of e.lineRendering)for(const n in p)p[n]&&typeof p[n].render=="string"&&Object.keys(p[n]).length===1&&(p[n]=p[n].render);return e}}class de extends I{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(t,s){const e={...t};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return s.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=A.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class fe extends Y{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new de,new $("layers",new j(new ce)))}}const S=class S{static getCustomDefinition(){const t=decodeURIComponent(S.loadCustomThemeParam.data);if(t.startsWith("http"))return t;if(t!=="false"){const s=Q.hash.data;try{return JSON.parse(atob(s)),atob(s)}catch{return JSON.parse(A.UnMinify(O.decompressFromBase64(s))),A.UnMinify(O.decompressFromBase64(s))}}}static async GetLayout(){const t=decodeURIComponent(S.loadCustomThemeParam.data);if(t.startsWith("http"))return await S.LoadRemoteTheme(t);if(t!=="false")return S.LoadLayoutFromHash(S.loadCustomThemeParam);let s;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(s=e,e.endsWith(".html")&&(s=e.substr(0,e.length-5)),console.log("Using layout",s)),s=B.GetQueryParameter("layout",s,"The layout to load into MapComplete").data;const g=K.allKnownLayouts.get(s==null?void 0:s.toLowerCase());if(g===void 0)throw"No builtin map theme with name "+s+" exists";return g}static LoadLayoutFromHash(t){var n,o;let s=location.hash.substr(1),e;const g=E.Get("user-layout-"+((n=t.data)==null?void 0:n.replace(" ","_")));((o=g.data)==null?void 0:o.length)<10&&g.setData(void 0);const R=E.Get("last-loaded-user-layout");s.length<10?s=g.data??R.data:(console.log("Saving hash to local storage"),R.setData(s),g.setData(s));try{e=JSON.parse(atob(s))}catch{e=JSON.parse(A.UnMinify(O.decompressFromBase64(s)))}const p=S.prepCustomTheme(e);return t.setData(p.id),p}static getSharedTagRenderings(){const t=new Map;for(const s of ne.tagRenderings)t.set(s.id,s);return t}static prepCustomTheme(t,s,e){if(t.layers===void 0&&t.tagRenderings!==void 0){const o=t.pointRendering.map(d=>{var a,l;return(l=(a=d==null?void 0:d.marker)==null?void 0:a.find(y=>y.icon!==void 0))==null?void 0:l.icon}).find(d=>d!==void 0)??"bug",r=new ee(o).render.txt;t={id:t.id,description:t.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:r,title:t.name,layers:[t]}}const g=new Map;for(const n in D.layers){const o=D.layers[n];g.set(o.id,o)}const R={tagRenderings:S.getSharedTagRenderings(),sharedLayers:g,publicLayers:new Set};t=new fe().convertStrict(t);const p=t;return t=new te(S._knownImages).convertStrict(t),t.enableNoteImports=t.enableNoteImports??!1,t=new oe(R).convertStrict(t),console.log("The layoutconfig is ",t),t.id=e??t.id,new ie().convertStrict(t),new re(new ae(new Set,n=>!0),"",!1).convertStrict(t),new Z(t,!1,{definitionRaw:JSON.stringify(p,null,"  "),definedAtUrl:s})}static async LoadRemoteTheme(t){console.log("Downloading map theme from ",t),new z(`Downloading the theme from the <a href="${t}">link</a>...`).AttachTo("maindiv");let s=await A.downloadJson(t),e=s.id;const g=new URL(t);return g.hostname==="localhost"||g.hostname==="127.0.0.1"||(e=t),console.log("Loaded remote link:",t),S.prepCustomTheme(s,t,e)}};U(S,"_knownImages",new Set(Array.from(V).map(t=>t.path))),U(S,"loadCustomThemeParam",B.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let C=S;function pe(){try{const m=document.createElement("canvas");return!!window.WebGLRenderingContext&&(m.getContext("webgl")||m.getContext("experimental-webgl"))}catch{return!1}}async function me(){try{const m=new URL(se.VectorTileServer).host,t=await A.downloadJson("https://"+m+"/summary/status.json");return new Set(t.layers)}catch(m){return console.error("Could not get MVT available layers due to",m),new Set}}async function ue(){try{if(!pe())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[m,t]=await Promise.all([C.GetLayout(),await me()]);console.log("The available layers on server are",Array.from(t));const s=new H(m,t);new _(J,{state:s}).AttachTo("maindiv")}catch(m){console.error("Error while initializing: ",m,m.stack);const t=C.getCustomDefinition();new q([new z(m).SetClass("block alert"),(t==null?void 0:t.length)>0?new P(new _(W),"Download the raw file").onClick(()=>A.offerContentsAsDownloadableFile(C.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}ue().then(m=>{});
//# sourceMappingURL=theme-27404a7a.js.map
