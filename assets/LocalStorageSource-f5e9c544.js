var D=Object.defineProperty;var F=(c,s,t)=>s in c?D(c,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[s]=t;var r=(c,s,t)=>(F(c,typeof s!="symbol"?s+"":s,t),t);import{U as g}from"./Utils-aa3ce114.js";class P{static Chronic(s,t=void 0){const a=new l(void 0);function i(){a.setData(new Date),(t===void 0||t())&&window.setTimeout(i,s)}return i(),a}static FromPromiseWithErr(s){return l.FromPromiseWithErr(s)}static FromPromise(s){const t=new l(void 0);return s==null||s.then(a=>t.setData(a)),s==null||s.catch(a=>console.warn("Promise failed:",a)),t}static flatten(s,t){return l.flatten(s,t)}static ListStabilized(s){const t=new l(void 0);return s.addCallbackAndRun(a=>{if(a===void 0){t.setData(void 0);return}g.sameList(t.data,a)||t.setData(a)}),t}}class m{constructor(s=void 0){r(this,"tag");if(this.tag=s,s===void 0||s===""){let t=g.runningFromConsole;if(g.runningFromConsole||(t=window.location.hostname==="127.0.0.1"),t){const a=new Error().stack.split(`
`);this.tag=a[1]}}}mapD(s,t){return this.map(a=>{if(a!==void 0)return a===null?null:s(a)},t)}withEqualityStabilized(s){let t;return this.map(a=>a==t||s(t,a)?t:(t=a,a))}bind(s){const t=this.map(s),a=new l(void 0),i=new Set;return t.addCallbackAndRun(e=>{e===null?a.setData(null):e===void 0?a.setData(void 0):i.has(e)?a.setData(e.data):(i.add(e),e.addCallbackAndRun(n=>{t.data===e&&a.setData(n)}))}),a}stabilized(s){if(g.runningFromConsole)return this;const t=new l(this.data),a=this;return this.addCallback(i=>{window.setTimeout(()=>{a.data==i&&t.setData(i)},s)}),t}AsPromise(s){const t=this;return s=s??(a=>a!==void 0),new Promise(a=>{const i=t.data;s(i)?a(i):t.addCallbackD(e=>s(e)?(a(e),!0):!1)})}subscribe(s,t){return this.addCallbackAndRun(a=>{s(a)})}}const u=class extends m{constructor(t){super();r(this,"data");this.data=t}addCallback(t){return u.pass}addCallbackAndRun(t){return t(this.data),u.pass}addCallbackAndRunD(t){return this.data!==void 0&&t(this.data),u.pass}addCallbackD(t){return u.pass}map(t,a=void 0){return(a==null?void 0:a.length)>0?new o(this,t,a,void 0,t(this.data)):new u(t(this.data))}};let _=u;r(_,"pass",()=>{});class v{constructor(){r(this,"pingCount",0);r(this,"_callbacks",[])}addCallback(s){if(s===console.log)throw"Don't add console.log directly as a callback - you'll won't be able to find it afterwards. Wrap it in a lambda instead.";return this._callbacks.push(s),()=>{const t=this._callbacks.indexOf(s);t>=0&&this._callbacks.splice(t,1)}}ping(s){this.pingCount++;let t,a=new Date().getTime()/1e3;for(const e of this._callbacks)try{e(s)===!0&&(t===void 0?t=[e]:t.push(e))}catch(n){console.error("Got an error while running a callback:",n)}if(new Date().getTime()/1e3-a>500&&console.trace("Warning: a ping took more then 500ms; this is probably a performance issue"),t!==void 0)for(const e of t)this._callbacks.splice(this._callbacks.indexOf(e),1);return this._callbacks.length}length(){return this._callbacks.length}}const C=class extends m{constructor(t,a,i,e,n,d){super();r(this,"_upstream");r(this,"_upstreamCallbackHandler");r(this,"_upstreamPingCount",-1);r(this,"_unregisterFromUpstream");r(this,"_f");r(this,"_extraStores");r(this,"_unregisterFromExtraStores");r(this,"_callbacks",new v);r(this,"_callbacksAreRegistered",!1);r(this,"_data");this._upstream=t,this._upstreamCallbackHandler=e,this._f=a,this._data=n,this._upstreamPingCount=e==null?void 0:e.pingCount,this._extraStores=i,this.registerCallbacksToUpstream(),d!==void 0&&d(()=>this.unregisterFromUpstream())}get data(){var t;return this._callbacksAreRegistered?this._data:(((t=this._upstreamCallbackHandler)==null?void 0:t.pingCount)!=this._upstreamPingCount&&(this._data=this._f(this._upstream.data)),this._data)}map(t,a=void 0){var e,n,d;let i;return((a==null?void 0:a.length)>0||((e=this._extraStores)==null?void 0:e.length)>0)&&(i=[]),(a==null?void 0:a.length)>0&&i.push(...a),((n=this._extraStores)==null?void 0:n.length)>0&&((d=this._extraStores)==null||d.forEach(f=>{i.indexOf(f)<0&&i.push(f)})),new C(this,t,i,this._callbacks,t(this.data))}addCallback(t){this._callbacksAreRegistered||this.registerCallbacksToUpstream();const a=this._callbacks.addCallback(t);return()=>{a(),this._callbacks.length()==0&&this.unregisterFromUpstream()}}addCallbackAndRun(t){const a=this.addCallback(t);return t(this.data)===!0?(a(),C.pass):a}addCallbackAndRunD(t){return this.addCallbackAndRun(a=>{if(a!==void 0)return t(a)})}addCallbackD(t){return this.addCallback(a=>{if(a!==void 0)return t(a)})}unregisterFromUpstream(){var t;console.debug("Unregistering callbacks for",this.tag),this._callbacksAreRegistered=!1,this._unregisterFromUpstream(),(t=this._unregisterFromExtraStores)==null||t.forEach(a=>a())}registerCallbacksToUpstream(){var a;const t=this;this._unregisterFromUpstream=this._upstream.addCallback(i=>t.update()),this._unregisterFromExtraStores=(a=this._extraStores)==null?void 0:a.map(i=>i==null?void 0:i.addCallback(e=>t.update())),this._callbacksAreRegistered=!0}update(){var a;const t=this._f(this._upstream.data);this._upstreamPingCount=(a=this._upstreamCallbackHandler)==null?void 0:a.pingCount,this._data!=t&&(this._data=t,this._callbacks.ping(this._data))}};let o=C;r(o,"pass");const h=class extends m{constructor(t,a=""){super(a);r(this,"data");r(this,"_callbacks",new v);this.data=t}static flatten(t,a){var e;const i=new h((e=t.data)==null?void 0:e.data);t.addCallback(n=>{i.setData(n==null?void 0:n.data),n.addCallback(d=>{if(t.data!==n)return!0;i.setData(d)})});for(const n of a??[])n==null||n.addCallback(()=>{var d;i.setData((d=t.data)==null?void 0:d.data)});return i}static FromPromise(t,a=void 0){const i=new h(void 0);return t==null||t.then(e=>i.setData(e)),t==null||t.catch(e=>{a!==void 0?a(e):console.warn("Promise failed:",e)}),i}static FromPromiseWithErr(t){const a=new h(void 0);return t==null||t.then(i=>a.setData({success:i})),t==null||t.catch(i=>a.setData({error:i})),a}static asFloat(t){return t.sync(a=>{let i=parseFloat(a);return isNaN(i)?void 0:i},[],a=>{if(!(a===void 0||isNaN(a)))return(""+a).substr(0,8)})}static asBoolean(t){return t.sync(a=>a==="true",[],a=>""+a)}static feedFrom(t){const a=new h(t.data);return t.addCallback(i=>a.setData(i)),a}addCallback(t){return this._callbacks.addCallback(t)}addCallbackAndRun(t){return t(this.data)!==!0?this.addCallback(t):h.pass}addCallbackAndRunD(t){return this.addCallbackAndRun(a=>{if(a!=null)return t(a)})}addCallbackD(t){return this.addCallback(a=>{if(a!=null)return t(a)})}setData(t){if(this.data!=t)return this.data=t,this._callbacks.ping(t),this}ping(){this._callbacks.ping(this.data)}map(t,a=[],i){return new o(this,t,a,this._callbacks,t(this.data),i)}mapD(t,a=[]){return new o(this,i=>{if(i!==void 0)return t(i)},a,this._callbacks,this.data===void 0?void 0:t(this.data))}sync(t,a,i,e=!1){const n=this,f=new Error().stack.split(`
`)[1],k=new h(t(this.data),"map("+this.tag+")@"+f),p=function(){return k.setData(t(n.data)),e&&k._callbacks.length()===0};this.addCallback(p);for(const b of a)b==null||b.addCallback(p);return i!==void 0&&k.addCallback(b=>{n.setData(i(b,n.data))}),k}syncWith(t,a=!1){this.addCallback(e=>t.setData(e));const i=this;return t.addCallback(e=>i.setData(e)),a?t.data!==void 0&&this.setData(t.data):this.data===void 0?this.setData(t.data):t.setData(this.data),this}set(t){this.setData(t)}update(t){this.setData(t(this.data))}};let l=h;r(l,"pass");class w{static GetParsed(s,t){return w.Get(s).sync(a=>{if(a===void 0)return t;try{return JSON.parse(a)}catch{return t}},[],a=>JSON.stringify(a))}static Get(s,t=void 0){try{const a=localStorage.getItem(s),i=new l(a??t,"localstorage:"+s);return i.addCallback(e=>{try{localStorage.setItem(s,e)}catch{localStorage.clear()}}),i}catch{return new l(t)}}}export{_ as I,w as L,P as S,l as U,m as a};
