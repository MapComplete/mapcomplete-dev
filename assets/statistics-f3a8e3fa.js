var B=Object.defineProperty;var O=(u,e,o)=>e in u?B(u,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):u[e]=o;var d=(u,e,o)=>(O(u,typeof e!="symbol"?e+"":e,o),o);import{U as c}from"./Utils-e10b1bf1.js";import{U as L}from"./UIEventSource-dc7d44f6.js";import{V as j,C as g,F as W}from"./Tr-83ea53d7.js";import{h as N,d as h,o as P}from"./Dropdown-23a0de57.js";import{L as V,F as A,S as U,T as J}from"./Checkbox-ea78dcf4.js";import{m as K}from"./mapcomplete-changes-a7910447.js";import{k as z}from"./index-08b4b005.js";import{F as I}from"./Filterview-8d0adf34.js";import"./LocalStorageSource-7e0723c4.js";import"./Svg-df9a5a92.js";import"./Constants-f895f623.js";import"./tw-merge-2cd9e3ed.js";import"./ToSvelte-460944ec.js";class Y extends g{constructor(e,o){o=o.filter(i=>!i.endsWith("file-overview.json"));const n=new V(K,!0).layers[0],a=new A(n),w=new g([new h("Filters"),new z(I,{filteredLayer:a})]),v=new L([]);for(const i of o)i.endsWith("file-overview.json")||c.downloadJson(e+i).then(r=>{var b;r!==void 0&&(r.features===void 0&&(r.features=r),(b=r==null?void 0:r.features)==null||b.forEach(l=>{l.properties={...l.properties,...l.properties.metadata},delete l.properties.metadata}),v.data.push(r),v.ping())});const E=new N(new j(v.map(i=>"Downloaded "+i.length+" items out of "+o.length)));super([w,new j(v.map(i=>{var D;if(i.length!==o.length)return E;const r=_.fromDirtyData([].concat(...i.map(t=>t.features))).filter(t=>a.isShown(t.properties));if(console.log("Overview is",r),r._meta.length===0)return"No data matched the filter";const l=c.NoNull(r._meta.map(t=>t.properties.date)).map(t=>new Date(t).getTime()),M=Math.min(...l),y=(Math.max(...l)-M)/(1e3*60*60*24);console.log("Diff in days is ",y,"got",r._meta.length);const R=n.tagRenderings.filter(t=>{var s,f;return((s=t.mappings)==null?void 0:s.length)>0||((f=t.freeform)==null?void 0:f.key)!==void 0}),T=new Set;for(const t of r._meta)for(const s in t.properties)T.add(s);console.log("All keys:",T);const F=["create","modify","delete","answer","move","deletion","add-image","plantnet-ai-detection","import","conflation","link-image","soft-delete"],S=c.Dedup(r._meta.map(t=>t.properties.theme)),k=new Set;S.length>1&&(k.add("grb"),k.add("etymology"));const q=F.map(t=>[t,r.sum(t,k)]).filter(t=>t[1]!=0).map(t=>t.join(": ")),C=[new h(S.length===1?"General statistics for "+S[0]:"General statistics (excluding etymology- and GRB-theme changes)"),new g([r._meta.length+" changesets match the filters",new P(q)]).SetClass("flex flex-col border rounded-xl"),new h("Breakdown")];for(const t of R){if(t.question===void 0)continue;console.log(t);let s;((D=t.freeform)==null?void 0:D.key)!==void 0&&(s=new Set(r._meta.map(f=>f.properties[t.freeform.key])).size);try{C.push(new g([new h(t.question??t.id).SetClass("p-2"),s>1?s+" unique value":void 0,new h("By number of changesets",4).SetClass("p-2"),new U(t,r._meta,{period:y<=367?"day":"month",groupToOtherCutoff:s>50?25:s>10?3:0}).SetStyle("width: 75%; height: 600px"),new J(r._meta,t,{groupToOtherCutoff:s>50?25:s>10?3:0,chartType:"doughnut",chartclasses:"w-8 h-8",sort:!0}).SetStyle("width: 25rem"),new h("By number of modifications",4).SetClass("p-2"),new U(t,c.Clone(r._meta),{period:y<=367?"day":"month",groupToOtherCutoff:s>50?10:0,sumFields:F}).SetStyle("width: 100%; height: 600px")]).SetClass("block border-2 border-subtle p-2 m-2 rounded-xl"))}catch(f){console.log("Could not generate a chart",f),C.push(new W("No relevant information for "+t.question.txt))}}return new g(C)},[a.currentFilter])).SetClass("block w-full h-full")]),this.SetClass("block w-full h-full")}}const p=class p extends j{constructor(){const e=L.FromPromise(c.downloadJson(p.homeUrl+p.stats_files));super(e.map(o=>o===void 0?new N("Loading overview..."):new Y(p.homeUrl,o))),this.SetClass("block w-full h-full")}};d(p,"homeUrl","https://raw.githubusercontent.com/pietervdvn/MapComplete-data/main/changeset-metadata/"),d(p,"stats_files","file-overview.json");let x=p;const m=class m{constructor(e){d(this,"_meta");this._meta=c.NoNull(e)}static fromDirtyData(e){return new m(e==null?void 0:e.map(o=>m.cleanChangesetData(o)))}static cleanChangesetData(e){var n;if(e===void 0||(n=e.properties.editor)!=null&&n.startsWith("iD"))return;e.properties.theme===void 0&&(e.properties.theme=e.properties.comment.substr(e.properties.comment.lastIndexOf("#")+1)),e.properties.theme=e.properties.theme.toLowerCase();const o=m.theme_remappings[e.properties.theme];e.properties.theme=o??e.properties.theme,e.properties.theme.startsWith("https://raw.githubusercontent.com/")&&(e.properties.theme="gh://"+e.properties.theme.substr(34)),e.properties.modify+e.properties.delete+e.properties.create==0&&(e.properties.theme="EMPTY CS");try{e.properties.host=new URL(e.properties.host).host}catch{}return e}filter(e){return new m(this._meta.filter(e))}sum(e,o){let n=0;for(const a of this._meta){if(o.has(a.properties.theme))continue;const w=Number(a.properties[e]);isNaN(w)||(n+=w)}return n}};d(m,"theme_remappings",{metamap:"maps",groen:"buurtnatuur","updaten van metadata met mapcomplete":"buurtnatuur","Toevoegen of dit natuurreservaat toegangkelijk is":"buurtnatuur","wiki:mapcomplete/fritures":"fritures","wiki:MapComplete/Fritures":"fritures",lits:"lit",pomp:"cyclofix","wiki:user:joost_schouppe/campersite":"campersite","wiki-user-joost_schouppe-geveltuintjes":"geveltuintjes","wiki-user-joost_schouppe-campersite":"campersite","wiki-User-joost_schouppe-campersite":"campersite","wiki-User-joost_schouppe-geveltuintjes":"geveltuintjes","wiki:User:joost_schouppe/campersite":"campersite",arbres:"arbres_llefia",aed_brugge:"aed","https://llefia.org/arbres/mapcomplete.json":"arbres_llefia","https://llefia.org/arbres/mapcomplete1.json":"arbres_llefia","toevoegen of dit natuurreservaat toegangkelijk is":"buurtnatuur","testing mapcomplete 0.0.0":"buurtnatuur",entrances:"indoor","https://raw.githubusercontent.com/osmbe/play/master/mapcomplete/geveltuinen/geveltuinen.json":"geveltuintjes"});let _=m;new x().AttachTo("main");
