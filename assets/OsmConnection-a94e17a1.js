var A=Object.defineProperty;var k=(o,e,t)=>e in o?A(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var d=(o,e,t)=>(k(o,typeof e!="symbol"?e+"":e,t),t);import{U as v,S as T}from"./UIEventSource-14eb915f.js";import{U as _}from"./Utils-e0968e8e.js";import{L as I}from"./LocalStorageSource-6c2fe859.js";import{C as O}from"./Constants-76809d08.js";function E(o){var e={},t=null;try{t=window.localStorage}catch{var n=new Map;t={isMocked:!0,hasItem:r=>n.has(r),getItem:r=>n.get(r),setItem:(r,s)=>n.set(r,s),removeItem:r=>n.delete(r),clear:()=>n.clear()}}function a(i,r){var s=o.url+i;if(arguments.length===1){var f=t.getItem(s)||"";return f.replace(/"/g,"")}else if(arguments.length===2)return r?t.setItem(s,r):t.removeItem(s)}e.authenticated=function(){return!!a("oauth2_access_token")},e.logout=function(){return a("oauth2_access_token",""),a("oauth_token",""),a("oauth_token_secret",""),a("oauth_request_token_secret",""),e},e.authenticate=function(i){if(e.authenticated()){i(null,e);return}e.logout(),u(function(r,s){r?i(r):U(function(f){c(f,s,i)})})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((i,r)=>{var s=(f,h)=>{f?r(f):i(h)};u((f,h)=>{f?s(f):U(g=>c(g,h,s))})}))};function u(i){if(o.singlepage){i(null,void 0);return}var r=550,s=610,f=[["width",r],["height",s],["left",window.screen.width/2-r/2],["top",window.screen.height/2-s/2]].map(function(p){return p.join("=")}).join(","),h=window.open("about:blank","oauth_window",f);if(h)i(null,h);else{var g=new Error("Popup was blocked");g.status="popup-blocked",i(g)}}function c(i,r,s){var f=x(),h=o.url+"/oauth2/authorize?"+P({client_id:o.client_id,redirect_uri:o.redirect_uri,response_type:"code",scope:o.scope,state:f,code_challenge:i.code_challenge,code_challenge_method:i.code_challenge_method,locale:o.locale||""});if(o.singlepage){if(t.isMocked){var g=new Error("localStorage unavailable, but required in singlepage mode");g.status="pkce-localstorage-unavailable",s(g);return}var p=y(window.location.search.slice(1));p.code?e.bootstrapToken(p.code,s):(a("oauth2_state",f),a("oauth2_pkce_code_verifier",i.code_verifier),window.location=h)}else e.popupWindow=r,r.location=h;window.authComplete=function(m){var b=y(m.split("?")[1]);if(b.state!==f){var C=new Error("Invalid state");C.status="invalid-state",s(C);return}l(b.code,i.code_verifier,w),delete window.authComplete};function w(m,b){if(o.done(),m){s(m);return}var C=JSON.parse(b.response);a("oauth2_access_token",C.access_token),s(null,e)}}function l(i,r,s){var f=o.url+"/oauth2/token?"+P({client_id:o.client_id,redirect_uri:o.redirect_uri,grant_type:"authorization_code",code:i,code_verifier:r});e.rawxhr("POST",f,null,null,null,s),o.loading()}return e.bringPopupWindowToFront=function(){var i=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),i=!0)}catch{}return i},e.bootstrapToken=function(i,r){var s=a("oauth2_state");a("oauth2_state","");var f=y(window.location.search.slice(1));if(f.state!==s){var h=new Error("Invalid state");h.status="invalid-state",r(h);return}var g=a("oauth2_pkce_code_verifier");a("oauth2_pkce_code_verifier",""),l(i,g,p);function p(w,m){if(o.done(),w){r(w);return}var b=JSON.parse(m.response);a("oauth2_access_token",b.access_token),r(null,e)}},e.fetch=function(i,r){if(e.authenticated())return s();return o.auto?e.authenticateAsync().then(s):Promise.reject(new Error("not authenticated"));function s(){return r=r||{},r.headers||(r.headers={"Content-Type":"application/x-www-form-urlencoded"}),r.headers.Authorization="Bearer "+a("oauth2_access_token"),fetch(i,r)}},e.xhr=function(i,r){if(e.authenticated())return s();if(o.auto){e.authenticate(s);return}else{r("not authenticated",null);return}function s(){var h=i.prefix!==!1?o.apiUrl+i.path:i.path;return e.rawxhr(i.method,h,a("oauth2_access_token"),i.content,i.headers,f)}function f(h,g){h?r(h):g.responseXML?r(h,g.responseXML):r(h,g.response)}},e.rawxhr=function(i,r,s,f,h,g){h=h||{"Content-Type":"application/x-www-form-urlencoded"},s&&(h.Authorization="Bearer "+s);var p=new XMLHttpRequest;p.onreadystatechange=function(){p.readyState===4&&p.status!==0&&(/^20\d$/.test(p.status)?g(null,p):g(p,null))},p.onerror=function(m){g(m,null)},p.open(i,r,!0);for(var w in h)p.setRequestHeader(w,h[w]);return p.send(f),p},e.preauth=function(i){return i&&i.access_token&&a("oauth2_access_token",i.access_token),e},e.options=function(i){return arguments.length?(o=i,o.apiUrl=o.apiUrl||"https://api.openstreetmap.org",o.url=o.url||"https://www.openstreetmap.org",o.auto=o.auto||!1,o.singlepage=o.singlepage||!1,o.loading=o.loading||function(){},o.done=o.done||function(){},e.preauth(o)):o},e.options(o),e}function P(o){return Object.keys(o).filter(function(e){return o[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(o[e])}).join("&")}function y(o){for(var e=0;e<o.length&&(o[e]==="?"||o[e]==="#");)e++;return o=o.slice(e),o.split("&").reduce(function(t,n){var a=n.split("=");return a.length===2&&(t[a[0]]=decodeURIComponent(a[1])),t},{})}function S(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function U(o){var e;if(S()){var t=window.crypto.getRandomValues(new Uint8Array(32));e=D(t.buffer);var n=Uint8Array.from(Array.from(e).map(function(c){return c.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",n).then(function(c){var l=D(c);o({code_challenge:l,code_verifier:e,code_challenge_method:"S256"})})}else{var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var u=0;u<64;u++)e+=a[Math.floor(Math.random()*a.length)];o({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function x(){var o;if(S()){var e=window.crypto.getRandomValues(new Uint8Array(32));o=D(e.buffer)}else{var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";o="";for(var n=0;n<64;n++)o+=t[Math.floor(Math.random()*t.length)]}return o}function D(o){return btoa(String.fromCharCode.apply(null,new Uint8Array(o))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class L{constructor(e,t,n=!1){d(this,"preferences",I.GetParsed("all-osm-preferences",{}));d(this,"preferenceSources",new Map);d(this,"auth");d(this,"userDetails");d(this,"longPreferences",{});d(this,"_fakeUser");this.auth=e,this._fakeUser=n,this.userDetails=t.userDetails,t.OnLoggedIn(()=>(this.UpdatePreferences(!0),!0))}GetLongPreference(e,t="mapcomplete-"){if(this.longPreferences[t+e]!==void 0)return this.longPreferences[t+e];const n=new v(void 0,"long-osm-preference:"+t+e);this.longPreferences[t+e]=n;const a=t+e+"-combined",u={prefix:""},c=this.GetPreference(a+"-length","",u);if((a+"-length").length>255)throw"This preference key is too long, it has "+e.length+" characters, but at most "+(255-7-9-t.length)+" characters are allowed";const l=this;n.addCallback(r=>{if(r===void 0||r==="")return;if(r===null){console.error("Deleting "+a);let f=parseInt(c.data);for(let h=0;h<f;h++)l.GetPreference(a+"-"+h,"",u).setData("");l.GetPreference(a+"-length","",u).setData("");return}let s=0;for(;r!=="";){if(r===void 0||r==="undefined")throw n.setData(void 0),"Got 'undefined' or a literal string containing 'undefined' for a long preference with name "+e;if(r==="undefined")throw n.setData(void 0),"Got a literal string containing 'undefined' for a long preference with name "+e;if(s>100)throw"This long preference is getting very long... ";l.GetPreference(a+"-"+s,"",u).setData(r.substr(0,255)),r=r.substr(255),s++}c.setData(""+s)});function i(r){if(Object.keys(l.preferences.data).length===0)return;const s=Number(r);if(s>100)throw"Length to long";let f="";for(let h=0;h<s;h++){const g=a+"-"+h;l.preferences.data[g]===void 0&&console.warn("Detected a broken combined preference:",g,"is undefined",l.preferences),f+=l.preferences.data[g]??""}n.setData(f)}return c.addCallback(r=>{i(Number(r))}),this.preferences.addCallbackAndRun(r=>{i(Number(c.data))}),n}GetPreference(e,t=void 0,n){const a=(n==null?void 0:n.prefix)??"mapcomplete-";if(e.startsWith(a)&&a!==""&&console.trace("A preference was requested which has a duplicate prefix in its key. This is probably a bug"),e=a+e,e=e.replace(/[:\\\/"' {}.%]/g,""),e.length>=255)throw"Preferences: key length to big";const u=this.preferenceSources.get(e);if(u!==void 0)return u;this.userDetails.data.loggedIn&&this.preferences.data[e]===void 0&&this.UpdatePreferences();const c=new v(this.preferences.data[e]??t,"osm-preference:"+e);return c.addCallback(l=>{this.UploadPreference(e,l)}),this.preferences.addCallbackD(l=>{const i=l[e];i!==void 0&&c.setData(i)}),this.preferenceSources.set(e,c),c}ClearPreferences(){let e=!1;const t=this;this.preferences.addCallback(n=>{if(console.log("Cleaning preferences..."),Object.keys(n).length==0||e)return;e=!0;const a=["mapcomplete-"];for(const u in n)a.some(l=>u.startsWith(l))&&(console.log("Clearing ",u),t.GetPreference(u,"",{prefix:""}).setData(""));e=!1})}removeAllWithPrefix(e){for(const t in this.preferences.data)t.startsWith(e)&&(this.GetPreference(t,"",{prefix:""}).setData(void 0),console.log("Clearing preference",t));this.preferences.ping()}UpdatePreferences(e){const t=this;this._fakeUser||this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},function(n,a){if(n){console.log("Could not load preferences",n);return}const u=a.getElementsByTagName("preference"),c=new Set;for(let l=0;l<u.length;l++){const i=u[l],r=i.getAttribute("k"),s=i.getAttribute("v");t.preferences.data[r]=s,c.add(r)}if(e)for(let l in t.preferences.data)c.has(l)||(console.log("Deleting key",l,"as we didn't find it upstream"),delete t.preferences.data[l]);t.preferenceSources.forEach((l,i)=>{const r=t.preferences.data[i];r===void 0&&l.data!==void 0?t.UploadPreference(i,l.data):l.setData(r)}),t.preferences.ping()})}UploadPreference(e,t){if(!this.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(this.preferences.data[e]===t)return;const n=this;if(console.debug("Updating preference",e," to ",_.EllipsesAfter(t,15)),!this._fakeUser){if(t===void 0||t===""){this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),headers:{"Content-Type":"text/plain"}},function(a){if(a){console.warn("Could not remove preference",a);return}delete n.preferences.data[e],n.preferences.ping(),console.debug("Preference ",e,"removed!")});return}this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),headers:{"Content-Type":"text/plain"},content:t},function(a){if(a){console.warn(`Could not set preference "${e}"'`,a);return}n.preferences.data[e]=t,n.preferences.ping(),console.debug(`Preference ${e} written!`)})}}}class M{constructor(e){d(this,"loggedIn",!1);d(this,"name","Not logged in");d(this,"uid");d(this,"csCount",0);d(this,"img");d(this,"unreadMessages",0);d(this,"totalMessages",0);d(this,"home");d(this,"backend");d(this,"account_created");d(this,"tracesCount",0);d(this,"description");d(this,"languages");this.backend=e}}class N{constructor(e){d(this,"auth");d(this,"userDetails");d(this,"isLoggedIn");d(this,"gpxServiceIsOnline",new v("unknown"));d(this,"apiIsOnline",new v("unknown"));d(this,"loadingStatus",new v("not-attempted"));d(this,"preferencesHandler");d(this,"_oauth_config");d(this,"_dryRun");d(this,"fakeUser");d(this,"_onLoggedIn",[]);d(this,"_iframeMode");d(this,"_singlePage");d(this,"isChecking",!1);d(this,"_doCheckRegularly");d(this,"_userInfoCache",{});var t;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=O.osmAuthConfig,this._doCheckRegularly=(e==null?void 0:e.checkOnlineRegularly)??!0,console.debug("Using backend",this._oauth_config.url),this._iframeMode=_.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new v(new M(this._oauth_config.url),"userDetails"),e.fakeUser){const n=this.userDetails.data;n.csCount=5678,n.uid=42,n.loggedIn=!0,n.unreadMessages=0,n.name="Fake user",n.totalMessages=42,n.languages=["en"],this.loadingStatus.setData("logged-in")}this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(n=>n.loggedIn&&(this.apiIsOnline.data==="unknown"||this.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(n=>{this.userDetails.data.loggedIn==!1&&n==!0&&this.AttemptLogin()}),this._dryRun=e.dryRun??new v(!1),this.updateAuthObject(),this.fakeUser||this.CheckForMessagesContinuously(),this.preferencesHandler=new L(this.auth,this,this.fakeUser),((t=e.oauth_token)==null?void 0:t.data)!==void 0&&(console.log(e.oauth_token.data),this.auth.bootstrapToken(e.oauth_token.data,(n,a)=>{console.log("Bootstrap token called back",n,a),this.AttemptLogin()}),e.oauth_token.setData(void 0)),!_.runningFromConsole&&this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,t=void 0,n){return this.preferencesHandler.GetPreference(e,t,n)}GetLongPreference(e,t="mapcomplete-"){return this.preferencesHandler.GetLongPreference(e,t)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted"),this.preferencesHandler.preferences.setData(void 0)}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.data!=="logged-in"&&this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}console.log("Trying to log in..."),this.updateAuthObject(),I.Get("location_before_login").setData(_.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},(e,t)=>{var r;if(e!=null){console.log("Could not login due to:",e),this.loadingStatus.setData("error"),e.status==401?(console.log("Clearing tokens..."),this.auth.logout(),this.LogOut()):(console.log("Other error. Status:",e.status),this.apiIsOnline.setData("unreachable"));return}if(t==null){this.loadingStatus.setData("error");return}const n=t.getElementsByTagName("user")[0],a=this.userDetails.data;a.loggedIn=!0,console.log("Login completed, userinfo is ",n),a.name=n.getAttribute("display_name"),a.account_created=n.getAttribute("account_created"),a.uid=Number(n.getAttribute("id")),a.languages=Array.from(n.getElementsByTagName("languages")[0].getElementsByTagName("lang")).map(s=>s.textContent),a.csCount=Number.parseInt(n.getElementsByTagName("changesets")[0].getAttribute("count")??"0"),a.tracesCount=Number.parseInt(n.getElementsByTagName("traces")[0].getAttribute("count")??"0"),a.img=void 0;const u=n.getElementsByTagName("img");u!==void 0&&u[0]!==void 0&&(a.img=u[0].getAttribute("href"));const c=n.getElementsByTagName("description");c!==void 0&&c[0]!==void 0&&(a.description=(r=c[0])==null?void 0:r.innerHTML);const l=n.getElementsByTagName("home");if(l!==void 0&&l[0]!==void 0){const s=parseFloat(l[0].getAttribute("lat")),f=parseFloat(l[0].getAttribute("lon"));a.home={lat:s,lon:f}}this.loadingStatus.setData("logged-in");const i=n.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];a.unreadMessages=parseInt(i.getAttribute("unread")),a.totalMessages=parseInt(i.getAttribute("count")),this.userDetails.ping();for(const s of this._onLoggedIn)s(this.userDetails.data);this._onLoggedIn=[]})}async interact(e,t,n,a,u=!1){const c=this.auth;if(u&&!this.auth.authenticated()){const l=await _.downloadAdvanced(`${this.Backend()}/api/0.6/${e}`,n,t,a);if(l.content)return l.content;throw console.error(l),"Could not interact with OSM:"+l.error}return new Promise((l,i)=>{c.xhr({method:t,headers:n,content:a,path:`/api/0.6/${e}`},function(r,s){r!==null?i(r):l(s)})})}async post(e,t,n,a=!1){return await this.interact(e,"POST",n,t,a)}async put(e,t,n){return await this.interact(e,"PUT",n,t)}async get(e,t,n=!1){return await this.interact(e,"GET",t,void 0,n)}closeNote(e,t){let n="";return(t??"")!==""&&(n="?text="+encodeURIComponent(t)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",t),new Promise(a=>{a("")})):this.post(`notes/${e}/close${n}`)}reopenNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",t),new Promise(a=>{a("")});let n="";return(t??"")!==""&&(n="?text="+encodeURIComponent(t)),this.post(`notes/${e}/reopen${n}`)}async openNote(e,t,n){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",n),new Promise(i=>{window.setTimeout(()=>i({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const a=`lat=${e}&lon=${t}&text=${encodeURIComponent(n)}`,u=await this.post("notes.json",a,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},!0),c=JSON.parse(u);console.log("Got result:",c);const l=c.properties;return console.log("OPENED NOTE",l),l}async uploadGpxTrack(e,t){var r;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise(s=>{window.setTimeout(()=>s({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const n={file:e,description:t.description,tags:((r=t.labels)==null?void 0:r.join(","))??"",visibility:t.visibility};if(!n.description)throw"The description of a GPS-trace cannot be the empty string, undefined or null";const a={file:'; filename="'+(t.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},u="987654";let c="";for(const s in n)c+="--"+u+`\r
`,c+='Content-Disposition: form-data; name="'+s+'"',a[s]!==void 0&&(c+=a[s]),c+=`\r
\r
`,c+=n[s]+`\r
`;c+="--"+u+`--\r
`;const l=await this.post("gpx/create",c,{"Content-Type":"multipart/form-data; boundary="+u,"Content-Length":""+c.length}),i=JSON.parse(l);return console.log("Uploaded GPX track",i),{id:i}}addCommentToNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",t,"to  note ",e),new Promise(n=>{n()});if((t??"")==="")throw"Invalid text!";return new Promise((n,a)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(t)}`},function(u){u!==null?a(u):n()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const t=I.Get("location_before_login");e(t.data)})}updateAuthObject(){this.auth=new E({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes openid",redirect_uri:_.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!0,auto:!0})}CheckForMessagesContinuously(){this.isChecking||(T.Chronic(3*1e3).addCallback(()=>{if(this.apiIsOnline.data==="unreachable"||this.apiIsOnline.data==="offline")try{console.log("Api is offline - trying to reconnect..."),this.AttemptLogin()}catch(e){console.log("Could not login due to",e)}}),this.isChecking=!0,this._doCheckRegularly&&T.Chronic(60*5*1e3).addCallback(()=>{if(this.isLoggedIn.data)try{this.AttemptLogin()}catch(e){console.log("Could not login due to",e)}}))}UpdateCapabilities(){this.fakeUser||this.FetchCapabilities().then(({api:e,gpx:t})=>{this.apiIsOnline.setData(e),this.gpxServiceIsOnline.setData(t)})}async getInformationAboutUser(e){if(e===void 0)return;if(this._userInfoCache[e])return this._userInfoCache[e];const t=await this.get("user/"+e+".json",{accepts:"application/json"},!0),n=JSON.parse(t).user;return this._userInfoCache[e]=n,n}async FetchCapabilities(){if(_.runningFromConsole)return{api:"online",gpx:"online"};const e=await _.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const t=e.content,a=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("status")[0],u=a.getAttribute("api"),c=a.getAttribute("gpx");return{api:u,gpx:c}}}d(N,"GpxTrackVisibility",["private","public","trackable","identifiable"]);export{N as O};
//# sourceMappingURL=OsmConnection-a94e17a1.js.map
