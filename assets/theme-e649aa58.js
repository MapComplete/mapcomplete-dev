var F=Object.defineProperty;var N=(p,n,r)=>n in p?F(p,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):p[n]=r;var C=(p,n,r)=>(N(p,typeof n!="symbol"?n+"":n,r),r);import"./modulepreload-polyfill-3cfb730f.js";import"./FeatureSwitchState-c816ad84.js";import{L as G}from"./LayoutConfig-837093aa.js";import{Q as B,H as J,F as I,C as H,S as W}from"./tw-merge-45803307.js";import{c as P,q as Z,k as E,a as Q,d as q,e as K,D as X}from"./AllKnownLayouts-37083661.js";import{U as x}from"./UIEventSource-54cce8b1.js";import{L as D}from"./LocalStorageSource-07dfa8fb.js";import{g as Y,al as $,am as j,an as V,ak as _,l as ee,ah as te,av as ne}from"./FixImages-05c19244.js";import{T as oe,a as ae,D as re}from"./ThemeViewGUI-98a406a5.js";import{S as ie}from"./Checkbox-0df58f55.js";import{C as se}from"./Constants-33441499.js";import"./index-6e2ebcaa.js";import"./Add-1bdd4077.js";import"./LanguagePicker-233a47d4.js";import"./Loading-548c7230.js";import"./Dropdown-e8d13467.js";import"./BackButton-8fba86d1.js";import"./Login-a6d0eb59.js";import"./preload-helper-7d181e38.js";import"./OsmConnection-13c2afcf.js";import"./Community-77a87910.js";import"./Filterview-2603a1f9.js";import"./PrivacyPolicy-26bac4d0.js";let k=(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en").substr(0,2);function z(p){var r;let n=0;for(const e of Array.from(p.children))((r=e.attributes.getNamedItem("lang"))==null?void 0:r.value)===k&&n++;n===0&&(k="en");for(const e of Array.from(p.children)){const u=e.attributes.getNamedItem("lang");u!==void 0&&u.value!==k&&e.parentElement.removeChild(e)}}z(document.getElementById("descriptions-while-loading"));z(document.getElementById("default-title"));var M={exports:{}};M.exports;(function(p){var n=function(){var r=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",T={};function b(t,a){if(!T[t]){T[t]={};for(var c=0;c<t.length;c++)T[t][t.charAt(c)]=c}return T[t][a]}var i={compressToBase64:function(t){if(t==null)return"";var a=i._compress(t,6,function(c){return e.charAt(c)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(t){return t==null?"":t==""?null:i._decompress(t.length,32,function(a){return b(e,t.charAt(a))})},compressToUTF16:function(t){return t==null?"":i._compress(t,15,function(a){return r(a+32)})+" "},decompressFromUTF16:function(t){return t==null?"":t==""?null:i._decompress(t.length,16384,function(a){return t.charCodeAt(a)-32})},compressToUint8Array:function(t){for(var a=i.compress(t),c=new Uint8Array(a.length*2),l=0,s=a.length;l<s;l++){var g=a.charCodeAt(l);c[l*2]=g>>>8,c[l*2+1]=g%256}return c},decompressFromUint8Array:function(t){if(t==null)return i.decompress(t);for(var a=new Array(t.length/2),c=0,l=a.length;c<l;c++)a[c]=t[c*2]*256+t[c*2+1];var s=[];return a.forEach(function(g){s.push(r(g))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(t){return t==null?"":i._compress(t,6,function(a){return u.charAt(a)})},decompressFromEncodedURIComponent:function(t){return t==null?"":t==""?null:(t=t.replace(/ /g,"+"),i._decompress(t.length,32,function(a){return b(u,t.charAt(a))}))},compress:function(t){return i._compress(t,16,function(a){return r(a)})},_compress:function(t,a,c){if(t==null)return"";var l,s,g={},R={},S="",A="",y="",v=2,w=3,m=2,h=[],o=0,f=0,d;for(d=0;d<t.length;d+=1)if(S=t.charAt(d),Object.prototype.hasOwnProperty.call(g,S)||(g[S]=w++,R[S]=!0),A=y+S,Object.prototype.hasOwnProperty.call(g,A))y=A;else{if(Object.prototype.hasOwnProperty.call(R,y)){if(y.charCodeAt(0)<256){for(l=0;l<m;l++)o=o<<1,f==a-1?(f=0,h.push(c(o)),o=0):f++;for(s=y.charCodeAt(0),l=0;l<8;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1}else{for(s=1,l=0;l<m;l++)o=o<<1|s,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=0;for(s=y.charCodeAt(0),l=0;l<16;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1}v--,v==0&&(v=Math.pow(2,m),m++),delete R[y]}else for(s=g[y],l=0;l<m;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1;v--,v==0&&(v=Math.pow(2,m),m++),g[A]=w++,y=String(S)}if(y!==""){if(Object.prototype.hasOwnProperty.call(R,y)){if(y.charCodeAt(0)<256){for(l=0;l<m;l++)o=o<<1,f==a-1?(f=0,h.push(c(o)),o=0):f++;for(s=y.charCodeAt(0),l=0;l<8;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1}else{for(s=1,l=0;l<m;l++)o=o<<1|s,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=0;for(s=y.charCodeAt(0),l=0;l<16;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1}v--,v==0&&(v=Math.pow(2,m),m++),delete R[y]}else for(s=g[y],l=0;l<m;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1;v--,v==0&&(v=Math.pow(2,m),m++)}for(s=2,l=0;l<m;l++)o=o<<1|s&1,f==a-1?(f=0,h.push(c(o)),o=0):f++,s=s>>1;for(;;)if(o=o<<1,f==a-1){h.push(c(o));break}else f++;return h.join("")},decompress:function(t){return t==null?"":t==""?null:i._decompress(t.length,32768,function(a){return t.charCodeAt(a)})},_decompress:function(t,a,c){var l=[],s=4,g=4,R=3,S="",A=[],y,v,w,m,h,o,f,d={val:c(0),position:a,index:1};for(y=0;y<3;y+=1)l[y]=y;for(w=0,h=Math.pow(2,2),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;switch(w){case 0:for(w=0,h=Math.pow(2,8),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;f=r(w);break;case 1:for(w=0,h=Math.pow(2,16),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;f=r(w);break;case 2:return""}for(l[3]=f,v=f,A.push(f);;){if(d.index>t)return"";for(w=0,h=Math.pow(2,R),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;switch(f=w){case 0:for(w=0,h=Math.pow(2,8),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;l[g++]=r(w),f=g-1,s--;break;case 1:for(w=0,h=Math.pow(2,16),o=1;o!=h;)m=d.val&d.position,d.position>>=1,d.position==0&&(d.position=a,d.val=c(d.index++)),w|=(m>0?1:0)*o,o<<=1;l[g++]=r(w),f=g-1,s--;break;case 2:return A.join("")}if(s==0&&(s=Math.pow(2,R),R++),l[f])S=l[f];else if(f===g)S=v+v.charAt(0);else return null;A.push(S),l[g++]=v+S.charAt(0),s--,v=S,s==0&&(s=Math.pow(2,R),R++)}}};return i}();p!=null&&(p.exports=n)})(M);var le=M.exports;const O=Y(le);class ce extends _{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(n,r){var T,b;if(typeof n=="string"||n.builtin!==void 0)return n;r=r.enter(n.id);let e={...n};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags),(T=e.allowMove)!=null&&T.enableImproveAccuraccy&&(e.allowMove.enableImproveAccuracy=e.allowMove.enableImproveAccuraccy,delete e.allowMove.enableImproveAccuraccy);for(const i of e.presets??[]){const t=i.preciseInput;typeof t=="boolean"?delete i.preciseInput:t!==void 0&&(delete t.preferredBackground,i.snapToLayer=t.snapToLayer,delete t.snapToLayer,t.maxSnapDistance&&(i.maxSnapDistance=t.maxSnapDistance,delete t.maxSnapDistance),Object.keys(t).length==0&&delete i.preciseInput),typeof i.snapToLayer=="string"&&(i.snapToLayer=[i.snapToLayer])}if(e.tagRenderings!==void 0){let i=0;for(const t of e.tagRenderings)t&&(i++,!(typeof t=="string"||t.builtin!==void 0||t.rewrite!==void 0)&&t.id===void 0&&(t["#"]!==void 0?(t.id=t["#"],delete t["#"]):((b=t.freeform)==null?void 0:b.key)!==void 0?t.id=e.id+"-"+t.freeform.key:t.id="tr-"+i))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let i=["point"],t=e.wayHandling??0;if(t!==0&&(i=["point","centroid"]),e.icon??e.label!==void 0){const a={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:i,rotation:e.rotation};e.mapRendering.push(a)}if(t!==1){const a={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(a).length>0&&e.mapRendering.push(a)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const u=e.source;delete u.isOsmCache,delete u.maxCacheAge,delete u.widenFactor;for(const i of e.mapRendering??[]){i.iconOverlays!==void 0&&(i.iconBadges=i.iconOverlays);for(const t of i.iconBadges??[])t.badge!==!0&&r.enters("iconBadges","badge").warn("Non-overlay element"),delete t.badge}if(e.mapRendering){const i=[],t=[];for(const a of e.mapRendering)a.location?i.push(a):t.push(a);e.pointRendering=i,e.lineRendering=t,delete e.mapRendering}for(const i of e.pointRendering??[]){const t=i;if(t.icon)try{let c=t.icon;Object.keys(c).length===1&&c.render!==void 0&&(c=c.render);const l=x.NoEmpty(c.split(";"));t.marker=l.map(s=>{if(s.startsWith("http"))return{icon:s};const[g,R]=s.split(":");return{icon:g,color:R}}),delete t.icon}catch{console.error("Could not handle icon in",n.id),t.marker=[{icon:t.icon}],delete t.icon}let a=t.iconSize;if(a&&(Object.keys(t.iconSize).length===1&&t.iconSize.render!==void 0&&(a=t.iconSize.render),typeof a=="string"&&["bottom","center","top"].some(c=>a.endsWith(c)))){const c=a.split(",").map(l=>l.toLowerCase().trim());t.anchor=c.pop(),t.iconSize=c.join(",")}}if(e.pointRendering)for(const i of e.pointRendering)for(const t in i)i[t]&&typeof i[t].render=="string"&&Object.keys(i[t]).length===1&&(i[t]=i[t].render);if(e.lineRendering)for(const i of e.lineRendering)for(const t in i)i[t]&&typeof i[t].render=="string"&&Object.keys(i[t]).length===1&&(i[t]=i[t].render);return e}}class de extends _{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(n,r){const e={...n};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return r.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=x.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class fe extends ${constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new de,new j("layers",new V(new ce)))}}const L=class L{static getCustomDefinition(){const n=decodeURIComponent(L.loadCustomThemeParam.data);if(n.startsWith("http"))return n;if(n!=="false"){const r=J.hash.data;try{return JSON.parse(atob(r)),atob(r)}catch{return JSON.parse(x.UnMinify(O.decompressFromBase64(r))),x.UnMinify(O.decompressFromBase64(r))}}}static async expandRemoteLayers(n){if(!n.layers)return n;for(let r=0;r<n.layers.length;r++){const e=n.layers[r];if(typeof e=="string")try{new URL(e),console.log("Downloading remote layer "+e);const u=await x.downloadJson(e);n.layers[r]=u}catch{continue}}return n}static async GetLayout(){const n=decodeURIComponent(L.loadCustomThemeParam.data);if(n.startsWith("http"))return await L.LoadRemoteTheme(n);if(n!=="false")return await L.LoadLayoutFromHash(L.loadCustomThemeParam);let r;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(r=e,e.endsWith(".html")&&(r=e.substr(0,e.length-5)),console.log("Using layout",r)),r=B.GetQueryParameter("layout",r,"The layout to load into MapComplete").data;const u=P.allKnownLayouts.get(r==null?void 0:r.toLowerCase());if(u===void 0)throw"No builtin map theme with name "+r+" exists";return u}static async LoadLayoutFromHash(n){var i,t;let r=location.hash.substr(1),e;const u=D.Get("user-layout-"+((i=n.data)==null?void 0:i.replace(" ","_")));((t=u.data)==null?void 0:t.length)<10&&u.setData(void 0);const T=D.Get("last-loaded-user-layout");r.length<10?r=u.data??T.data:(console.log("Saving hash to local storage"),T.setData(r),u.setData(r));try{e=JSON.parse(atob(r))}catch{e=JSON.parse(x.UnMinify(O.decompressFromBase64(r)))}e=await this.expandRemoteLayers(e);const b=L.prepCustomTheme(e);return n.setData(b.id),b}static getSharedTagRenderings(){const n=new Map;for(const r of Z.tagRenderings)n.set(r.id,r);return n}static prepCustomTheme(n,r,e){var i,t;if(n.layers===void 0&&n.tagRenderings!==void 0){const c=n.pointRendering.map(s=>{var g,R;return(R=(g=s==null?void 0:s.marker)==null?void 0:g.find(S=>S.icon!==void 0))==null?void 0:R.icon}).find(s=>s!==void 0)??"bug",l=((t=(i=new te(c))==null?void 0:i.render)==null?void 0:t.txt)??"./assets/svg/bug.svg";n={id:n.id,description:n.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:l,title:n.name,layers:[n]}}const u=new Map;for(const a in E.layers){const c=E.layers[a];u.set(c.id,c)}const T={tagRenderings:L.getSharedTagRenderings(),sharedLayers:u,publicLayers:new Set};n=new fe().convertStrict(n);const b=n;return n=new ne(L._knownImages).convertStrict(n),n.enableNoteImports=n.enableNoteImports??!1,n=new Q(T).convertStrict(n),console.log("The layoutconfig is ",n),n.id=e??n.id,new q().convertStrict(n),new K(new X(new Set,a=>!0),"",!1).convertStrict(n),new G(n,!1,{definitionRaw:JSON.stringify(b,null,"  "),definedAtUrl:r})}static async LoadRemoteTheme(n){console.log("Downloading map theme from ",n),new I(`Downloading the theme from the <a href="${n}">link</a>...`).AttachTo("maindiv");let r=await x.downloadJson(n),e=r.id;const u=new URL(n);return u.hostname==="localhost"||u.hostname==="127.0.0.1"||(e=n),console.log("Loaded remote link:",n),r=await this.expandRemoteLayers(r),L.prepCustomTheme(r,n,e)}};C(L,"_knownImages",new Set(Array.from(ee).map(n=>n.path))),C(L,"loadCustomThemeParam",B.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let U=L;function pe(){try{const p=document.createElement("canvas");return!!window.WebGLRenderingContext&&(p.getContext("webgl")||p.getContext("experimental-webgl"))}catch{return!1}}async function me(p){return await x.waitFor(p),{layers:[]}}async function ue(){try{const p=new URL(se.SummaryServer).host,n=await Promise.any([x.downloadJson("https://"+p+"/summary/status.json"),me(2500)]);return new Set(n.layers)}catch(p){return console.error("Could not get MVT available layers due to",p),new Set}}async function he(){try{if(!pe())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[p,n]=await Promise.all([U.GetLayout(),await ue()]);console.log("The available layers on server are",Array.from(n));const r=new oe(p,n);new ae({target:document.getElementById("maindiv"),props:{state:r}}),Array.from(document.getElementsByClassName("delete-on-load")).forEach(e=>{e.parentElement.removeChild(e)})}catch(p){console.error("Error while initializing: ",p,p.stack);const n=U.getCustomDefinition();new H([new I(p.toString().split(`
`).join("<br/>")).SetClass("block alert"),(n==null?void 0:n.length)>0?new ie(new W(re),"Download the raw file").onClick(()=>x.offerContentsAsDownloadableFile(U.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}he().then(p=>{});
//# sourceMappingURL=theme-e649aa58.js.map
