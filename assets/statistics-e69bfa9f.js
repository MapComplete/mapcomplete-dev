var O=Object.defineProperty;var R=(f,e,r)=>e in f?O(f,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):f[e]=r;var h=(f,e,r)=>(R(f,typeof e!="symbol"?e+"":e,r),r);import{U as p}from"./Utils-45e0ac39.js";import{U as L}from"./UIEventSource-b2e0ae35.js";import{V as j,C as g,F as V}from"./tw-merge-406b9d2a.js";import{n as N,a as d,q as W,G as A}from"./SubtleLink-8f77ee6e.js";import{L as P,F as G,b as U,a as J,S as K}from"./Checkbox-dc9dc3e8.js";import{m as z}from"./mapcomplete-changes-7b829b57.js";import{k as I}from"./index-8d610534.js";import{F as Y}from"./Filterview-dfafe32d.js";import"./LocalStorageSource-152a04ab.js";import"./_commonjsHelpers-23102255.js";import"./Constants-20b684f6.js";import"./Dropdown-37378ddd.js";class H extends g{constructor(e,r){r=r.filter(i=>!i.endsWith("file-overview.json"));const n=new P(z,!0).layers[0],a=new G(n),w=new g([new d("Filters"),new I(Y,{filteredLayer:a})]),v=new L([]);for(const i of r)i.endsWith("file-overview.json")||p.downloadJson(e+i).then(o=>{var y;o!==void 0&&(o.features===void 0&&(o.features=o),(y=o==null?void 0:o.features)==null||y.forEach(l=>{l.properties={...l.properties,...l.properties.metadata},delete l.properties.metadata}),v.data.push(o),v.ping())});const E=new N(new j(v.map(i=>"Downloaded "+i.length+" items out of "+r.length)));super([w,new j(v.map(i=>{var T;if(i.length!==r.length)return E;const o=_.fromDirtyData([].concat(...i.map(t=>t.features))).filter(t=>a.isShown(t.properties));if(console.log("Overview is",o),o._meta.length===0)return"No data matched the filter";const l=p.NoNull(o._meta.map(t=>t.properties.date)).map(t=>new Date(t).getTime()),q=Math.min(...l),C=(Math.max(...l)-q)/(1e3*60*60*24);console.log("Diff in days is ",C,"got",o._meta.length);const B=n.tagRenderings.filter(t=>{var s,c;return((s=t.mappings)==null?void 0:s.length)>0||((c=t.freeform)==null?void 0:c.key)!==void 0}),D=new Set;for(const t of o._meta)for(const s in t.properties)D.add(s);console.log("All keys:",D);const F=["create","modify","delete","answer","move","deletion","add-image","plantnet-ai-detection","import","conflation","link-image","soft-delete"],S=p.Dedup(o._meta.map(t=>t.properties.theme)),k=new Set;S.length>1&&(k.add("grb"),k.add("etymology"));const M=F.map(t=>[t,o.sum(t,k)]).filter(t=>t[1]!=0).map(t=>t.join(": ")),b=[new d(S.length===1?"General statistics for "+S[0]:"General statistics (excluding etymology- and GRB-theme changes)"),new g([o._meta.length+" changesets match the filters",new W(M)]).SetClass("flex flex-col border rounded-xl"),new d("Breakdown")];for(const t of B){if(t.question===void 0)continue;console.log(t);let s;((T=t.freeform)==null?void 0:T.key)!==void 0&&(s=new Set(o._meta.map(c=>c.properties[t.freeform.key])).size);try{b.push(new g([new d(t.question??t.id).SetClass("p-2"),s>1?s+" unique value":void 0,new d("By number of changesets",4).SetClass("p-2"),new U(t,o._meta,{period:C<=367?"day":"month",groupToOtherCutoff:s>50?25:s>10?3:0}).SetStyle("width: 75%; height: 600px"),new J(o._meta,t,{groupToOtherCutoff:s>50?25:s>10?3:0,chartType:"doughnut",chartclasses:"w-8 h-8",sort:!0}).SetStyle("width: 25rem"),new d("By number of modifications",4).SetClass("p-2"),new U(t,p.Clone(o._meta),{period:C<=367?"day":"month",groupToOtherCutoff:s>50?10:0,sumFields:F}).SetStyle("width: 100%; height: 600px")]).SetClass("block border-2 border-subtle p-2 m-2 rounded-xl"))}catch(c){console.log("Could not generate a chart",c),b.push(new V("No relevant information for "+t.question.txt))}}return b.push(new K(void 0,"Download as csv").onClick(()=>{const t=A.toCSV(o._meta,{ignoreTags:/^((deletion:node)|(import:node)|(move:node)|(soft-delete:))/});p.offerContentsAsDownloadableFile(t,"statistics.csv",{mimetype:"text/csv"})})),new g(b)},[a.currentFilter])).SetClass("block w-full h-full")]),this.SetClass("block w-full h-full")}}const m=class m extends j{constructor(){const e=L.FromPromise(p.downloadJson(m.homeUrl+m.stats_files));super(e.map(r=>r===void 0?new N("Loading overview..."):new H(m.homeUrl,r))),this.SetClass("block w-full h-full")}};h(m,"homeUrl","https://raw.githubusercontent.com/pietervdvn/MapComplete-data/main/changeset-metadata/"),h(m,"stats_files","file-overview.json");let x=m;const u=class u{constructor(e){h(this,"_meta");this._meta=p.NoNull(e)}static fromDirtyData(e){return new u(e==null?void 0:e.map(r=>u.cleanChangesetData(r)))}static cleanChangesetData(e){var n;if(e===void 0||(n=e.properties.editor)!=null&&n.startsWith("iD"))return;e.properties.theme===void 0&&(e.properties.theme=e.properties.comment.substr(e.properties.comment.lastIndexOf("#")+1)),e.properties.theme=e.properties.theme.toLowerCase();const r=u.theme_remappings[e.properties.theme];e.properties.theme=r??e.properties.theme,e.properties.theme.startsWith("https://raw.githubusercontent.com/")&&(e.properties.theme="gh://"+e.properties.theme.substr(34)),e.properties.modify+e.properties.delete+e.properties.create==0&&(e.properties.theme="EMPTY CS");try{e.properties.host=new URL(e.properties.host).host}catch{}return e}filter(e){return new u(this._meta.filter(e))}sum(e,r){let n=0;for(const a of this._meta){if(r.has(a.properties.theme))continue;const w=Number(a.properties[e]);isNaN(w)||(n+=w)}return n}};h(u,"theme_remappings",{metamap:"maps",groen:"buurtnatuur","updaten van metadata met mapcomplete":"buurtnatuur","Toevoegen of dit natuurreservaat toegangkelijk is":"buurtnatuur","wiki:mapcomplete/fritures":"fritures","wiki:MapComplete/Fritures":"fritures",lits:"lit",pomp:"cyclofix","wiki:user:joost_schouppe/campersite":"campersite","wiki-user-joost_schouppe-geveltuintjes":"geveltuintjes","wiki-user-joost_schouppe-campersite":"campersite","wiki-User-joost_schouppe-campersite":"campersite","wiki-User-joost_schouppe-geveltuintjes":"geveltuintjes","wiki:User:joost_schouppe/campersite":"campersite",arbres:"arbres_llefia",aed_brugge:"aed","https://llefia.org/arbres/mapcomplete.json":"arbres_llefia","https://llefia.org/arbres/mapcomplete1.json":"arbres_llefia","toevoegen of dit natuurreservaat toegangkelijk is":"buurtnatuur","testing mapcomplete 0.0.0":"buurtnatuur",entrances:"indoor","https://raw.githubusercontent.com/osmbe/play/master/mapcomplete/geveltuinen/geveltuinen.json":"geveltuintjes"});let _=u;new x().AttachTo("main");
//# sourceMappingURL=statistics-e69bfa9f.js.map
