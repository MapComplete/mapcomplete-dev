var N=Object.defineProperty;var G=(m,t,r)=>t in m?N(m,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):m[t]=r;var C=(m,t,r)=>(G(m,typeof t!="symbol"?t+"":t,r),r);import{U as x}from"./Utils-28f00dfc.js";import"./FeatureSwitchState-601ab704.js";import{L as H,S as J}from"./Checkbox-79d6918d.js";import{Q as B,H as W,F as z,C as P}from"./tw-merge-7570a3e9.js";import{a0 as Z,a9 as D}from"./preload-helper-0ac5d3a7.js";import{L as E}from"./LocalStorageSource-91540725.js";import{a as Q,C as q}from"./Constants-15d36799.js";import{ae as K,af as X,ag as Y,ad as F,a1 as $,aa as j,an as V}from"./FixImages-dad463af.js";import{q as ee,a as te,c as ne,d as oe,D as ie}from"./questions-0b74a088.js";import{T as ae,a as re,D as se}from"./ThemeViewGUI-1c5f57a7.js";import{k as _}from"./index-047bb07b.js";import"./UIEventSource-2fd3b430.js";import"./placeholder-1115d898.js";import"./Loading-754de247.js";import"./OsmConnection-99a25d7d.js";import"./LanguagePicker-e1c7ef89.js";import"./Dropdown-46c343d5.js";import"./BackButton-4febcf6d.js";import"./Add-f3431a17.js";import"./Login-be56b5c4.js";import"./Community-c78c41ea.js";import"./Filterview-1ed9a85f.js";import"./PrivacyPolicy-3dcce47c.js";let k=(navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||"en").substr(0,2);function I(m){var r;let t=0;for(const e of Array.from(m.children))((r=e.attributes.getNamedItem("lang"))==null?void 0:r.value)===k&&t++;t===0&&(k="en");for(const e of Array.from(m.children)){const u=e.attributes.getNamedItem("lang");u!==void 0&&u.value!==k&&e.parentElement.removeChild(e)}}I(document.getElementById("descriptions-while-loading"));I(document.getElementById("default-title"));var M={exports:{}};M.exports;(function(m){var t=function(){var r=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",b={};function f(o,a){if(!b[o]){b[o]={};for(var p=0;p<o.length;p++)b[o][o.charAt(p)]=p}return b[o][a]}var n={compressToBase64:function(o){if(o==null)return"";var a=n._compress(o,6,function(p){return e.charAt(p)});switch(a.length%4){default:case 0:return a;case 1:return a+"===";case 2:return a+"==";case 3:return a+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:n._decompress(o.length,32,function(a){return f(e,o.charAt(a))})},compressToUTF16:function(o){return o==null?"":n._compress(o,15,function(a){return r(a+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:n._decompress(o.length,16384,function(a){return o.charCodeAt(a)-32})},compressToUint8Array:function(o){for(var a=n.compress(o),p=new Uint8Array(a.length*2),s=0,l=a.length;s<l;s++){var y=a.charCodeAt(s);p[s*2]=y>>>8,p[s*2+1]=y%256}return p},decompressFromUint8Array:function(o){if(o==null)return n.decompress(o);for(var a=new Array(o.length/2),p=0,s=a.length;p<s;p++)a[p]=o[p*2]*256+o[p*2+1];var l=[];return a.forEach(function(y){l.push(r(y))}),n.decompress(l.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":n._compress(o,6,function(a){return u.charAt(a)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),n._decompress(o.length,32,function(a){return f(u,o.charAt(a))}))},compress:function(o){return n._compress(o,16,function(a){return r(a)})},_compress:function(o,a,p){if(o==null)return"";var s,l,y={},T={},L="",A="",w="",R=2,v=3,h=2,g=[],i=0,d=0,c;for(c=0;c<o.length;c+=1)if(L=o.charAt(c),Object.prototype.hasOwnProperty.call(y,L)||(y[L]=v++,T[L]=!0),A=w+L,Object.prototype.hasOwnProperty.call(y,A))w=A;else{if(Object.prototype.hasOwnProperty.call(T,w)){if(w.charCodeAt(0)<256){for(s=0;s<h;s++)i=i<<1,d==a-1?(d=0,g.push(p(i)),i=0):d++;for(l=w.charCodeAt(0),s=0;s<8;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1}else{for(l=1,s=0;s<h;s++)i=i<<1|l,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=0;for(l=w.charCodeAt(0),s=0;s<16;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1}R--,R==0&&(R=Math.pow(2,h),h++),delete T[w]}else for(l=y[w],s=0;s<h;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1;R--,R==0&&(R=Math.pow(2,h),h++),y[A]=v++,w=String(L)}if(w!==""){if(Object.prototype.hasOwnProperty.call(T,w)){if(w.charCodeAt(0)<256){for(s=0;s<h;s++)i=i<<1,d==a-1?(d=0,g.push(p(i)),i=0):d++;for(l=w.charCodeAt(0),s=0;s<8;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1}else{for(l=1,s=0;s<h;s++)i=i<<1|l,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=0;for(l=w.charCodeAt(0),s=0;s<16;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1}R--,R==0&&(R=Math.pow(2,h),h++),delete T[w]}else for(l=y[w],s=0;s<h;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1;R--,R==0&&(R=Math.pow(2,h),h++)}for(l=2,s=0;s<h;s++)i=i<<1|l&1,d==a-1?(d=0,g.push(p(i)),i=0):d++,l=l>>1;for(;;)if(i=i<<1,d==a-1){g.push(p(i));break}else d++;return g.join("")},decompress:function(o){return o==null?"":o==""?null:n._decompress(o.length,32768,function(a){return o.charCodeAt(a)})},_decompress:function(o,a,p){var s=[],l=4,y=4,T=3,L="",A=[],w,R,v,h,g,i,d,c={val:p(0),position:a,index:1};for(w=0;w<3;w+=1)s[w]=w;for(v=0,g=Math.pow(2,2),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;switch(v){case 0:for(v=0,g=Math.pow(2,8),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;d=r(v);break;case 1:for(v=0,g=Math.pow(2,16),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;d=r(v);break;case 2:return""}for(s[3]=d,R=d,A.push(d);;){if(c.index>o)return"";for(v=0,g=Math.pow(2,T),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;switch(d=v){case 0:for(v=0,g=Math.pow(2,8),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;s[y++]=r(v),d=y-1,l--;break;case 1:for(v=0,g=Math.pow(2,16),i=1;i!=g;)h=c.val&c.position,c.position>>=1,c.position==0&&(c.position=a,c.val=p(c.index++)),v|=(h>0?1:0)*i,i<<=1;s[y++]=r(v),d=y-1,l--;break;case 2:return A.join("")}if(l==0&&(l=Math.pow(2,T),T++),s[d])L=s[d];else if(d===y)L=R+R.charAt(0);else return null;A.push(L),s[y++]=R+L.charAt(0),l--,R=L,l==0&&(l=Math.pow(2,T),T++)}}};return n}();m!=null&&(m.exports=t)})(M);var le=M.exports;const O=Q(le);class ce extends F{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(t,r){var b;if(typeof t=="string"||t.builtin!==void 0)return t;r=r.enter(t.id);let e={...t};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags);for(const f of e.presets??[]){const n=f.preciseInput;typeof n=="boolean"?delete f.preciseInput:n!==void 0&&(delete n.preferredBackground,f.snapToLayer=n.snapToLayer,delete n.snapToLayer,n.maxSnapDistance&&(f.maxSnapDistance=n.maxSnapDistance,delete n.maxSnapDistance),Object.keys(n).length==0&&delete f.preciseInput),typeof f.snapToLayer=="string"&&(f.snapToLayer=[f.snapToLayer])}if(e.tagRenderings!==void 0){let f=0;for(const n of e.tagRenderings)n&&(f++,!(typeof n=="string"||n.builtin!==void 0||n.rewrite!==void 0)&&n.id===void 0&&(n["#"]!==void 0?(n.id=n["#"],delete n["#"]):((b=n.freeform)==null?void 0:b.key)!==void 0?n.id=e.id+"-"+n.freeform.key:n.id="tr-"+f))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let f=["point"],n=e.wayHandling??0;if(n!==0&&(f=["point","centroid"]),e.icon??e.label!==void 0){const o={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:f,rotation:e.rotation};e.mapRendering.push(o)}if(n!==1){const o={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(o).length>0&&e.mapRendering.push(o)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;const u=e.source;delete u.isOsmCache,delete u.maxCacheAge,delete u.widenFactor;for(const f of e.mapRendering??[]){f.iconOverlays!==void 0&&(f.iconBadges=f.iconOverlays);for(const n of f.iconBadges??[])n.badge!==!0&&r.enters("iconBadges","badge").warn("Non-overlay element"),delete n.badge}if(e.mapRendering){const f=[],n=[];for(const o of e.mapRendering)o.location?f.push(o):n.push(o);e.pointRendering=f,e.lineRendering=n,delete e.mapRendering}for(const f of e.pointRendering??[]){const n=f;if(n.icon)try{let a=n.icon;Object.keys(a).length===1&&a.render!==void 0&&(a=a.render);const p=x.NoEmpty(a.split(";"));n.marker=p.map(s=>{if(s.startsWith("http"))return{icon:s};const[l,y]=s.split(":");return{icon:l,color:y}}),delete n.icon}catch{console.error("Could not handle icon in",t.id),n.marker=[{icon:n.icon}],delete n.icon}let o=n.iconSize;if(o&&(Object.keys(n.iconSize).length===1&&n.iconSize.render!==void 0&&(o=n.iconSize.render),typeof o=="string"&&["bottom","center","top"].some(a=>o.endsWith(a)))){const a=o.split(",").map(p=>p.toLowerCase().trim());n.anchor=a.pop(),n.iconSize=a.join(",")}}if(e.pointRendering)for(const f of e.pointRendering)for(const n in f)f[n]&&typeof f[n].render=="string"&&Object.keys(f[n]).length===1&&(f[n]=f[n].render);if(e.lineRendering)for(const f of e.lineRendering)for(const n in f)f[n]&&typeof f[n].render=="string"&&Object.keys(f[n]).length===1&&(f[n]=f[n].render);return e}}class de extends F{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(t,r){const e={...t};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return r.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=x.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class fe extends K{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new de,new X("layers",new Y(new ce)))}}const S=class S{static getCustomDefinition(){const t=decodeURIComponent(S.loadCustomThemeParam.data);if(t.startsWith("http"))return t;if(t!=="false"){const r=W.hash.data;try{return JSON.parse(atob(r)),atob(r)}catch{return JSON.parse(x.UnMinify(O.decompressFromBase64(r))),x.UnMinify(O.decompressFromBase64(r))}}}static async expandRemoteLayers(t){if(!t.layers)return t;for(let r=0;r<t.layers.length;r++){const e=t.layers[r];if(typeof e=="string")try{new URL(e),console.log("Downloading remote layer "+e);const u=await x.downloadJson(e);t.layers[r]=u}catch{continue}}return t}static async GetLayout(){const t=decodeURIComponent(S.loadCustomThemeParam.data);if(t.startsWith("http"))return await S.LoadRemoteTheme(t);if(t!=="false")return await S.LoadLayoutFromHash(S.loadCustomThemeParam);let r;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(r=e,e.endsWith(".html")&&(r=e.substr(0,e.length-5)),console.log("Using layout",r)),r=B.GetQueryParameter("layout",r,"The layout to load into MapComplete").data;const u=Z.allKnownLayouts.get(r==null?void 0:r.toLowerCase());if(u===void 0)throw"No builtin map theme with name "+r+" exists";return u}static async LoadLayoutFromHash(t){var n,o;let r=location.hash.substr(1),e;const u=E.Get("user-layout-"+((n=t.data)==null?void 0:n.replace(" ","_")));((o=u.data)==null?void 0:o.length)<10&&u.setData(void 0);const b=E.Get("last-loaded-user-layout");r.length<10?r=u.data??b.data:(console.log("Saving hash to local storage"),b.setData(r),u.setData(r));try{e=JSON.parse(atob(r))}catch{e=JSON.parse(x.UnMinify(O.decompressFromBase64(r)))}e=await this.expandRemoteLayers(e);const f=S.prepCustomTheme(e);return t.setData(f.id),f}static getSharedTagRenderings(){const t=new Map;for(const r of ee.tagRenderings)t.set(r.id,r);return t}static prepCustomTheme(t,r,e){var n,o;if(t.layers===void 0&&t.tagRenderings!==void 0){const p=t.pointRendering.map(l=>{var y,T;return(T=(y=l==null?void 0:l.marker)==null?void 0:y.find(L=>L.icon!==void 0))==null?void 0:T.icon}).find(l=>l!==void 0)??"bug",s=((o=(n=new j(p))==null?void 0:n.render)==null?void 0:o.txt)??"./assets/svg/bug.svg";t={id:t.id,description:t.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:s,title:t.name,layers:[t]}}const u=new Map;for(const a in D.layers){const p=D.layers[a];u.set(p.id,p)}const b={tagRenderings:S.getSharedTagRenderings(),sharedLayers:u,publicLayers:new Set};t=new fe().convertStrict(t);const f=t;return t=new V(S._knownImages).convertStrict(t),t.enableNoteImports=t.enableNoteImports??!1,t=new te(b).convertStrict(t),console.log("The layoutconfig is ",t),t.id=e??t.id,new ne().convertStrict(t),new oe(new ie(new Set,a=>!0),"",!1).convertStrict(t),new H(t,!1,{definitionRaw:JSON.stringify(f,null,"  "),definedAtUrl:r})}static async LoadRemoteTheme(t){console.log("Downloading map theme from ",t),new z(`Downloading the theme from the <a href="${t}">link</a>...`).AttachTo("maindiv");let r=await x.downloadJson(t),e=r.id;const u=new URL(t);return u.hostname==="localhost"||u.hostname==="127.0.0.1"||(e=t),console.log("Loaded remote link:",t),r=await this.expandRemoteLayers(r),S.prepCustomTheme(r,t,e)}};C(S,"_knownImages",new Set(Array.from($).map(t=>t.path))),C(S,"loadCustomThemeParam",B.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let U=S;function pe(){try{const m=document.createElement("canvas");return!!window.WebGLRenderingContext&&(m.getContext("webgl")||m.getContext("experimental-webgl"))}catch{return!1}}async function me(m){return await x.waitFor(m),{layers:[]}}async function ue(){try{const m=new URL(q.VectorTileServer).host,t=await Promise.any([me(0)]);return new Set(t.layers)}catch(m){return console.error("Could not get MVT available layers due to",m),new Set}}async function he(){try{if(!pe())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[m,t]=await Promise.all([U.GetLayout(),await ue()]);console.log("The available layers on server are",Array.from(t));const r=new ae(m,t);new _(re,{state:r}).AttachTo("maindiv"),Array.from(document.getElementsByClassName("delete-on-load")).forEach(u=>{u.parentElement.removeChild(u)})}catch(m){console.error("Error while initializing: ",m,m.stack);const t=U.getCustomDefinition();new P([new z(m.toString().split(`
`).join("<br/>")).SetClass("block alert"),(t==null?void 0:t.length)>0?new J(new _(se),"Download the raw file").onClick(()=>x.offerContentsAsDownloadableFile(U.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}he().then(m=>{});
//# sourceMappingURL=theme-2f9990d5.js.map
