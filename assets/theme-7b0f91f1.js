var z=Object.defineProperty;var E=(g,n,s)=>n in g?z(g,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):g[n]=s;var C=(g,n,s)=>(E(g,typeof n!="symbol"?n+"":n,s),s);import{U as A}from"./Utils-48ded42e.js";import{T as F,a as I}from"./ThemeViewGUI-ffb616a0.js";import{L as G}from"./If-55375bc8.js";import{Q as M,H,F as O,C as J}from"./Translation-948f2d07.js";import{A as N,q as W,k as B,a as Q,c as Z,d as P,D as q}from"./AllKnownLayouts-80e0886d.js";import{L as _}from"./LocalStorageSource-5c82bae4.js";import{F as K,b as X,c as Y,a as D,i as $}from"./FixImages-c09bdca6.js";import{l as V,k as j}from"./PointRenderingConfig-f15314e4.js";import{k as ee,w as te}from"./Svg-8b70b5dd.js";import{b as ne}from"./LanguagePicker-5f2bd5f7.js";import"./TabbedGroup-69993820.js";import"./_commonjsHelpers-87174ba5.js";import"./ToSvelte-065dc30c.js";import"./Constants-88f0c761.js";import"./Tr-c35edf8f.js";import"./Loading-41014eb2.js";import"./tw-merge-79e96412.js";import"./BackButton-8b96f7d5.js";import"./defineProperty-ef1b11c3.js";import"./OsmConnection-d6a6e6fa.js";import"./FeatureSwitchState-7ca9a67c.js";import"./Filterview-f182d9e0.js";var U={},oe={get exports(){return U},set exports(g){U=g}};(function(g){var n=function(){var s=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",l={};function i(o,r){if(!l[o]){l[o]={};for(var p=0;p<o.length;p++)l[o][o.charAt(p)]=p}return l[o][r]}var m={compressToBase64:function(o){if(o==null)return"";var r=m._compress(o,6,function(p){return e.charAt(p)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:m._decompress(o.length,32,function(r){return i(e,o.charAt(r))})},compressToUTF16:function(o){return o==null?"":m._compress(o,15,function(r){return s(r+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:m._decompress(o.length,16384,function(r){return o.charCodeAt(r)-32})},compressToUint8Array:function(o){for(var r=m.compress(o),p=new Uint8Array(r.length*2),a=0,d=r.length;a<d;a++){var T=r.charCodeAt(a);p[a*2]=T>>>8,p[a*2+1]=T%256}return p},decompressFromUint8Array:function(o){if(o==null)return m.decompress(o);for(var r=new Array(o.length/2),p=0,a=r.length;p<a;p++)r[p]=o[p*2]*256+o[p*2+1];var d=[];return r.forEach(function(T){d.push(s(T))}),m.decompress(d.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":m._compress(o,6,function(r){return v.charAt(r)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),m._decompress(o.length,32,function(r){return i(v,o.charAt(r))}))},compress:function(o){return m._compress(o,16,function(r){return s(r)})},_compress:function(o,r,p){if(o==null)return"";var a,d,T={},L={},S="",x="",y="",R=2,w=3,u=2,h=[],t=0,f=0,c;for(c=0;c<o.length;c+=1)if(S=o.charAt(c),Object.prototype.hasOwnProperty.call(T,S)||(T[S]=w++,L[S]=!0),x=y+S,Object.prototype.hasOwnProperty.call(T,x))y=x;else{if(Object.prototype.hasOwnProperty.call(L,y)){if(y.charCodeAt(0)<256){for(a=0;a<u;a++)t=t<<1,f==r-1?(f=0,h.push(p(t)),t=0):f++;for(d=y.charCodeAt(0),a=0;a<8;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1}else{for(d=1,a=0;a<u;a++)t=t<<1|d,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=0;for(d=y.charCodeAt(0),a=0;a<16;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1}R--,R==0&&(R=Math.pow(2,u),u++),delete L[y]}else for(d=T[y],a=0;a<u;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1;R--,R==0&&(R=Math.pow(2,u),u++),T[x]=w++,y=String(S)}if(y!==""){if(Object.prototype.hasOwnProperty.call(L,y)){if(y.charCodeAt(0)<256){for(a=0;a<u;a++)t=t<<1,f==r-1?(f=0,h.push(p(t)),t=0):f++;for(d=y.charCodeAt(0),a=0;a<8;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1}else{for(d=1,a=0;a<u;a++)t=t<<1|d,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=0;for(d=y.charCodeAt(0),a=0;a<16;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1}R--,R==0&&(R=Math.pow(2,u),u++),delete L[y]}else for(d=T[y],a=0;a<u;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1;R--,R==0&&(R=Math.pow(2,u),u++)}for(d=2,a=0;a<u;a++)t=t<<1|d&1,f==r-1?(f=0,h.push(p(t)),t=0):f++,d=d>>1;for(;;)if(t=t<<1,f==r-1){h.push(p(t));break}else f++;return h.join("")},decompress:function(o){return o==null?"":o==""?null:m._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,r,p){var a=[],d=4,T=4,L=3,S="",x=[],y,R,w,u,h,t,f,c={val:p(0),position:r,index:1};for(y=0;y<3;y+=1)a[y]=y;for(w=0,h=Math.pow(2,2),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;switch(w){case 0:for(w=0,h=Math.pow(2,8),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;f=s(w);break;case 1:for(w=0,h=Math.pow(2,16),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;f=s(w);break;case 2:return""}for(a[3]=f,R=f,x.push(f);;){if(c.index>o)return"";for(w=0,h=Math.pow(2,L),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;switch(f=w){case 0:for(w=0,h=Math.pow(2,8),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;a[T++]=s(w),f=T-1,d--;break;case 1:for(w=0,h=Math.pow(2,16),t=1;t!=h;)u=c.val&c.position,c.position>>=1,c.position==0&&(c.position=r,c.val=p(c.index++)),w|=(u>0?1:0)*t,t<<=1;a[T++]=s(w),f=T-1,d--;break;case 2:return x.join("")}if(d==0&&(d=Math.pow(2,L),L++),a[f])S=a[f];else if(f===T)S=R+R.charAt(0);else return null;x.push(S),a[T++]=R+S.charAt(0),d--,R=S,d==0&&(d=Math.pow(2,L),L++)}}};return m}();g!=null&&(g.exports=n)})(oe);class ie extends D{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(n,s){var v;if(typeof n=="string"||n.builtin!==void 0)return n;s=s.enter(n.id);let e={...n};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags);for(const l of e.presets??[]){const i=l.preciseInput;typeof i=="boolean"?delete l.preciseInput:i!==void 0&&(delete i.preferredBackground,l.snapToLayer=i.snapToLayer,delete i.snapToLayer,i.maxSnapDistance&&(l.maxSnapDistance=i.maxSnapDistance,delete i.maxSnapDistance),Object.keys(i).length==0&&delete l.preciseInput),typeof l.snapToLayer=="string"&&(l.snapToLayer=[l.snapToLayer])}if(e.tagRenderings!==void 0){let l=0;for(const i of e.tagRenderings)l++,!(typeof i=="string"||i.builtin!==void 0||i.rewrite!==void 0)&&i.id===void 0&&(i["#"]!==void 0?(i.id=i["#"],delete i["#"]):((v=i.freeform)==null?void 0:v.key)!==void 0?i.id=e.id+"-"+i.freeform.key:i.id="tr-"+l)}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let l=["point"],i=e.wayHandling??0;if(i!==0&&(l=["point","centroid"]),e.icon??e.label!==void 0){const m={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:l,rotation:e.rotation};e.mapRendering.push(m)}if(i!==1){const m={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(m).length>0&&e.mapRendering.push(m)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;for(const l of e.mapRendering??[]){l.iconOverlays!==void 0&&(l.iconBadges=l.iconOverlays);for(const i of l.iconBadges??[])i.badge!==!0&&s.enters("iconBadges","badge").warn("Non-overlay element"),delete i.badge}if(e.mapRendering){const l=[],i=[];for(const m of e.mapRendering)m.location?l.push(m):i.push(m);e.pointRendering=l,e.lineRendering=i,delete e.mapRendering}for(const l of e.pointRendering??[]){const i=l;if(i.icon)try{const o=A.NoEmpty(i.icon.split(";"));i.marker=o.map(r=>{const[p,a]=r.split(":");return{icon:p,color:a}}),delete i.icon}catch{console.error("Could not handle icon in",n.id),i.marker=[{icon:i.icon}],delete i.icon}let m=i.iconSize;if(m&&(Object.keys(i.iconSize).length===1&&i.iconSize.render!==void 0&&(m=i.iconSize.render),typeof m=="string"&&["bottom","center","top"].some(o=>m.endsWith(o)))){const o=m.split(",").map(r=>r.toLowerCase().trim());i.anchor=o.pop(),i.iconSize=o.join(",")}}if(e.pointRendering)for(const l of e.pointRendering)for(const i in l)l[i]&&typeof l[i].render=="string"&&Object.keys(l[i]).length===1&&(l[i]=l[i].render);if(e.lineRendering)for(const l of e.lineRendering)for(const i in l)l[i]&&typeof l[i].render=="string"&&Object.keys(l[i]).length===1&&(l[i]=l[i].render);return e}}class re extends D{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(n,s){const e={...n};if(e.socialImage===""&&delete e.socialImage,e.defaultBackgroundId==="osm"&&console.log("Removing old background in",n.id),typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return s.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=A.NoNull(e.layers),delete e.language,delete e.version,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class ae extends K{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new re,new X("layers",new Y(new ie)))}}const b=class{static getCustomDefinition(){const n=decodeURIComponent(b.loadCustomThemeParam.data);if(n.startsWith("http"))return n;if(n!=="false"){const s=H.hash.data;try{return JSON.parse(atob(s)),atob(s)}catch{return JSON.parse(A.UnMinify(U.decompressFromBase64(s))),A.UnMinify(U.decompressFromBase64(s))}}}static async GetLayout(){const n=decodeURIComponent(b.loadCustomThemeParam.data);if(n.startsWith("http"))return await b.LoadRemoteTheme(n);if(n!=="false")return b.LoadLayoutFromHash(b.loadCustomThemeParam);let s;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(s=e,e.endsWith(".html")&&(s=e.substr(0,e.length-5)),console.log("Using layout",s)),s=M.GetQueryParameter("layout",s,"The layout to load into MapComplete").data;const v=N.allKnownLayouts.get(s==null?void 0:s.toLowerCase());if(v===void 0)throw"No builtin map theme with name "+s+" exists";return v}static LoadLayoutFromHash(n){var m,o;let s=location.hash.substr(1),e;const v=_.Get("user-layout-"+((m=n.data)==null?void 0:m.replace(" ","_")));((o=v.data)==null?void 0:o.length)<10&&v.setData(void 0);const l=_.Get("last-loaded-user-layout");s.length<10?s=v.data??l.data:(console.log("Saving hash to local storage"),l.setData(s),v.setData(s));try{e=JSON.parse(atob(s))}catch{e=JSON.parse(A.UnMinify(U.decompressFromBase64(s)))}const i=b.prepCustomTheme(e);return n.setData(i.id),i}static getSharedTagRenderings(){const n=new Map;for(const s of W.tagRenderings)n.set(s.id,s);return n}static prepCustomTheme(n,s,e){if(n.layers===void 0&&n.tagRenderings!==void 0){const o=n.pointRendering.map(p=>p.marker.find(a=>a.icon!==void 0).icon).find(p=>p!==void 0),r=new j(o).render.txt;n={id:n.id,description:n.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:r,title:n.name,layers:[n]}}const v=new Map;for(const m in B.layers){const o=B.layers[m];v.set(o.id,o)}const l={tagRenderings:b.getSharedTagRenderings(),sharedLayers:v,publicLayers:new Set};n=new ae().convertStrict(n);const i=n;return n=new $(b._knownImages).convertStrict(n),n.enableNoteImports=n.enableNoteImports??!1,n=new Q(l).convertStrict(n),console.log("The layoutconfig is ",n),n.id=e??n.id,new Z().convertStrict(n),new P(new q(new Set,m=>!0),"",!1).convertStrict(n),new G(n,!1,{definitionRaw:JSON.stringify(i,null,"  "),definedAtUrl:s})}static async LoadRemoteTheme(n){console.log("Downloading map theme from ",n),new O(`Downloading the theme from the <a href="${n}">link</a>...`).AttachTo("maindiv");let s=await A.downloadJson(n),e=s.id;const v=new URL(n);return v.hostname==="localhost"||v.hostname==="127.0.0.1"||(e=n),console.log("Loaded remote link:",n),b.prepCustomTheme(s,n,e)}};let k=b;C(k,"_knownImages",new Set(Array.from(V).map(n=>n.path))),C(k,"loadCustomThemeParam",M.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));function se(){try{var g=document.createElement("canvas");return!!window.WebGLRenderingContext&&(g.getContext("webgl")||g.getContext("experimental-webgl"))}catch{return!1}}try{if(!se())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";k.GetLayout().then(g=>{const n=new F(g);new ee(I,{state:n}).AttachTo("maindiv")}).catch(g=>{console.error("Error while initializing: ",g,g.stack),new J([new O(g).SetClass("block alert"),new ne(te.download_svg(),"Download the raw file").onClick(()=>A.offerContentsAsDownloadableFile(k.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"}))]).AttachTo("maindiv")})}catch(g){new O(g).SetClass("block alert").AttachTo("maindiv")}
