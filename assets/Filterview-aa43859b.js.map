{"version":3,"file":"Filterview-aa43859b.js","sources":["../../src/UI/BigComponents/FilterviewWithFields.svelte","../../src/UI/BigComponents/Filterview.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import FilteredLayer from \"../../Models/FilteredLayer\"\n  import type { FilterConfigOption } from \"../../Models/ThemeConfig/FilterConfig\"\n  import Locale from \"../i18n/Locale\"\n  import ValidatedInput from \"../InputElement/ValidatedInput.svelte\"\n  import { UIEventSource } from \"../../Logic/UIEventSource\"\n  import { onDestroy } from \"svelte\"\n  import { Utils } from \"../../Utils\"\n  import Tr from \"../Base/Tr.svelte\"\n\n  export let filteredLayer: FilteredLayer\n  export let option: FilterConfigOption\n  export let id: string\n  let parts: ({ message: string } | { subs: string })[]\n  let language = Locale.language\n  $: {\n    const template = option.question.textFor($language)\n    parts = Utils.splitIntoSubstitutionParts(template)\n  }\n  let fieldValues: Record<string, UIEventSource<string>> = {}\n  let fieldTypes: Record<string, string> = {}\n  let appliedFilter = <UIEventSource<string>>filteredLayer.appliedFilters.get(id)\n  let initialState: Record<string, string> = JSON.parse(appliedFilter?.data ?? \"{}\")\n\n  function setFields() {\n    const properties: Record<string, string> = {}\n    for (const key in fieldValues) {\n      const v = fieldValues[key].data\n      if (v === undefined) {\n        properties[key] = undefined\n      } else {\n        properties[key] = v\n      }\n    }\n    appliedFilter?.setData(FilteredLayer.fieldsToString(properties))\n  }\n\n  for (const field of option.fields) {\n    // A bit of cheating: the 'parts' will have '}' suffixed for fields\n    const src = new UIEventSource<string>(initialState[field.name] ?? \"\")\n    fieldTypes[field.name] = field.type\n    fieldValues[field.name] = src\n    onDestroy(\n      src.stabilized(200).addCallback(() => {\n        setFields()\n      })\n    )\n  }\n</script>\n\n<div>\n  {#each parts as part, i}\n    {#if part[\"subs\"]}\n      <!-- This is a field! -->\n      <span class=\"mx-1\">\n        <ValidatedInput value={fieldValues[part[\"subs\"]]} type={fieldTypes[part[\"subs\"]]} />\n      </span>\n    {:else}\n      {@html part[\"message\"]}\n    {/if}\n  {/each}\n</div>\n","<script lang=\"ts\">\n  /**\n   * The FilterView shows the various options to enable/disable a single layer or to only show a subset of the data.\n   */\n  import type FilteredLayer from \"../../Models/FilteredLayer\"\n  import LayerConfig from \"../../Models/ThemeConfig/LayerConfig\"\n  import ToSvelte from \"../Base/ToSvelte.svelte\"\n  import Checkbox from \"../Base/Checkbox.svelte\"\n  import FilterConfig from \"../../Models/ThemeConfig/FilterConfig\"\n  import If from \"../Base/If.svelte\"\n  import Dropdown from \"../Base/Dropdown.svelte\"\n  import { ImmutableStore, Store, UIEventSource } from \"../../Logic/UIEventSource\"\n  import FilterviewWithFields from \"./FilterviewWithFields.svelte\"\n  import Tr from \"../Base/Tr.svelte\"\n  import Translations from \"../i18n/Translations\"\n\n  export let filteredLayer: FilteredLayer\n  export let highlightedLayer: Store<string | undefined> = new ImmutableStore(undefined)\n  export let zoomlevel: Store<number> = new ImmutableStore(22)\n  let layer: LayerConfig = filteredLayer.layerDef\n  let isDisplayed: UIEventSource<boolean> = filteredLayer.isDisplayed\n\n  /**\n   * Gets a UIEventSource as boolean for the given option, to be used with a checkbox\n   */\n  function getBooleanStateFor(option: FilterConfig): UIEventSource<boolean> {\n    const state = filteredLayer.appliedFilters.get(option.id)\n    return state.sync(\n      (f) => f === 0,\n      [],\n      (b) => (b ? 0 : undefined)\n    )\n  }\n\n  /**\n   * Gets a UIEventSource as number for the given option, to be used with a dropdown or radiobutton\n   */\n  function getStateFor(option: FilterConfig): UIEventSource<number | string> {\n    return filteredLayer.appliedFilters.get(option.id)\n  }\n</script>\n\n{#if filteredLayer.layerDef.name}\n  <div class:focus={$highlightedLayer === filteredLayer.layerDef.id} class=\"mb-1.5\">\n    <Checkbox selected={isDisplayed}>\n      <div class=\"no-image-background block h-6 w-6\" class:opacity-50={!$isDisplayed}>\n        <ToSvelte construct={() => layer.defaultIcon()} />\n      </div>\n\n      <Tr t={filteredLayer.layerDef.name} />\n\n      {#if $zoomlevel < layer.minzoom}\n        <span class=\"alert\">\n          <Tr t={Translations.t.general.layerSelection.zoomInToSeeThisLayer} />\n        </span>\n      {/if}\n    </Checkbox>\n\n    {#if $isDisplayed && filteredLayer.layerDef.filters?.length > 0}\n      <div id=\"subfilters\" class=\"ml-4 flex flex-col gap-y-1\">\n        {#each filteredLayer.layerDef.filters as filter}\n          <div>\n            <!-- There are three (and a half) modes of filters: a single checkbox, a radio button/dropdown or with searchable fields -->\n            {#if filter.options.length === 1 && filter.options[0].fields.length === 0}\n              <Checkbox selected={getBooleanStateFor(filter)}>\n                <Tr t={filter.options[0].question} />\n              </Checkbox>\n            {/if}\n\n            {#if filter.options.length === 1 && filter.options[0].fields.length > 0}\n              <FilterviewWithFields id={filter.id} {filteredLayer} option={filter.options[0]} />\n            {/if}\n\n            {#if filter.options.length > 1}\n              <Dropdown value={getStateFor(filter)}>\n                {#each filter.options as option, i}\n                  <option value={i}>\n                    <Tr t={option.question} />\n                  </option>\n                {/each}\n              </Dropdown>\n            {/if}\n          </div>\n        {/each}\n      </div>\n    {/if}\n  </div>\n{/if}\n"],"names":["raw_value","ctx","dirty","html_tag","insert","target","span","anchor","i","div","each_blocks","filteredLayer","$$props","option","id","parts","language","Locale","fieldValues","fieldTypes","appliedFilter","initialState","setFields","properties","key","v","FilteredLayer","field","src","UIEventSource","onDestroy","template","$language","$$invalidate","Utils","_a","create_if_block_1","toggle_class","Translations","create_if_block_5","checkbox_changes","tr_changes","filterviewwithfields_changes","dropdown_changes","each_value_1","if_block0","create_if_block_4","if_block1","create_if_block_3","if_block2","create_if_block_2","create_if_block","highlightedLayer","ImmutableStore","zoomlevel","layer","isDisplayed","getBooleanStateFor","f","b","getStateFor","func"],"mappings":"unBA0DaA,EAAAC,MAAK,QAAS,6EAAdC,EAAA,GAAAF,KAAAA,EAAAC,MAAK,QAAS,KAAAE,EAAA,EAAAH,CAAA,4FAHIC,EAAW,CAAA,EAACA,EAAI,EAAA,EAAC,IAAM,OAAUA,EAAU,CAAA,EAACA,EAAI,EAAA,EAAC,IAAM,yEADhFG,EAEMC,EAAAC,EAAAC,CAAA,2DADmBN,EAAW,CAAA,EAACA,EAAI,EAAA,EAAC,IAAM,gBAAUA,EAAU,CAAA,EAACA,EAAI,EAAA,EAAC,IAAM,kKAH7E,OAAAA,MAAK,KAAM,+TADXA,EAAK,CAAA,uBAAV,OAAIO,GAAA,6HADRJ,EAWKC,EAAAI,EAAAF,CAAA,4EAVIN,EAAK,CAAA,oBAAV,OAAIO,GAAA,EAAA,yGAAJ,OAAIA,EAAAE,EAAA,OAAAF,GAAA,yCAAJ,OAAIA,GAAA,oIAzCK,cAAAG,CAAA,EAAAC,GACA,OAAAC,CAAA,EAAAD,GACA,GAAAE,CAAA,EAAAF,EACPG,EACAC,EAAWC,GAAO,iCAKlBC,EAAA,CAAA,EACAC,EAAA,CAAA,EACAC,EAAuCT,EAAc,eAAe,IAAIG,CAAE,EAC1EO,EAAuC,KAAK,OAAMD,GAAA,YAAAA,EAAe,OAAQ,IAAI,WAExEE,GAAA,OACDC,EAAA,CAAA,EACK,UAAAC,KAAON,EAAA,CACV,MAAAO,EAAIP,EAAYM,CAAG,EAAE,KACvBC,WACFF,EAAWC,CAAG,EAAA,OAEdD,EAAWC,CAAG,EAAIC,EAGtBL,GAAA,MAAAA,EAAe,QAAQM,GAAc,eAAeH,CAAU,aAGrDI,KAASd,EAAO,OAAA,OAEnBe,EAAA,IAAUC,GAAsBR,EAAaM,EAAM,IAAI,GAAK,EAAE,EACpER,EAAWQ,EAAM,IAAI,EAAIA,EAAM,KAC/BT,EAAYS,EAAM,IAAI,EAAIC,EAC1BE,GACEF,EAAI,WAAW,GAAG,EAAE,YAAA,IAAA,CAClBN,8JA7BN,CACQ,MAAAS,EAAWlB,EAAO,SAAS,QAAQmB,CAAS,EAClDC,EAAA,EAAAlB,EAAQmB,GAAM,2BAA2BH,CAAQ,CAAA,qSC2B7B9B,EAAW,CAAA,kDAc1BA,EAAY,CAAA,KAAIkC,EAAAlC,EAAc,CAAA,EAAA,SAAS,UAAvB,YAAAkC,EAAgC,QAAS,GAACC,EAAAnC,CAAA,8EAf/CoC,EAAA5B,EAAA,QAAAR,EAAsB,CAAA,IAAAA,EAAc,CAAA,EAAA,SAAS,EAAE,UAAjEG,EA2CKC,EAAAI,EAAAF,CAAA,kHA5BEN,EAAY,CAAA,KAAIkC,EAAAlC,EAAc,CAAA,EAAA,SAAS,UAAvB,YAAAkC,EAAgC,QAAS,4GAf9CE,EAAA5B,EAAA,QAAAR,EAAsB,CAAA,IAAAA,EAAc,CAAA,EAAA,SAAS,EAAE,0JAUlD,EAAAqC,GAAa,EAAE,QAAQ,eAAe,uFAD/ClC,EAEMC,EAAAC,EAAAC,CAAA,oMALDN,EAAa,CAAA,EAAC,SAAS,cAEzBA,EAAU,CAAA,EAAGA,EAAK,CAAA,EAAC,SAAOsC,EAAA,wJANmCtC,EAAY,CAAA,CAAA,UAA9EG,EAEKC,EAAAI,EAAAF,CAAA,yGAF6DN,EAAY,CAAA,CAAA,uBAIvEA,EAAa,CAAA,EAAC,SAAS,gBAEzBA,EAAU,CAAA,EAAGA,EAAK,CAAA,EAAC,qTASfA,EAAa,CAAA,EAAC,SAAS,6BAA5B,OAAIO,GAAA,8LADRJ,EAyBKC,EAAAI,EAAAF,CAAA,4EAxBIN,EAAa,CAAA,EAAC,SAAS,0BAA5B,OAAIO,GAAA,EAAA,yGAAJ,OAAIA,EAAAE,EAAA,OAAAF,GAAA,yCAAJ,OAAIA,GAAA,wJAIoB,SAAAP,KAAmBA,EAAM,EAAA,CAAA,2GAAzBC,EAAA,IAAAsC,EAAA,SAAAvC,KAAmBA,EAAM,EAAA,CAAA,iLACpC,EAAAA,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,2EAAlBC,EAAA,IAAAuC,EAAA,EAAAxC,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,kJAKD,GAAAA,MAAO,6BAA4BA,EAAM,EAAA,EAAC,QAAQ,CAAC,oEAAnDC,EAAA,IAAAwC,EAAA,GAAAzC,MAAO,+CAA4BA,EAAM,EAAA,EAAC,QAAQ,CAAC,2IAI5D,MAAAA,KAAYA,EAAM,EAAA,CAAA,2GAAlBC,EAAA,IAAAyC,EAAA,MAAA1C,KAAYA,EAAM,EAAA,CAAA,6KAGtB,MAAA,CAAA,EAAAA,MAAO,QAAQ,wDADTA,EAAC,EAAA,4BAAhBG,EAEQC,EAAAQ,EAAAN,CAAA,6CADCL,EAAA,IAAAuC,EAAA,EAAAxC,MAAO,iIAFX2C,EAAA3C,MAAO,6BAAZ,OAAIO,GAAA,oMAACoC,EAAA3C,MAAO,0BAAZ,OAAIO,GAAA,EAAA,iHAAJ,OAAIA,EAAAE,EAAA,OAAAF,GAAA,yCAAJ,OAAIA,GAAA,sIAZLqC,EAAA5C,MAAO,QAAQ,SAAW,GAAKA,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,OAAO,SAAW,GAAC6C,EAAA7C,CAAA,EAMpE8C,EAAA9C,MAAO,QAAQ,SAAW,GAAKA,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,OAAO,OAAS,GAAC+C,EAAA/C,CAAA,EAIlEgD,EAAAhD,EAAO,EAAA,EAAA,QAAQ,OAAS,GAACiD,EAAAjD,CAAA,6EAZhCG,EAqBKC,EAAAI,EAAAF,CAAA,iFAnBEN,MAAO,QAAQ,SAAW,GAAKA,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,OAAO,SAAW,6FAMnEA,MAAO,QAAQ,SAAW,GAAKA,EAAO,EAAA,EAAA,QAAQ,CAAC,EAAE,OAAO,OAAS,6FAIjEA,EAAO,EAAA,EAAA,QAAQ,OAAS,0NA/BpCA,EAAa,CAAA,EAAC,SAAS,MAAIkD,EAAAlD,CAAA,wEAA3BA,EAAa,CAAA,EAAC,SAAS,iVA1Bf,cAAAU,CAAA,EAAAC,GACA,iBAAAwC,EAAA,IAAkDC,EAAA,MAAwB,CAAA,EAAAzC,UAC1E,UAAA0C,EAAA,IAA+BD,EAAe,EAAE,CAAA,EAAAzC,UACvD2C,EAAqB5C,EAAc,SACnC6C,EAAsC7C,EAAc,gCAK/C,SAAA8C,EAAmB5C,EAAA,CAEnB,OADOF,EAAc,eAAe,IAAIE,EAAO,EAAE,EAC3C,KACV6C,GAAMA,IAAM,EAAA,GAEZC,GAAOA,EAAI,QAAI,EAOX,SAAAC,EAAY/C,EAAA,CACZ,OAAAF,EAAc,eAAe,IAAIE,EAAO,EAAE,EAQlB,MAAAgD,GAAA,IAAAN,EAAM"}