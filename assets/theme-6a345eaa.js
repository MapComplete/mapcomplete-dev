var F=Object.defineProperty;var I=(h,t,l)=>t in h?F(h,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):h[t]=l;var C=(h,t,l)=>(I(h,typeof t!="symbol"?t+"":t,l),l);import{U as A}from"./Utils-2916eb3d.js";import{T as G,a as J,D as H}from"./ThemeViewGUI-194b143e.js";import{L as N,S as W}from"./Checkbox-34ca865c.js";import{Q as M,H as Z,F as z,C as P}from"./Tr-3d83fc3c.js";import{J as Q,a2 as D}from"./preload-helper-0bf2a4d6.js";import{L as B}from"./LocalStorageSource-9ebd3b00.js";import{g as q}from"./_commonjsHelpers-de833af9.js";import{ab as K,ac as X,ad as Y,aa as E,l as $,a7 as j,ak as V}from"./SubtleLink-9b57cfdc.js";import{q as ee,a as te,c as ne,d as oe,D as ie}from"./questions-8fb56237.js";import{k as _}from"./index-303d939b.js";import{C as re}from"./Constants-cd9b8b66.js";import"./UIEventSource-f4363691.js";import"./OsmConnection-b3b3e8a9.js";import"./FeatureSwitchState-0b484c5d.js";import"./placeholder-72437d65.js";import"./index-44f7831e.js";import"./Loading-754af094.js";import"./tw-merge-2cd9e3ed.js";import"./MvtSource-78ebfba3.js";import"./Add-278231d8.js";import"./LanguagePicker-7db4bafe.js";import"./Dropdown-2718eea6.js";import"./Img-4e7131a7.js";import"./Community-87d096d4.js";import"./Filterview-ed3d025f.js";import"./PrivacyPolicy-e6bc5e55.js";import"./BackButton-7b62ed9f.js";import"./Login-a0a84fe8.js";var O={exports:{}};O.exports;(function(h){var t=function(){var l=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",c={};function i(n,r){if(!c[n]){c[n]={};for(var f=0;f<n.length;f++)c[n][n.charAt(f)]=f}return c[n][r]}var m={compressToBase64:function(n){if(n==null)return"";var r=m._compress(n,6,function(f){return e.charAt(f)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(n){return n==null?"":n==""?null:m._decompress(n.length,32,function(r){return i(e,n.charAt(r))})},compressToUTF16:function(n){return n==null?"":m._compress(n,15,function(r){return l(r+32)})+" "},decompressFromUTF16:function(n){return n==null?"":n==""?null:m._decompress(n.length,16384,function(r){return n.charCodeAt(r)-32})},compressToUint8Array:function(n){for(var r=m.compress(n),f=new Uint8Array(r.length*2),a=0,s=r.length;a<s;a++){var v=r.charCodeAt(a);f[a*2]=v>>>8,f[a*2+1]=v%256}return f},decompressFromUint8Array:function(n){if(n==null)return m.decompress(n);for(var r=new Array(n.length/2),f=0,a=r.length;f<a;f++)r[f]=n[f*2]*256+n[f*2+1];var s=[];return r.forEach(function(v){s.push(l(v))}),m.decompress(s.join(""))},compressToEncodedURIComponent:function(n){return n==null?"":m._compress(n,6,function(r){return T.charAt(r)})},decompressFromEncodedURIComponent:function(n){return n==null?"":n==""?null:(n=n.replace(/ /g,"+"),m._decompress(n.length,32,function(r){return i(T,n.charAt(r))}))},compress:function(n){return m._compress(n,16,function(r){return l(r)})},_compress:function(n,r,f){if(n==null)return"";var a,s,v={},b={},L="",x="",y="",S=2,w=3,u=2,g=[],o=0,p=0,d;for(d=0;d<n.length;d+=1)if(L=n.charAt(d),Object.prototype.hasOwnProperty.call(v,L)||(v[L]=w++,b[L]=!0),x=y+L,Object.prototype.hasOwnProperty.call(v,x))y=x;else{if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(a=0;a<u;a++)o=o<<1,p==r-1?(p=0,g.push(f(o)),o=0):p++;for(s=y.charCodeAt(0),a=0;a<8;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1}else{for(s=1,a=0;a<u;a++)o=o<<1|s,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=0;for(s=y.charCodeAt(0),a=0;a<16;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1}S--,S==0&&(S=Math.pow(2,u),u++),delete b[y]}else for(s=v[y],a=0;a<u;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1;S--,S==0&&(S=Math.pow(2,u),u++),v[x]=w++,y=String(L)}if(y!==""){if(Object.prototype.hasOwnProperty.call(b,y)){if(y.charCodeAt(0)<256){for(a=0;a<u;a++)o=o<<1,p==r-1?(p=0,g.push(f(o)),o=0):p++;for(s=y.charCodeAt(0),a=0;a<8;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1}else{for(s=1,a=0;a<u;a++)o=o<<1|s,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=0;for(s=y.charCodeAt(0),a=0;a<16;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1}S--,S==0&&(S=Math.pow(2,u),u++),delete b[y]}else for(s=v[y],a=0;a<u;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1;S--,S==0&&(S=Math.pow(2,u),u++)}for(s=2,a=0;a<u;a++)o=o<<1|s&1,p==r-1?(p=0,g.push(f(o)),o=0):p++,s=s>>1;for(;;)if(o=o<<1,p==r-1){g.push(f(o));break}else p++;return g.join("")},decompress:function(n){return n==null?"":n==""?null:m._decompress(n.length,32768,function(r){return n.charCodeAt(r)})},_decompress:function(n,r,f){var a=[],s=4,v=4,b=3,L="",x=[],y,S,w,u,g,o,p,d={val:f(0),position:r,index:1};for(y=0;y<3;y+=1)a[y]=y;for(w=0,g=Math.pow(2,2),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;switch(w){case 0:for(w=0,g=Math.pow(2,8),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;p=l(w);break;case 1:for(w=0,g=Math.pow(2,16),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;p=l(w);break;case 2:return""}for(a[3]=p,S=p,x.push(p);;){if(d.index>n)return"";for(w=0,g=Math.pow(2,b),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;switch(p=w){case 0:for(w=0,g=Math.pow(2,8),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;a[v++]=l(w),p=v-1,s--;break;case 1:for(w=0,g=Math.pow(2,16),o=1;o!=g;)u=d.val&d.position,d.position>>=1,d.position==0&&(d.position=r,d.val=f(d.index++)),w|=(u>0?1:0)*o,o<<=1;a[v++]=l(w),p=v-1,s--;break;case 2:return x.join("")}if(s==0&&(s=Math.pow(2,b),b++),a[p])L=a[p];else if(p===v)L=S+S.charAt(0);else return null;x.push(L),a[v++]=S+L.charAt(0),s--,S=L,s==0&&(s=Math.pow(2,b),b++)}}};return m}();h!=null&&(h.exports=t)})(O);var ae=O.exports;const k=q(ae);class se extends E{constructor(){super("Updates various attributes from the old data format to the new to provide backwards compatibility with the formats",["overpassTags","source.osmtags","tagRenderings[*].id","mapRendering"],"UpdateLegacyLayer")}convert(t,l){var T;if(typeof t=="string"||t.builtin!==void 0)return t;l=l.enter(t.id);let e={...t};e.overpassTags&&(e.source=e.source??{osmTags:e.overpassTags},e.source.osmTags=e.overpassTags,delete e.overpassTags);for(const c of e.presets??[]){const i=c.preciseInput;typeof i=="boolean"?delete c.preciseInput:i!==void 0&&(delete i.preferredBackground,c.snapToLayer=i.snapToLayer,delete i.snapToLayer,i.maxSnapDistance&&(c.maxSnapDistance=i.maxSnapDistance,delete i.maxSnapDistance),Object.keys(i).length==0&&delete c.preciseInput),typeof c.snapToLayer=="string"&&(c.snapToLayer=[c.snapToLayer])}if(e.tagRenderings!==void 0){let c=0;for(const i of e.tagRenderings)i&&(c++,!(typeof i=="string"||i.builtin!==void 0||i.rewrite!==void 0)&&i.id===void 0&&(i["#"]!==void 0?(i.id=i["#"],delete i["#"]):((T=i.freeform)==null?void 0:T.key)!==void 0?i.id=e.id+"-"+i.freeform.key:i.id="tr-"+c))}if(e.mapRendering===void 0&&e.pointRendering===void 0&&e.lineRendering===void 0){e.mapRendering=[];let c=["point"],i=e.wayHandling??0;if(i!==0&&(c=["point","centroid"]),e.icon??e.label!==void 0){const m={icon:e.icon,iconBadges:e.iconOverlays,label:e.label,iconSize:e.iconSize,location:c,rotation:e.rotation};e.mapRendering.push(m)}if(i!==1){const m={color:e.color,width:e.width,dashArray:e.dashArray};Object.keys(m).length>0&&e.mapRendering.push(m)}if(e.mapRendering.length===0)throw"Could not convert the legacy theme into a new theme: no renderings defined for layer "+e.id}delete e.color,delete e.width,delete e.dashArray,delete e.icon,delete e.iconOverlays,delete e.label,delete e.iconSize,delete e.rotation,delete e.wayHandling,delete e.hideUnderlayingFeaturesMinPercentage;for(const c of e.mapRendering??[]){c.iconOverlays!==void 0&&(c.iconBadges=c.iconOverlays);for(const i of c.iconBadges??[])i.badge!==!0&&l.enters("iconBadges","badge").warn("Non-overlay element"),delete i.badge}if(e.mapRendering){const c=[],i=[];for(const m of e.mapRendering)m.location?c.push(m):i.push(m);e.pointRendering=c,e.lineRendering=i,delete e.mapRendering}for(const c of e.pointRendering??[]){const i=c;if(i.icon)try{let n=i.icon;Object.keys(n).length===1&&n.render!==void 0&&(n=n.render);const r=A.NoEmpty(n.split(";"));i.marker=r.map(f=>{if(f.startsWith("http"))return{icon:f};const[a,s]=f.split(":");return{icon:a,color:s}}),delete i.icon}catch{console.error("Could not handle icon in",t.id),i.marker=[{icon:i.icon}],delete i.icon}let m=i.iconSize;if(m&&(Object.keys(i.iconSize).length===1&&i.iconSize.render!==void 0&&(m=i.iconSize.render),typeof m=="string"&&["bottom","center","top"].some(n=>m.endsWith(n)))){const n=m.split(",").map(r=>r.toLowerCase().trim());i.anchor=n.pop(),i.iconSize=n.join(",")}}if(e.pointRendering)for(const c of e.pointRendering)for(const i in c)c[i]&&typeof c[i].render=="string"&&Object.keys(c[i]).length===1&&(c[i]=c[i].render);if(e.lineRendering)for(const c of e.lineRendering)for(const i in c)c[i]&&typeof c[i].render=="string"&&Object.keys(c[i]).length===1&&(c[i]=c[i].render);return e}}class le extends E{constructor(){super("Small fixes in the theme config",["roamingRenderings"],"UpdateLegacyTheme")}convert(t,l){const e={...t};if(e.socialImage===""&&delete e.socialImage,typeof e.credits=="string"&&(e.credits=[e.credits]),e.roamingRenderings!==void 0)if(e.roamingRenderings.length==0)delete e.roamingRenderings;else return l.err("The theme contains roamingRenderings. These are not supported anymore"),null;return e.layers=A.NoNull(e.layers),delete e.language,delete e.version,delete e.clustering,e.startLat===0&&delete e.startLat,e.startLon===0&&delete e.startLon,e.startZoom<=2&&delete e.startZoom,e.maintainer!==void 0&&(e.credits===void 0?(e.credits=e.maintainer,delete e.maintainer):(e.maintainer.toLowerCase().trim()==="mapcomplete"||e.maintainer.toLowerCase().trim()==="")&&delete e.maintainer),e}}class ce extends K{constructor(){super("Fixes a legacy theme to the modern JSON format geared to humans. Syntactic sugars are kept (i.e. no tagRenderings are expandend, no dependencies are automatically gathered)",new le,new X("layers",new Y(new se)))}}const R=class R{static getCustomDefinition(){const t=decodeURIComponent(R.loadCustomThemeParam.data);if(t.startsWith("http"))return t;if(t!=="false"){const l=Z.hash.data;try{return JSON.parse(atob(l)),atob(l)}catch{return JSON.parse(A.UnMinify(k.decompressFromBase64(l))),A.UnMinify(k.decompressFromBase64(l))}}}static async GetLayout(){const t=decodeURIComponent(R.loadCustomThemeParam.data);if(t.startsWith("http"))return await R.LoadRemoteTheme(t);if(t!=="false")return R.LoadLayoutFromHash(R.loadCustomThemeParam);let l;const e=window.location.pathname.split("/").slice(-1)[0];e!=="theme.html"&&e!==""&&(l=e,e.endsWith(".html")&&(l=e.substr(0,e.length-5)),console.log("Using layout",l)),l=M.GetQueryParameter("layout",l,"The layout to load into MapComplete").data;const T=Q.allKnownLayouts.get(l==null?void 0:l.toLowerCase());if(T===void 0)throw"No builtin map theme with name "+l+" exists";return T}static LoadLayoutFromHash(t){var m,n;let l=location.hash.substr(1),e;const T=B.Get("user-layout-"+((m=t.data)==null?void 0:m.replace(" ","_")));((n=T.data)==null?void 0:n.length)<10&&T.setData(void 0);const c=B.Get("last-loaded-user-layout");l.length<10?l=T.data??c.data:(console.log("Saving hash to local storage"),c.setData(l),T.setData(l));try{e=JSON.parse(atob(l))}catch{e=JSON.parse(A.UnMinify(k.decompressFromBase64(l)))}const i=R.prepCustomTheme(e);return t.setData(i.id),i}static getSharedTagRenderings(){const t=new Map;for(const l of ee.tagRenderings)t.set(l.id,l);return t}static prepCustomTheme(t,l,e){if(t.layers===void 0&&t.tagRenderings!==void 0){const n=t.pointRendering.map(f=>{var a,s;return(s=(a=f==null?void 0:f.marker)==null?void 0:a.find(v=>v.icon!==void 0))==null?void 0:s.icon}).find(f=>f!==void 0)??"bug",r=new j(n).render.txt;t={id:t.id,description:t.description,descriptionTail:{en:"<div class='alert'>Layer only mode.</div> The loaded custom theme actually isn't a custom theme, but only contains a layer."},icon:r,title:t.name,layers:[t]}}const T=new Map;for(const m in D.layers){const n=D.layers[m];T.set(n.id,n)}const c={tagRenderings:R.getSharedTagRenderings(),sharedLayers:T,publicLayers:new Set};t=new ce().convertStrict(t);const i=t;return t=new V(R._knownImages).convertStrict(t),t.enableNoteImports=t.enableNoteImports??!1,t=new te(c).convertStrict(t),console.log("The layoutconfig is ",t),t.id=e??t.id,new ne().convertStrict(t),new oe(new ie(new Set,m=>!0),"",!1).convertStrict(t),new N(t,!1,{definitionRaw:JSON.stringify(i,null,"  "),definedAtUrl:l})}static async LoadRemoteTheme(t){console.log("Downloading map theme from ",t),new z(`Downloading the theme from the <a href="${t}">link</a>...`).AttachTo("maindiv");let l=await A.downloadJson(t),e=l.id;const T=new URL(t);return T.hostname==="localhost"||T.hostname==="127.0.0.1"||(e=t),console.log("Loaded remote link:",t),R.prepCustomTheme(l,t,e)}};C(R,"_knownImages",new Set(Array.from($).map(t=>t.path))),C(R,"loadCustomThemeParam",M.GetQueryParameter("userlayout","false",`If not 'false', a custom (non-official) theme is loaded. This custom layout can be done in multiple ways: 

- The hash of the URL contains a base64-encoded .json-file containing the theme definition
- The hash of the URL contains a lz-compressed .json-file, as generated by the custom theme generator
- The parameter itself is an URL, in which case that URL will be downloaded. It should point to a .json of a theme`));let U=R;function de(){try{const h=document.createElement("canvas");return!!window.WebGLRenderingContext&&(h.getContext("webgl")||h.getContext("experimental-webgl"))}catch{return!1}}async function fe(){try{const h=new URL(re.VectorTileServer).host,t=await A.downloadJson("https://"+h+"/summary/status.json");return new Set(t.layers)}catch(h){return console.error("Could not get MVT available layers due to",h),new Set}}async function pe(){try{if(!de())throw"WebGL is not supported or not enabled. This is essential for MapComplete to function, please enable this.";const[h,t]=await Promise.all([U.GetLayout(),await fe()]);console.log("The available layers on server are",Array.from(t));const l=new G(h,t);new _(J,{state:l}).AttachTo("maindiv")}catch(h){console.error("Error while initializing: ",h,h.stack);const t=U.getCustomDefinition();new P([new z(h).SetClass("block alert"),(t==null?void 0:t.length)>0?new W(new _(H),"Download the raw file").onClick(()=>A.offerContentsAsDownloadableFile(U.getCustomDefinition(),"mapcomplete-theme.json",{mimetype:"application/json"})):void 0]).AttachTo("maindiv")}}pe().then(h=>{});
//# sourceMappingURL=theme-6a345eaa.js.map
