{"version":3,"file":"OsmConnection-6f4c862d.js","sources":["../../node_modules/osm-auth/src/osm-auth.mjs","../../src/Logic/Osm/OsmPreferences.ts","../../src/Logic/Osm/OsmConnection.ts"],"sourcesContent":["\n/**\n * osmAuth\n * Easy authentication with OpenStreetMap over OAuth 2.0.\n * @module\n *\n * @param    o   `Object` containing options:\n * @param    o.scope          OAuth2 scopes requested (e.g. \"read_prefs write_api\")\n * @param    o.client_id      OAuth2 client ID\n * @param    o.redirect_uri   OAuth2 redirect URI (e.g. \"http://127.0.0.1:8080/land.html\")\n * @param    o.access_token   Can pre-authorize with an OAuth2 bearer token if you have one\n * @param    o.apiUrl         A base url for the OSM API (default: \"https://api.openstreetmap.org\")\n * @param    o.url            A base url for the OAuth2 handshake (default: \"https://www.openstreetmap.org\")\n * @param    o.auto           If `true`, attempt to authenticate automatically when calling `.xhr()` or `.fetch()` (default: `false`)\n * @param    o.singlepage     If `true`, use page redirection instead of a popup (default: `false`)\n * @param    o.loading        Function called when auth-related xhr calls start\n * @param    o.done           Function called when auth-related xhr calls end\n * @param    o.locale         The locale to use on the OAuth2 authentication page. Optional.\n * @return  `self`\n */\nexport function osmAuth(o) {\n  var oauth = {};\n\n  // Mock localStorage if needed.\n  // Note that accessing localStorage may throw a `SecurityError`, so wrap in a try/catch.\n  var _store = null;\n  try {\n    _store = window.localStorage;\n  } catch (e) {\n    var _mock = new Map();\n    _store = {\n      isMocked: true,\n      hasItem: (k) => _mock.has(k),\n      getItem: (k) => _mock.get(k),\n      setItem: (k, v) => _mock.set(k, v),\n      removeItem: (k) => _mock.delete(k),\n      clear: () => _mock.clear()\n    };\n  }\n\n  /**\n   * token\n   * Get/Set tokens. These are prefixed with the base URL so that `osm-auth`\n   * can be used with multiple APIs and the keys in `localStorage` will not clash\n   * @param  {string}   k  key\n   * @param  {string?}  v  value\n   * @return {string?}  If getting, returns the stored value or `null`.  If setting, returns `undefined`.\n   */\n  function token(k, v) {\n    var key = o.url + k;\n    if (arguments.length === 1) {\n      var val = _store.getItem(key) || '';\n      // Note: legacy tokens might be wrapped in double quotes - remove them, see #129\n      return val.replace(/\"/g, '');\n\n    } else if (arguments.length === 2) {\n      if (v) {\n        return _store.setItem(key, v);\n      } else {\n        return _store.removeItem(key);\n      }\n    }\n  }\n\n\n  /**\n   * authenticated\n   * Test whether the user is currently authenticated\n   *\n   * @return {boolean} `true` if authenticated, `false` if not\n   */\n  oauth.authenticated = function() {\n    return !!token('oauth2_access_token');\n  };\n\n\n  /**\n   * logout\n   * Removes any stored authentication tokens (legacy OAuth1 tokens too)\n   *\n   * @return  `self`\n   */\n  oauth.logout = function () {\n    token('oauth2_access_token', '');         // OAuth2\n    token('oauth_token', '');                 // OAuth1\n    token('oauth_token_secret', '');          // OAuth1\n    token('oauth_request_token_secret', '');  // OAuth1\n    return oauth;\n  };\n\n\n  /**\n   * authenticate\n   * First logs out, then runs the authentiation flow, finally calls the callback.\n   * TODO: detect lack of click event  (probably can settimeout it)\n   *\n   * @param   {function}  callback  Errback-style callback `(err, result)`, called when complete\n   * @return  none\n   */\n  oauth.authenticate = function(callback) {\n    if (oauth.authenticated()) {\n      callback(null, oauth);\n      return;\n    }\n\n    oauth.logout();\n\n    _preopenPopup(function(error, popup) {\n      if (error) {\n        callback(error);\n      } else {\n        _generatePkceChallenge(function(pkce) {\n          _authenticate(pkce, popup, callback);\n        });\n      }\n    });\n  };\n\n\n  /**\n   * authenticateAsync\n   * Promisified version of `authenticate`\n   * @return  {Promise}  Promise settled with whatever `_authenticate` did\n   */\n  oauth.authenticateAsync = function() {\n    if (oauth.authenticated()) {\n      return Promise.resolve(oauth);\n    }\n\n    oauth.logout();\n\n    return new Promise((resolve, reject) => {\n      var errback = (err, result) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(result);\n        }\n      };\n\n      _preopenPopup((error, popup) => {\n        if (error) {\n          errback(error);\n        } else {\n          _generatePkceChallenge(pkce => _authenticate(pkce, popup, errback));\n        }\n      });\n    });\n  };\n\n\n  /**\n   * opens an empty popup to be later used for the authentication page\n   * @param   {function}  callback  Errback-style callback `(err, result)`, called when complete\n   * @return  none\n   */\n  function _preopenPopup(callback) {\n    if (o.singlepage) {\n      callback(null, undefined);\n      return;\n    }\n\n    // Create a 550x610 popup window in the center of the screen\n    var w = 550;\n    var h = 610;\n    var settings = [\n        ['width', w],\n        ['height', h],\n        ['left', window.screen.width / 2 - w / 2],\n        ['top', window.screen.height / 2 - h / 2],\n      ]\n      .map(function (x) { return x.join('='); })\n      .join(',');\n    var popup = window.open('about:blank', 'oauth_window', settings);\n    if (popup) {\n      callback(null, popup);\n    } else {\n      var error = new Error('Popup was blocked');\n      error.status = 'popup-blocked';\n      callback(error);\n    }\n  }\n\n\n  /**\n   * _authenticate\n   * internal authenticate\n   *\n   * @param  {Object}    pkce      Object containing PKCE code challenge properties\n   * @param  {Window}    popup     Popup Window to use for the authentication page, should be undefined when using singlepage mode\n   * @param  {function}  callback  Errback-style callback that accepts `(err, result)`\n   */\n  function _authenticate(pkce, popup, callback) {\n    var state = generateState();\n\n    // ## Request authorization to access resources from the user\n    // and receive authorization code\n    var url =\n      o.url +\n      '/oauth2/authorize?' +\n      utilQsString({\n        client_id: o.client_id,\n        redirect_uri: o.redirect_uri,\n        response_type: 'code',\n        scope: o.scope,\n        state: state,\n        code_challenge: pkce.code_challenge,\n        code_challenge_method: pkce.code_challenge_method,\n        locale: o.locale || '',\n      });\n\n    if (o.singlepage) {\n      if (_store.isMocked) {\n        // in singlepage mode, PKCE requires working non-volatile storage\n        var error = new Error('localStorage unavailable, but required in singlepage mode');\n        error.status = 'pkce-localstorage-unavailable';\n        callback(error);\n        return;\n      }\n      var params = utilStringQs(window.location.search.slice(1));\n      if (params.code) {\n        oauth.bootstrapToken(params.code, callback);\n      } else {\n        // save OAuth2 state and PKCE challenge in local storage, for later use\n        // in the `/oauth/token` request\n        token('oauth2_state', state);\n        token('oauth2_pkce_code_verifier', pkce.code_verifier);\n        window.location = url;\n      }\n    } else {\n      oauth.popupWindow = popup;\n      popup.location = url;\n    }\n\n    // Called by a function in the redirect URL page, in the popup window. The\n    // window closes itself.\n    window.authComplete = function (url) {\n      var params = utilStringQs(url.split('?')[1]);\n      if (params.state !== state) {\n        var error = new Error('Invalid state');\n        error.status = 'invalid-state';\n        callback(error);\n        return;\n      }\n      _getAccessToken(params.code, pkce.code_verifier, accessTokenDone);\n      delete window.authComplete;\n    };\n\n    function accessTokenDone(err, xhr) {\n      o.done();\n      if (err) {\n        callback(err);\n        return;\n      }\n      var access_token = JSON.parse(xhr.response);\n      token('oauth2_access_token', access_token.access_token);\n      callback(null, oauth);\n    }\n  }\n\n\n  /**\n   * _getAccessToken\n   * The client requests an access token by authenticating with the\n   * authorization server and presenting the `auth_code`, brought\n   * in from a function call on a landing page popup.\n   * @param  {string}    auth_code\n   * @param  {string}    code_verifier\n   * @param  {function}  accessTokenDone  Errback-style callback `(err, result)`, called when complete\n   */\n  function _getAccessToken(auth_code, code_verifier, accessTokenDone) {\n    var url =\n      o.url +\n      '/oauth2/token?' +\n      utilQsString({\n        client_id: o.client_id,\n        redirect_uri: o.redirect_uri,\n        grant_type: 'authorization_code',\n        code: auth_code,\n        code_verifier: code_verifier\n      });\n\n    // The authorization server authenticates the client and validates\n    // the authorization grant, and if valid, issues an access token.\n    oauth.rawxhr('POST', url, null, null, null, accessTokenDone);\n    o.loading();\n  }\n\n\n  /**\n   * bringPopupWindowToFront\n   * Tries to bring an existing authentication popup to the front.\n   *\n   * @return {boolean} `true` if it succeeded, `false` if not\n   */\n  oauth.bringPopupWindowToFront = function() {\n    var broughtPopupToFront = false;\n    try {\n      // This may cause a cross-origin error:\n      // `DOMException: Blocked a frame with origin \"...\" from accessing a cross-origin frame.`\n      if (oauth.popupWindow && !oauth.popupWindow.closed) {\n        oauth.popupWindow.focus();\n        broughtPopupToFront = true;\n      }\n    } catch (err) {\n      // Bringing popup window to front failed (probably because of the cross-origin error mentioned above)\n    }\n    return broughtPopupToFront;\n  };\n\n\n  /**\n   * bootstrapToken\n   * The authorization code is a temporary code that a client can exchange for an access token.\n   * If using this library in single-page mode, you'll need to call this once your application\n   * has an `auth_code` and wants to get an access_token.\n   *\n   * @param   {string}   auth_code  The OAuth2 `auth_code`\n   * @param   {function} callback   Errback-style callback `(err, result)`, called when complete\n   * @return  none\n   */\n  oauth.bootstrapToken = function(auth_code, callback) {\n    var state = token('oauth2_state');\n    token('oauth2_state', '');\n    var params = utilStringQs(window.location.search.slice(1));\n    if (params.state !== state) {\n      var error = new Error('Invalid state');\n      error.status = 'invalid-state';\n      callback(error);\n      return;\n    }\n    var code_verifier = token('oauth2_pkce_code_verifier');\n    token('oauth2_pkce_code_verifier', '');\n    _getAccessToken(auth_code, code_verifier, accessTokenDone);\n\n    function accessTokenDone(err, xhr) {\n      o.done();\n      if (err) {\n        callback(err);\n        return;\n      }\n      var access_token = JSON.parse(xhr.response);\n      token('oauth2_access_token', access_token.access_token);\n      callback(null, oauth);\n    }\n  };\n\n\n  /**\n   * fetch\n   * A `fetch` wrapper that includes the Authorization header if the user is authenticated.\n   * https://developer.mozilla.org/en-US/docs/Web/API/fetch\n   *\n   * @param  {string}   resource    Resource passed to `fetch`\n   * @param  {Object}   options     Options passed to `fetch`\n   * @return {Promise}  Promise that wraps `authenticateAsync` then `fetch`\n   */\n  oauth.fetch = function(resource, options) {\n    if (oauth.authenticated()) {\n      return _doFetch();\n    } else {\n      if (o.auto) {\n        return oauth.authenticateAsync().then(_doFetch);\n      } else {\n        return Promise.reject(new Error('not authenticated'));\n      }\n    }\n\n    function _doFetch() {\n      options = options || {};\n      if (!options.headers) {\n        options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };\n      }\n      options.headers.Authorization = 'Bearer ' + token('oauth2_access_token');\n      return fetch(resource, options);\n    }\n  };\n\n\n  /**\n   * xhr\n   * A `XMLHttpRequest` wrapper that does authenticated calls if the user has logged in.\n   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest\n   *\n   * @param   {Object} options\n   * @param    options.method   Passed to `xhr.open`  (e.g. 'GET', 'POST')\n   * @param    options.prefix   If `true` path contains a path, if `false` path contains the full url\n   * @param    options.path     The URL path (e.g. \"/api/0.6/user/details\") (or full url, if `prefix`=`false`)\n   * @param    options.content  Passed to `xhr.send`\n   * @param    options.headers  `Object` containing request headers\n   * @param   {function}         callback  Errback-style callback `(err, result)`, called when complete\n   * @return  {XMLHttpRequest}  `XMLHttpRequest` if authenticated, otherwise `null`\n   */\n  oauth.xhr = function (options, callback) {\n    if (oauth.authenticated()) {\n      return _doXHR();\n    } else {\n      if (o.auto) {\n        oauth.authenticate(_doXHR);\n        return;\n      } else {\n        callback('not authenticated', null);\n        return;\n      }\n    }\n\n    function _doXHR() {\n      var url = options.prefix !== false ? (o.apiUrl + options.path) : options.path;\n      return oauth.rawxhr(\n        options.method,\n        url,\n        token('oauth2_access_token'),\n        options.content,\n        options.headers,\n        done\n      );\n    }\n\n    function done(err, xhr) {\n      if (err) {\n        callback(err);\n      } else if (xhr.responseXML) {\n        callback(err, xhr.responseXML);\n      } else {\n        callback(err, xhr.response);\n      }\n    }\n  };\n\n\n  /**\n   * rawxhr\n   * Creates the XMLHttpRequest set up with a header and response handling\n   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest\n   *\n   * @param    method         Passed to `xhr.open`  (e.g. 'GET', 'POST')\n   * @param    url            Passed to `xhr.open`\n   * @param    access_token   OAuth2 bearer token\n   * @param    data           Passed to `xhr.send`\n   * @param    headers        `Object` containing request headers\n   * @param    callback       An \"errback\"-style callback (`err`, `result`), called when complete\n   * @return  `XMLHttpRequest`\n   */\n  oauth.rawxhr = function(method, url, access_token, data, headers, callback) {\n    headers = headers || { 'Content-Type': 'application/x-www-form-urlencoded' };\n\n    if (access_token) {\n      headers.Authorization = 'Bearer ' + access_token;\n    }\n\n    var xhr = new XMLHttpRequest();\n\n    xhr.onreadystatechange = function () {\n      if (4 === xhr.readyState && 0 !== xhr.status) {\n        if (/^20\\d$/.test(xhr.status)) {   // a 20x status code - OK\n          callback(null, xhr);\n        } else {\n          callback(xhr, null);\n        }\n      }\n    };\n    xhr.onerror = function (e) {\n      callback(e, null);\n    };\n\n    xhr.open(method, url, true);\n    for (var h in headers) xhr.setRequestHeader(h, headers[h]);\n\n    xhr.send(data);\n    return xhr;\n  };\n\n\n  /**\n   * preauth\n   * Pre-authorize this object, if we already have access token from the start\n   *\n   * @param   {Object}  val  Object containing `access_token` property\n   * @return  `self`\n   */\n  oauth.preauth = function(val) {\n    if (val && val.access_token) {\n      token('oauth2_access_token', val.access_token);\n    }\n    return oauth;\n  };\n\n\n  /**\n   * options  (getter / setter)\n   * If passed with no arguments, just return the options\n   * If passed an Object, set the options then attempt to pre-authorize\n   *\n   * @param   val?   Object containing options\n   * @return  current `options` (if getting), or `self` (if setting)\n   */\n  oauth.options = function(val) {\n    if (!arguments.length) return o;\n\n    o = val;\n    o.apiUrl = o.apiUrl || 'https://api.openstreetmap.org';\n    o.url = o.url || 'https://www.openstreetmap.org';\n    o.auto = o.auto || false;\n    o.singlepage = o.singlepage || false;\n\n    // Optional loading and loading-done functions for nice UI feedback.\n    // by default, no-ops\n    o.loading = o.loading || function () {};\n    o.done = o.done || function () {};\n    return oauth.preauth(o);\n  };\n\n\n  // Everything below here is initialization/setup code\n  // Handle options and attempt to pre-authorize\n  oauth.options(o);\n\n  return oauth;\n}\n\n\n/**\n * utilQsString\n * Transforms object of `key=value` pairs into query string\n * @param   {Object}  Object of `key=value` pairs\n * @returns {string}  query string\n */\nfunction utilQsString(obj) {\n  return Object.keys(obj)\n    .filter(function(key) {\n      return obj[key] !== undefined;\n    })\n    .sort()\n    .map(function(key) {\n      return (encodeURIComponent(key) + '=' + encodeURIComponent(obj[key]));\n    })\n    .join('&');\n}\n\n/**\n * utilStringQs\n * Transforms query string into object of `key=value` pairs\n * @param   {string}  query string\n * @returns {Object}  Object of `key=value` pairs\n */\nfunction utilStringQs(str) {\n  var i = 0; // advance past any leading '?' or '#' characters\n  while (i < str.length && (str[i] === '?' || str[i] === '#')) i++;\n  str = str.slice(i);\n\n  return str.split('&').reduce(function(obj, pair) {\n    var parts = pair.split('=');\n    if (parts.length === 2) {\n      obj[parts[0]] = decodeURIComponent(parts[1]);\n    }\n    return obj;\n  }, {});\n}\n\n\n/**\n * supportsWebCryptoAPI\n * https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API\n * @returns {boolean}  `true` if WebCryptoAPI is available\n */\nfunction supportsWebCryptoAPI() {\n  return window && window.crypto\n    && window.crypto.getRandomValues\n    && window.crypto.subtle\n    && window.crypto.subtle.digest;\n}\n\n\n/**\n * Generates a challenge/verifier pair for PKCE.\n * If the browser does not support the WebCryptoAPI, the \"plain\" method is\n * used as a fallback instead of a SHA-256 hash.\n * @param {callback} callback called with the result of the generated PKCE challenge\n */\nfunction _generatePkceChallenge(callback) {\n  var code_verifier;\n  if (supportsWebCryptoAPI()) {\n    // generate a random code_verifier\n    // https://datatracker.ietf.org/doc/html/rfc7636#section-7.1\n    var random = window.crypto.getRandomValues(new Uint8Array(32));\n    code_verifier = base64(random.buffer);\n    var verifier = Uint8Array.from(Array.from(code_verifier).map(function(char) {\n      return char.charCodeAt(0);\n    }));\n\n    // generate challenge for code verifier\n    window.crypto.subtle.digest('SHA-256', verifier).then(function(hash) {\n      var code_challenge = base64(hash);\n\n      callback({\n        code_challenge: code_challenge,\n        code_verifier: code_verifier,\n        code_challenge_method: 'S256'\n      });\n    });\n  } else {\n    // browser does not support Web Crypto API (e.g. IE11) -> fall back to \"plain\" method\n    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';\n    code_verifier = '';\n    for (var i=0; i<64; i++) {\n      code_verifier += chars[Math.floor(Math.random() * chars.length)];\n    }\n    callback({\n      code_verifier: code_verifier,\n      code_challenge: code_verifier,\n      code_challenge_method: 'plain',\n    });\n  }\n}\n\n\n/**\n * Returns a random state to be used as the \"state\" of the OAuth2 authentication\n * See https://datatracker.ietf.org/doc/html/rfc6749#section-10.12\n */\nfunction generateState() {\n  var state;\n  if (supportsWebCryptoAPI()) {\n    var random = window.crypto.getRandomValues(new Uint8Array(32));\n    state = base64(random.buffer);\n  } else {\n    // browser does not support Web Crypto API (e.g. IE11) -> fall back to \"plain\" method\n    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';\n    state = '';\n    for (var i=0; i<64; i++) {\n      state += chars[Math.floor(Math.random() * chars.length)];\n    }\n  }\n  return state;\n}\n\n\n/**\n * base64\n * Converts binary buffer to base64 encoded string, as used in rfc7636\n * @param    {ArrayBuffer}  buffer\n * @returns  {string}       base64 encoded\n */\nfunction base64(buffer) {\n  return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))\n    .replace(/\\//g, '_')\n    .replace(/\\+/g, '-')\n    .replace(/[=]/g, '');\n}\n","import { UIEventSource } from \"../UIEventSource\"\nimport UserDetails, { OsmConnection } from \"./OsmConnection\"\nimport { Utils } from \"../../Utils\"\nimport { LocalStorageSource } from \"../Web/LocalStorageSource\"\n// @ts-ignore\nimport { osmAuth } from \"osm-auth\"\nimport OSMAuthInstance = OSMAuth.OSMAuthInstance\n\nexport class OsmPreferences {\n    /**\n     * A dictionary containing all the preferences. The 'preferenceSources' will be initialized from this\n     * We keep a local copy of them, to init mapcomplete with the previous choices and to be able to get the open changesets right away\n     */\n    public preferences = LocalStorageSource.GetParsed<Record<string, string>>(\n        \"all-osm-preferences\",\n        {}\n    )\n    /**\n     * A map containing the individual preference sources\n     * @private\n     */\n    private readonly preferenceSources = new Map<string, UIEventSource<string>>()\n    private readonly auth: OSMAuthInstance\n    private userDetails: UIEventSource<UserDetails>\n    private longPreferences = {}\n    private readonly _fakeUser: boolean\n\n    constructor(auth: OSMAuthInstance, osmConnection: OsmConnection, fakeUser: boolean = false) {\n        this.auth = auth\n        this._fakeUser = fakeUser\n        this.userDetails = osmConnection.userDetails\n        osmConnection.OnLoggedIn(() => {\n            this.UpdatePreferences(true)\n            return true\n        })\n    }\n\n    /**\n     * OSM preferences can be at most 255 chars\n     * @param key\n     * @param prefix\n     * @constructor\n     */\n    public GetLongPreference(key: string, prefix: string = \"mapcomplete-\"): UIEventSource<string> {\n        if (this.longPreferences[prefix + key] !== undefined) {\n            return this.longPreferences[prefix + key]\n        }\n\n        const source = new UIEventSource<string>(undefined, \"long-osm-preference:\" + prefix + key)\n        this.longPreferences[prefix + key] = source\n\n        const allStartWith = prefix + key + \"-combined\"\n        const subOptions = { prefix: \"\" }\n        // Gives the number of combined preferences\n        const length = this.GetPreference(allStartWith + \"-length\", \"\", subOptions)\n\n        if ((allStartWith + \"-length\").length > 255) {\n            throw (\n                \"This preference key is too long, it has \" +\n                key.length +\n                \" characters, but at most \" +\n                (255 - \"-length\".length - \"-combined\".length - prefix.length) +\n                \" characters are allowed\"\n            )\n        }\n\n        const self = this\n        source.addCallback((str) => {\n            if (str === undefined || str === \"\") {\n                return\n            }\n            if (str === null) {\n                console.error(\"Deleting \" + allStartWith)\n                let count = parseInt(length.data)\n                for (let i = 0; i < count; i++) {\n                    // Delete all the preferences\n                    self.GetPreference(allStartWith + \"-\" + i, \"\", subOptions).setData(\"\")\n                }\n                self.GetPreference(allStartWith + \"-length\", \"\", subOptions).setData(\"\")\n                return\n            }\n\n            let i = 0\n            while (str !== \"\") {\n                if (str === undefined || str === \"undefined\") {\n                    source.setData(undefined)\n                    throw (\n                        \"Got 'undefined' or a literal string containing 'undefined' for a long preference with name \" +\n                        key\n                    )\n                }\n                if (str === \"undefined\") {\n                    source.setData(undefined)\n                    throw (\n                        \"Got a literal string containing 'undefined' for a long preference with name \" +\n                        key\n                    )\n                }\n                if (i > 100) {\n                    throw \"This long preference is getting very long... \"\n                }\n                self.GetPreference(allStartWith + \"-\" + i, \"\", subOptions).setData(\n                    str.substr(0, 255)\n                )\n                str = str.substr(255)\n                i++\n            }\n            length.setData(\"\" + i) // We use I, the number of preference fields used\n        })\n\n        function updateData(l: number) {\n            if (Object.keys(self.preferences.data).length === 0) {\n                // The preferences are still empty - they are not yet updated, so we delay updating for now\n                return\n            }\n            const prefsCount = Number(l)\n            if (prefsCount > 100) {\n                throw \"Length to long\"\n            }\n            let str = \"\"\n            for (let i = 0; i < prefsCount; i++) {\n                const key = allStartWith + \"-\" + i\n                if (self.preferences.data[key] === undefined) {\n                    console.warn(\n                        \"Detected a broken combined preference:\",\n                        key,\n                        \"is undefined\",\n                        self.preferences\n                    )\n                }\n                str += self.preferences.data[key] ?? \"\"\n            }\n\n            source.setData(str)\n        }\n\n        length.addCallback((l) => {\n            updateData(Number(l))\n        })\n        this.preferences.addCallbackAndRun((_) => {\n            updateData(Number(length.data))\n        })\n\n        return source\n    }\n\n    public GetPreference(\n        key: string,\n        defaultValue: string = undefined,\n        options?: {\n            documentation?: string\n            prefix?: string\n        }\n    ): UIEventSource<string> {\n        const prefix: string = options?.prefix ?? \"mapcomplete-\"\n        if (key.startsWith(prefix) && prefix !== \"\") {\n            console.trace(\n                \"A preference was requested which has a duplicate prefix in its key. This is probably a bug\"\n            )\n        }\n        key = prefix + key\n        key = key.replace(/[:\\\\\\/\"' {}.%]/g, \"\")\n        if (key.length >= 255) {\n            throw \"Preferences: key length to big\"\n        }\n        const cached = this.preferenceSources.get(key)\n        if (cached !== undefined) {\n            return cached\n        }\n        if (this.userDetails.data.loggedIn && this.preferences.data[key] === undefined) {\n            this.UpdatePreferences()\n        }\n\n        const pref = new UIEventSource<string>(\n            this.preferences.data[key] ?? defaultValue,\n            \"osm-preference:\" + key\n        )\n        pref.addCallback((v) => {\n            this.UploadPreference(key, v)\n        })\n\n        this.preferences.addCallbackD((allPrefs) => {\n            const v = allPrefs[key]\n            if (v === undefined) {\n                return\n            }\n            pref.setData(v)\n        })\n\n        this.preferenceSources.set(key, pref)\n        return pref\n    }\n\n    public ClearPreferences() {\n        let isRunning = false\n        const self = this\n        this.preferences.addCallback((prefs) => {\n            console.log(\"Cleaning preferences...\")\n            if (Object.keys(prefs).length == 0) {\n                return\n            }\n            if (isRunning) {\n                return\n            }\n            isRunning = true\n            const prefixes = [\"mapcomplete-\"]\n            for (const key in prefs) {\n                const matches = prefixes.some((prefix) => key.startsWith(prefix))\n                if (matches) {\n                    console.log(\"Clearing \", key)\n                    self.GetPreference(key, \"\", { prefix: \"\" }).setData(\"\")\n                }\n            }\n            isRunning = false\n            return\n        })\n    }\n\n    removeAllWithPrefix(prefix: string) {\n        for (const key in this.preferences.data) {\n            if (key.startsWith(prefix)) {\n                this.GetPreference(key, \"\", { prefix: \"\" }).setData(undefined)\n                console.log(\"Clearing preference\", key)\n            }\n        }\n        this.preferences.ping()\n    }\n\n    private UpdatePreferences(forceUpdate?: boolean) {\n        const self = this\n        if (this._fakeUser) {\n            return\n        }\n        this.auth.xhr(\n            {\n                method: \"GET\",\n                path: \"/api/0.6/user/preferences\",\n            },\n            function (error, value: XMLDocument) {\n                if (error) {\n                    console.log(\"Could not load preferences\", error)\n                    return\n                }\n                const prefs = value.getElementsByTagName(\"preference\")\n                const seenKeys = new Set<string>()\n                for (let i = 0; i < prefs.length; i++) {\n                    const pref = prefs[i]\n                    const k = pref.getAttribute(\"k\")\n                    const v = pref.getAttribute(\"v\")\n                    self.preferences.data[k] = v\n                    seenKeys.add(k)\n                }\n                if (forceUpdate) {\n                    for (let key in self.preferences.data) {\n                        if (seenKeys.has(key)) {\n                            continue\n                        }\n                        console.log(\"Deleting key\", key, \"as we didn't find it upstream\")\n                        delete self.preferences.data[key]\n                    }\n                }\n\n                // We merge all the preferences: new keys are uploaded\n                // For differing values, the server overrides local changes\n                self.preferenceSources.forEach((preference, key) => {\n                    const osmValue = self.preferences.data[key]\n                    if (osmValue === undefined && preference.data !== undefined) {\n                        // OSM doesn't know this value yet\n                        self.UploadPreference(key, preference.data)\n                    } else {\n                        // OSM does have a value - set it\n                        preference.setData(osmValue)\n                    }\n                })\n\n                self.preferences.ping()\n            }\n        )\n    }\n\n    private UploadPreference(k: string, v: string) {\n        if (!this.userDetails.data.loggedIn) {\n            console.debug(`Not saving preference ${k}: user not logged in`)\n            return\n        }\n\n        if (this.preferences.data[k] === v) {\n            return\n        }\n        const self = this\n        console.debug(\"Updating preference\", k, \" to \", Utils.EllipsesAfter(v, 15))\n        if (this._fakeUser) {\n            return\n        }\n        if (v === undefined || v === \"\") {\n            this.auth.xhr(\n                {\n                    method: \"DELETE\",\n                    path: \"/api/0.6/user/preferences/\" + encodeURIComponent(k),\n                    headers: { \"Content-Type\": \"text/plain\" },\n                },\n                function (error) {\n                    if (error) {\n                        console.warn(\"Could not remove preference\", error)\n                        return\n                    }\n                    delete self.preferences.data[k]\n                    self.preferences.ping()\n                    console.debug(\"Preference \", k, \"removed!\")\n                }\n            )\n            return\n        }\n\n        this.auth.xhr(\n            {\n                method: \"PUT\",\n                path: \"/api/0.6/user/preferences/\" + encodeURIComponent(k),\n                headers: { \"Content-Type\": \"text/plain\" },\n                content: v,\n            },\n            function (error) {\n                if (error) {\n                    console.warn(`Could not set preference \"${k}\"'`, error)\n                    return\n                }\n                self.preferences.data[k] = v\n                self.preferences.ping()\n                console.debug(`Preference ${k} written!`)\n            }\n        )\n    }\n}\n","import { osmAuth } from \"osm-auth\"\nimport { Store, Stores, UIEventSource } from \"../UIEventSource\"\nimport { OsmPreferences } from \"./OsmPreferences\"\nimport { Utils } from \"../../Utils\"\nimport { LocalStorageSource } from \"../Web/LocalStorageSource\"\nimport { AuthConfig } from \"./AuthConfig\"\nimport Constants from \"../../Models/Constants\"\n\ninterface OsmUserInfo {\n    id: number\n    display_name: string\n    account_created: string\n    description: string\n    contributor_terms: { agreed: boolean }\n    roles: []\n    changesets: { count: number }\n    traces: { count: number }\n    blocks: { received: { count: number; active: number } }\n}\n\nexport default class UserDetails {\n    public loggedIn = false\n    public name = \"Not logged in\"\n    public uid: number\n    public csCount = 0\n    public img?: string\n    public unreadMessages = 0\n    public totalMessages: number = 0\n    public home: { lon: number; lat: number }\n    public backend: string\n    public account_created: string\n    public tracesCount: number = 0\n    public description: string\n    public languages: string[]\n\n    constructor(backend: string) {\n        this.backend = backend\n    }\n}\n\nexport type OsmServiceState = \"online\" | \"readonly\" | \"offline\" | \"unknown\" | \"unreachable\"\n\nexport class OsmConnection {\n    public auth: osmAuth\n    public userDetails: UIEventSource<UserDetails>\n    public isLoggedIn: Store<boolean>\n    public gpxServiceIsOnline: UIEventSource<OsmServiceState> = new UIEventSource<OsmServiceState>(\n        \"unknown\"\n    )\n    public apiIsOnline: UIEventSource<OsmServiceState> = new UIEventSource<OsmServiceState>(\n        \"unknown\"\n    )\n\n    public loadingStatus = new UIEventSource<\"not-attempted\" | \"loading\" | \"error\" | \"logged-in\">(\n        \"not-attempted\"\n    )\n    public preferencesHandler: OsmPreferences\n    public readonly _oauth_config: AuthConfig\n    private readonly _dryRun: Store<boolean>\n    private readonly fakeUser: boolean\n    private _onLoggedIn: ((userDetails: UserDetails) => void)[] = []\n    private readonly _iframeMode: boolean\n    private readonly _singlePage: boolean\n    private isChecking = false\n    private readonly _doCheckRegularly\n\n    constructor(options?: {\n        dryRun?: Store<boolean>\n        fakeUser?: false | boolean\n        oauth_token?: UIEventSource<string>\n        // Used to keep multiple changesets open and to write to the correct changeset\n        singlePage?: boolean\n        attemptLogin?: true | boolean\n        /**\n         * If true: automatically check if we're still online every 5 minutes + fetch messages\n         */\n        checkOnlineRegularly?: true | boolean\n    }) {\n        options ??= {}\n        this.fakeUser = options?.fakeUser ?? false\n        this._singlePage = options?.singlePage ?? true\n        this._oauth_config = Constants.osmAuthConfig\n        this._doCheckRegularly = options?.checkOnlineRegularly ?? true\n        console.debug(\"Using backend\", this._oauth_config.url)\n        this._iframeMode = Utils.runningFromConsole ? false : window !== window.top\n\n        // Check if there are settings available in environment variables, and if so, use those\n        if (\n            import.meta.env.VITE_OSM_OAUTH_CLIENT_ID !== undefined &&\n            import.meta.env.VITE_OSM_OAUTH_SECRET !== undefined\n        ) {\n            console.debug(\"Using environment variables for oauth config\")\n            this._oauth_config.oauth_client_id = import.meta.env.VITE_OSM_OAUTH_CLIENT_ID\n            this._oauth_config.oauth_secret = import.meta.env.VITE_OSM_OAUTH_SECRET\n        }\n\n        this.userDetails = new UIEventSource<UserDetails>(\n            new UserDetails(this._oauth_config.url),\n            \"userDetails\"\n        )\n        if (options.fakeUser) {\n            const ud = this.userDetails.data\n            ud.csCount = 5678\n            ud.uid = 42\n            ud.loggedIn = true\n            ud.unreadMessages = 0\n            ud.name = \"Fake user\"\n            ud.totalMessages = 42\n            ud.languages = [\"en\"]\n            this.loadingStatus.setData(\"logged-in\")\n        }\n        this.UpdateCapabilities()\n\n        this.isLoggedIn = this.userDetails.map(\n            (user) =>\n                user.loggedIn &&\n                (this.apiIsOnline.data === \"unknown\" || this.apiIsOnline.data === \"online\"),\n            [this.apiIsOnline]\n        )\n        this.isLoggedIn.addCallback((isLoggedIn) => {\n            if (this.userDetails.data.loggedIn == false && isLoggedIn == true) {\n                // We have an inconsistency: the userdetails say we _didn't_ log in, but this actor says we do\n                // This means someone attempted to toggle this; so we attempt to login!\n                this.AttemptLogin()\n            }\n        })\n\n        this._dryRun = options.dryRun ?? new UIEventSource<boolean>(false)\n\n        this.updateAuthObject()\n        if (!this.fakeUser) {\n            this.CheckForMessagesContinuously()\n        }\n\n        this.preferencesHandler = new OsmPreferences(this.auth, this, this.fakeUser)\n\n        if (options.oauth_token?.data !== undefined) {\n            console.log(options.oauth_token.data)\n            this.auth.bootstrapToken(options.oauth_token.data, (err, result) => {\n                console.log(\"Bootstrap token called back\", err, result)\n                this.AttemptLogin()\n            })\n\n            options.oauth_token.setData(undefined)\n        }\n        if (!Utils.runningFromConsole && this.auth.authenticated() && options.attemptLogin !== false) {\n            this.AttemptLogin()\n        } else {\n            console.log(\"Not authenticated\")\n        }\n    }\n\n    public GetPreference<T extends string = string>(\n        key: string,\n        defaultValue: string = undefined,\n        options?: {\n            documentation?: string\n            prefix?: string\n        }\n    ): UIEventSource<T | undefined> {\n        return <UIEventSource<T>>this.preferencesHandler.GetPreference(key, defaultValue, options)\n    }\n\n    public GetLongPreference(key: string, prefix: string = \"mapcomplete-\"): UIEventSource<string> {\n        return this.preferencesHandler.GetLongPreference(key, prefix)\n    }\n\n    public OnLoggedIn(action: (userDetails: UserDetails) => void) {\n        this._onLoggedIn.push(action)\n    }\n\n    public LogOut() {\n        this.auth.logout()\n        this.userDetails.data.loggedIn = false\n        this.userDetails.data.csCount = 0\n        this.userDetails.data.name = \"\"\n        this.userDetails.ping()\n        console.log(\"Logged out\")\n        this.loadingStatus.setData(\"not-attempted\")\n        this.preferencesHandler.preferences.setData(undefined)\n    }\n\n    /**\n     * The backend host, without path or trailing '/'\n     *\n     * new OsmConnection().Backend() // => \"https://www.openstreetmap.org\"\n     */\n    public Backend(): string {\n        return this._oauth_config.url\n    }\n\n    public AttemptLogin() {\n        this.UpdateCapabilities()\n        if (this.loadingStatus.data !== \"logged-in\") {\n            // Stay 'logged-in' if we are already logged in; this simply means we are checking for messages\n            this.loadingStatus.setData(\"loading\")\n        }\n        if (this.fakeUser) {\n            this.loadingStatus.setData(\"logged-in\")\n            console.log(\"AttemptLogin called, but ignored as fakeUser is set\")\n            return\n        }\n\n        console.log(\"Trying to log in...\")\n        this.updateAuthObject()\n\n        LocalStorageSource.Get(\"location_before_login\").setData(\n            Utils.runningFromConsole ? undefined : window.location.href\n        )\n        this.auth.xhr(\n            {\n                method: \"GET\",\n                path: \"/api/0.6/user/details\"\n            },\n            (err, details: XMLDocument) => {\n                if (err != null) {\n                    console.log(\"Could not login due to:\", err)\n                    this.loadingStatus.setData(\"error\")\n                    if (err.status == 401) {\n                        console.log(\"Clearing tokens...\")\n                        // Not authorized - our token probably got revoked\n                        this.auth.logout()\n                        this.LogOut()\n                    } else {\n                        console.log(\"Other error. Status:\", err.status)\n                        this.apiIsOnline.setData(\"unreachable\")\n                    }\n                    return\n                }\n\n                if (details == null) {\n                    this.loadingStatus.setData(\"error\")\n                    return\n                }\n\n                // details is an XML DOM of user details\n                const userInfo = details.getElementsByTagName(\"user\")[0]\n\n                const data = this.userDetails.data\n                data.loggedIn = true\n                console.log(\"Login completed, userinfo is \", userInfo)\n                data.name = userInfo.getAttribute(\"display_name\")\n                data.account_created = userInfo.getAttribute(\"account_created\")\n                data.uid = Number(userInfo.getAttribute(\"id\"))\n                data.languages = Array.from(\n                    userInfo.getElementsByTagName(\"languages\")[0].getElementsByTagName(\"lang\")\n                ).map((l) => l.textContent)\n                data.csCount = Number.parseInt(\n                    userInfo.getElementsByTagName(\"changesets\")[0].getAttribute(\"count\") ?? \"0\"\n                )\n                data.tracesCount = Number.parseInt(\n                    userInfo.getElementsByTagName(\"traces\")[0].getAttribute(\"count\") ?? \"0\"\n                )\n\n                data.img = undefined\n                const imgEl = userInfo.getElementsByTagName(\"img\")\n                if (imgEl !== undefined && imgEl[0] !== undefined) {\n                    data.img = imgEl[0].getAttribute(\"href\")\n                }\n\n                const description = userInfo.getElementsByTagName(\"description\")\n                if (description !== undefined && description[0] !== undefined) {\n                    data.description = description[0]?.innerHTML\n                }\n                const homeEl = userInfo.getElementsByTagName(\"home\")\n                if (homeEl !== undefined && homeEl[0] !== undefined) {\n                    const lat = parseFloat(homeEl[0].getAttribute(\"lat\"))\n                    const lon = parseFloat(homeEl[0].getAttribute(\"lon\"))\n                    data.home = { lat: lat, lon: lon }\n                }\n\n                this.loadingStatus.setData(\"logged-in\")\n                const messages = userInfo\n                    .getElementsByTagName(\"messages\")[0]\n                    .getElementsByTagName(\"received\")[0]\n                data.unreadMessages = parseInt(messages.getAttribute(\"unread\"))\n                data.totalMessages = parseInt(messages.getAttribute(\"count\"))\n\n                this.userDetails.ping()\n                for (const action of this._onLoggedIn) {\n                    action(this.userDetails.data)\n                }\n                this._onLoggedIn = []\n            }\n        )\n    }\n\n    /**\n     * Interact with the API.\n     *\n     * @param path the path to query, without host and without '/api/0.6'. Example 'notes/1234/close'\n     * @param method\n     * @param header\n     * @param content\n     * @param allowAnonymous if set, will use the anonymous-connection if the main connection is not authenticated\n     */\n    public async interact(\n        path: string,\n        method: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\",\n        header?: Record<string, string>,\n        content?: string,\n        allowAnonymous: boolean = false\n    ): Promise<string> {\n        const connection: osmAuth = this.auth\n        if (allowAnonymous && !this.auth.authenticated()) {\n            const possibleResult = await Utils.downloadAdvanced(\n                `${this.Backend()}/api/0.6/${path}`,\n                header,\n                method,\n                content\n            )\n            if (possibleResult[\"content\"]) {\n                return possibleResult[\"content\"]\n            }\n            console.error(possibleResult)\n            throw \"Could not interact with OSM:\" + possibleResult[\"error\"]\n        }\n\n        return new Promise((ok, error) => {\n            connection.xhr(\n                {\n                    method,\n                    headers: header,\n                    content,\n                    path: `/api/0.6/${path}`\n                },\n                function(err, response) {\n                    if (err !== null) {\n                        error(err)\n                    } else {\n                        ok(response)\n                    }\n                }\n            )\n        })\n    }\n\n    public async post<T extends string>(\n        path: string,\n        content?: string,\n        header?: Record<string, string>,\n        allowAnonymous: boolean = false\n    ): Promise<T> {\n        return <T> await this.interact(path, \"POST\", header, content, allowAnonymous)\n    }\n\n    public async put<T extends string>(\n        path: string,\n        content?: string,\n        header?: Record<string, string>\n    ): Promise<T> {\n        return <T> await this.interact(path, \"PUT\", header, content)\n    }\n\n    public async get(\n        path: string,\n        header?: Record<string, string>,\n        allowAnonymous: boolean = false\n    ): Promise<string> {\n        return await this.interact(path, \"GET\", header, undefined, allowAnonymous)\n    }\n\n    public closeNote(id: number | string, text?: string): Promise<string> {\n        let textSuffix = \"\"\n        if ((text ?? \"\") !== \"\") {\n            textSuffix = \"?text=\" + encodeURIComponent(text)\n        }\n        if (this._dryRun.data) {\n            console.warn(\"Dryrun enabled - not actually closing note \", id, \" with text \", text)\n            return new Promise((ok) => {\n                ok(\"\")\n            })\n        }\n        return this.post(`notes/${id}/close${textSuffix}`)\n    }\n\n    public reopenNote(id: number | string, text?: string): Promise<string> {\n        if (this._dryRun.data) {\n            console.warn(\"Dryrun enabled - not actually reopening note \", id, \" with text \", text)\n            return new Promise(resolve => {\n                resolve(\"\")\n            })\n        }\n        let textSuffix = \"\"\n        if ((text ?? \"\") !== \"\") {\n            textSuffix = \"?text=\" + encodeURIComponent(text)\n        }\n        return this.post(`notes/${id}/reopen${textSuffix}`)\n    }\n\n    public async openNote(lat: number, lon: number, text: string): Promise<{ id: number }> {\n        if (this._dryRun.data) {\n            console.warn(\"Dryrun enabled - not actually opening note with text \", text)\n            return new Promise<{ id: number }>((ok) => {\n                window.setTimeout(\n                    () => ok({ id: Math.floor(Math.random() * 1000) }),\n                    Math.random() * 5000\n                )\n            })\n        }\n        // Lat and lon must be strings for the API to accept it\n        const content = `lat=${lat}&lon=${lon}&text=${encodeURIComponent(text)}`\n        const response = await this.post(\n            \"notes.json\",\n            content,\n            {\n                \"Content-Type\": \"application/x-www-form-urlencoded; charset=UTF-8\"\n            },\n            true\n        )\n        const parsed = JSON.parse(response)\n        console.log(\"Got result:\", parsed)\n        const id = parsed.properties\n        console.log(\"OPENED NOTE\", id)\n        return id\n    }\n\n    public static GpxTrackVisibility = [\"private\", \"public\", \"trackable\", \"identifiable\"] as const\n\n    public async uploadGpxTrack(\n        gpx: string,\n        options: {\n            description: string\n            visibility: (typeof OsmConnection.GpxTrackVisibility)[number]\n            filename?: string\n            /**\n             * Some words to give some properties;\n             *\n             * Note: these are called 'tags' on the wiki, but I opted to name them 'labels' instead as they aren't \"key=value\" tags, but just words.\n             */\n            labels: string[]\n        }\n    ): Promise<{ id: number }> {\n        if (this._dryRun.data) {\n            console.warn(\"Dryrun enabled - not actually uploading GPX \", gpx)\n            return new Promise<{ id: number }>((ok) => {\n                window.setTimeout(\n                    () => ok({ id: Math.floor(Math.random() * 1000) }),\n                    Math.random() * 5000\n                )\n            })\n        }\n\n        const contents = {\n            file: gpx,\n            description: options.description,\n            tags: options.labels?.join(\",\") ?? \"\",\n            visibility: options.visibility\n        }\n\n        if (!contents.description) {\n            throw \"The description of a GPS-trace cannot be the empty string, undefined or null\"\n        }\n        const extras = {\n            file:\n                \"; filename=\\\"\" +\n                (options.filename ?? \"gpx_track_mapcomplete_\" + new Date().toISOString()) +\n                \"\\\"\\r\\nContent-Type: application/gpx+xml\"\n        }\n\n        const boundary = \"987654\"\n\n        let body = \"\"\n        for (const key in contents) {\n            body += \"--\" + boundary + \"\\r\\n\"\n            body += \"Content-Disposition: form-data; name=\\\"\" + key + \"\\\"\"\n            if (extras[key] !== undefined) {\n                body += extras[key]\n            }\n            body += \"\\r\\n\\r\\n\"\n            body += contents[key] + \"\\r\\n\"\n        }\n        body += \"--\" + boundary + \"--\\r\\n\"\n\n        const response = await this.post(\"gpx/create\", body, {\n            \"Content-Type\": \"multipart/form-data; boundary=\" + boundary,\n            \"Content-Length\": \"\"+body.length\n        })\n        const parsed = JSON.parse(response)\n        console.log(\"Uploaded GPX track\", parsed)\n        return { id: parsed }\n    }\n\n    public addCommentToNote(id: number | string, text: string): Promise<void> {\n        if (this._dryRun.data) {\n            console.warn(\"Dryrun enabled - not actually adding comment \", text, \"to  note \", id)\n            return new Promise((ok) => {\n                ok()\n            })\n        }\n        if ((text ?? \"\") === \"\") {\n            throw \"Invalid text!\"\n        }\n\n        return new Promise((ok, error) => {\n            this.auth.xhr(\n                {\n                    method: \"POST\",\n\n                    path: `/api/0.6/notes/${id}/comment?text=${encodeURIComponent(text)}`\n                },\n                function(err) {\n                    if (err !== null) {\n                        error(err)\n                    } else {\n                        ok()\n                    }\n                }\n            )\n        })\n    }\n\n    /**\n     * To be called by land.html\n     */\n    public finishLogin(callback: (previousURL: string) => void) {\n        this.auth.authenticate(function() {\n            // Fully authed at this point\n            console.log(\"Authentication successful!\")\n            const previousLocation = LocalStorageSource.Get(\"location_before_login\")\n            callback(previousLocation.data)\n        })\n    }\n\n    private updateAuthObject() {\n        this.auth = new osmAuth({\n            client_id: this._oauth_config.oauth_client_id,\n            url: this._oauth_config.url,\n            scope: \"read_prefs write_prefs write_api write_gpx write_notes openid\",\n            redirect_uri: Utils.runningFromConsole\n                ? \"https://mapcomplete.org/land.html\"\n                : window.location.protocol + \"//\" + window.location.host + \"/land.html\",\n            singlepage: true, // We always use 'singlePage', it is the most stable - including in PWA\n            auto: true\n        })\n    }\n\n    private CheckForMessagesContinuously() {\n        if (this.isChecking) {\n            return\n        }\n        Stores.Chronic(3 * 1000).addCallback(() => {\n            if (!(this.apiIsOnline.data === \"unreachable\" || this.apiIsOnline.data === \"offline\")) {\n                return\n            }\n            try {\n                console.log(\"Api is offline - trying to reconnect...\")\n                this.AttemptLogin()\n            } catch (e) {\n                console.log(\"Could not login due to\", e)\n            }\n        })\n        this.isChecking = true\n        if (!this._doCheckRegularly) {\n            return\n        }\n        Stores.Chronic(60 * 5 * 1000).addCallback(() => {\n            if (this.isLoggedIn.data) {\n                try {\n                    this.AttemptLogin()\n                } catch (e) {\n                    console.log(\"Could not login due to\", e)\n                }\n            }\n        })\n    }\n\n    private UpdateCapabilities(): void {\n        if (this.fakeUser) {\n            return\n        }\n        this.FetchCapabilities().then(({ api, gpx }) => {\n            this.apiIsOnline.setData(api)\n            this.gpxServiceIsOnline.setData(gpx)\n        })\n    }\n\n    private readonly _userInfoCache: Record<number, OsmUserInfo> = {}\n\n    public async getInformationAboutUser(id: number): Promise<OsmUserInfo> {\n        if (id === undefined) {\n            return undefined\n        }\n        if (this._userInfoCache[id]) {\n            return this._userInfoCache[id]\n        }\n        const info = await this.get(\"user/\" + id + \".json\", { accepts: \"application/json\" }, true)\n        const parsed = JSON.parse(info)[\"user\"]\n        this._userInfoCache[id] = parsed\n        return parsed\n    }\n\n    private async FetchCapabilities(): Promise<{ api: OsmServiceState; gpx: OsmServiceState }> {\n        if (Utils.runningFromConsole) {\n            return { api: \"online\", gpx: \"online\" }\n        }\n        const result = await Utils.downloadAdvanced(this.Backend() + \"/api/0.6/capabilities\")\n        if (result[\"content\"] === undefined) {\n            console.log(\"Something went wrong:\", result)\n            return { api: \"unreachable\", gpx: \"unreachable\" }\n        }\n        const xmlRaw = result[\"content\"]\n        const parsed = new DOMParser().parseFromString(xmlRaw, \"text/xml\")\n        const statusEl = parsed.getElementsByTagName(\"status\")[0]\n        const api = <OsmServiceState>statusEl.getAttribute(\"api\")\n        const gpx = <OsmServiceState>statusEl.getAttribute(\"gpx\")\n        return { api, gpx }\n    }\n}\n"],"names":["osmAuth","oauth","_store","_mock","k","v","token","key","val","callback","_preopenPopup","error","popup","_generatePkceChallenge","pkce","_authenticate","resolve","reject","errback","err","result","w","h","settings","x","state","generateState","url","utilQsString","params","utilStringQs","_getAccessToken","accessTokenDone","xhr","access_token","auth_code","code_verifier","broughtPopupToFront","resource","options","_doFetch","_doXHR","done","method","data","headers","e","obj","str","i","pair","parts","supportsWebCryptoAPI","random","base64","verifier","char","hash","code_challenge","chars","buffer","OsmPreferences","auth","osmConnection","fakeUser","__publicField","LocalStorageSource","prefix","source","UIEventSource","allStartWith","subOptions","length","self","count","updateData","l","prefsCount","_","defaultValue","cached","pref","allPrefs","isRunning","prefs","prefixes","forceUpdate","value","seenKeys","preference","osmValue","Utils","UserDetails","backend","OsmConnection","Constants","ud","user","isLoggedIn","_a","action","details","userInfo","imgEl","description","homeEl","lat","lon","messages","path","header","content","allowAnonymous","connection","possibleResult","ok","response","id","text","textSuffix","parsed","gpx","contents","extras","boundary","body","previousLocation","Stores","api","info","xmlRaw","statusEl"],"mappings":"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","x_google_ignoreList":[0]}