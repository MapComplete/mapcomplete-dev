var E=Object.defineProperty;var k=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>(k(i,typeof e!="symbol"?e+"":e,t),t);import{s as C}from"./store.legacy-04704c36.js";import{L as D,U as m,S as O}from"./LocalStorageSource-78a030c5.js";import{U as p}from"./Utils-498bb79d.js";import{C as x}from"./Constants-85b2fbbb.js";function L(i){var e={};e.authenticated=function(){return!!n("oauth2_access_token")},e.logout=function(){return n("oauth2_access_token",""),n("oauth_token",""),n("oauth_token_secret",""),n("oauth_request_token_secret",""),e},e.authenticate=function(a){if(e.authenticated()){a(null,e);return}e.logout(),P(function(r){t(r,a)})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((a,r)=>{var u=(l,c)=>{l?r(new Error(l)):a(c)};P(l=>t(l,u))}))};function t(a,r){var u=M(),l=i.url+"/oauth2/authorize?"+I({client_id:i.client_id,redirect_uri:i.redirect_uri,response_type:"code",scope:i.scope,state:u,code_challenge:a.code_challenge,code_challenge_method:a.code_challenge_method});if(i.singlepage){if(!C.enabled){var c=new Error("local storage unavailable, but require in singlepage mode");c.status="pkce-localstorage-unavailable",r(c);return}var h=y(window.location.search.slice(1));h.code?e.bootstrapToken(h.code,r):(n("oauth2_state",u),n("oauth2_pkce_code_verifier",a.code_verifier),window.location=l)}else{var f=600,g=550,_=[["width",f],["height",g],["left",window.screen.width/2-f/2],["top",window.screen.height/2-g/2]].map(function(w){return w.join("=")}).join(","),v=window.open("about:blank","oauth_window",_);e.popupWindow=v,v.location=l,v||(c=new Error("Popup was blocked"),c.status="popup-blocked",r(c))}window.authComplete=function(w){var b=y(w.split("?")[1]);if(b.state!==u){c=new Error("Invalid state"),c.status="invalid-state",r(c);return}o(b.code,a.code_verifier,S),delete window.authComplete};function S(w,b){if(i.done(),w){r(w);return}var U=JSON.parse(b.response);n("oauth2_access_token",U.access_token),r(null,e)}}function o(a,r,u){var l=i.url+"/oauth2/token?"+I({client_id:i.client_id,redirect_uri:i.redirect_uri,grant_type:"authorization_code",code:a,code_verifier:r});e.rawxhr("POST",l,null,null,null,u),i.loading()}e.bringPopupWindowToFront=function(){var a=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),a=!0)}catch{}return a},e.bootstrapToken=function(a,r){var u=n("oauth2_state");n("oauth2_state","");var l=y(window.location.search.slice(1));if(l.state!==u){var c=new Error("Invalid state");c.status="invalid-state",r(c);return}var h=n("oauth2_pkce_code_verifier");n("oauth2_pkce_code_verifier",""),o(a,h,f);function f(g,_){if(i.done(),g){r(g);return}var v=JSON.parse(_.response);n("oauth2_access_token",v.access_token),r(null,e)}},e.fetch=function(a,r){if(e.authenticated())return u();return i.auto?e.authenticateAsync().then(u):Promise.reject(new Error("not authenticated"));function u(){return r=r||{},r.headers||(r.headers={"Content-Type":"application/x-www-form-urlencoded"}),r.headers.Authorization="Bearer "+n("oauth2_access_token"),fetch(a,r)}},e.xhr=function(a,r){if(e.authenticated())return u();if(i.auto){e.authenticate(u);return}else{r("not authenticated",null);return}function u(){var c=a.prefix!==!1?i.url+a.path:a.path;return e.rawxhr(a.method,c,n("oauth2_access_token"),a.content,a.headers,l)}function l(c,h){c?r(c):h.responseXML?r(c,h.responseXML):r(c,h.response)}},e.rawxhr=function(a,r,u,l,c,h){c=c||{"Content-Type":"application/x-www-form-urlencoded"},u&&(c.Authorization="Bearer "+u);var f=new XMLHttpRequest;f.onreadystatechange=function(){f.readyState===4&&f.status!==0&&(/^20\d$/.test(f.status)?h(null,f):h(f,null))},f.onerror=function(_){h(_,null)},f.open(a,r,!0);for(var g in c)f.setRequestHeader(g,c[g]);return f.send(l),f},e.preauth=function(a){return a&&a.access_token&&n("oauth2_access_token",a.access_token),e},e.options=function(a){return arguments.length?(i=a,i.url=i.url||"https://www.openstreetmap.org",i.auto=i.auto||!1,i.singlepage=i.singlepage||!1,i.loading=i.loading||function(){},i.done=i.done||function(){},e.preauth(i)):i};var n;if(C.enabled)n=function(a,r){if(arguments.length===1)return C.get(i.url+a);if(arguments.length===2)return C.set(i.url+a,r)};else{var s={};n=function(a,r){if(arguments.length===1)return s[i.url+a];if(arguments.length===2)return s[i.url+a]=r}}return e.options(i),e}function I(i){return Object.keys(i).filter(function(e){return i[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(i[e])}).join("&")}function y(i){for(var e=0;e<i.length&&(i[e]==="?"||i[e]==="#");)e++;return i=i.slice(e),i.split("&").reduce(function(t,o){var n=o.split("=");return n.length===2&&(t[n[0]]=decodeURIComponent(n[1])),t},{})}function A(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function P(i){var e;if(A()){var t=window.crypto.getRandomValues(new Uint8Array(32));e=T(t.buffer);var o=Uint8Array.from(Array.from(e).map(function(a){return a.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",o).then(function(a){var r=T(a);i({code_challenge:r,code_verifier:e,code_challenge_method:"S256"})})}else{var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var s=0;s<64;s++)e+=n[Math.floor(Math.random()*n.length)];i({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function M(){var i;if(A()){var e=window.crypto.getRandomValues(new Uint8Array(32));i=T(e.buffer)}else{var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";i="";for(var o=0;o<64;o++)i+=t[Math.floor(Math.random()*t.length)]}return i}function T(i){return btoa(String.fromCharCode.apply(null,new Uint8Array(i))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class N{constructor(e,t){d(this,"preferences",D.GetParsed("all-osm-preferences",{}));d(this,"preferenceSources",new Map);d(this,"auth");d(this,"userDetails");d(this,"longPreferences",{});this.auth=e,this.userDetails=t.userDetails;const o=this;t.OnLoggedIn(()=>(o.UpdatePreferences(!0),!0))}GetLongPreference(e,t="mapcomplete-"){if(this.longPreferences[t+e]!==void 0)return this.longPreferences[t+e];const o=new m(void 0,"long-osm-preference:"+t+e);this.longPreferences[t+e]=o;const n=t+e+"-combined",s={prefix:""},a=this.GetPreference(n+"-length","",s);if((n+"-length").length>255)throw"This preference key is too long, it has "+e.length+" characters, but at most "+(255-7-9-t.length)+" characters are allowed";const r=this;o.addCallback(l=>{if(l===void 0||l==="")return;if(l===null){console.error("Deleting "+n);let h=parseInt(a.data);for(let f=0;f<h;f++)r.GetPreference(n+"-"+f,"",s).setData("");r.GetPreference(n+"-length","",s).setData("");return}let c=0;for(;l!=="";){if(l===void 0||l==="undefined")throw o.setData(void 0),"Got 'undefined' or a literal string containing 'undefined' for a long preference with name "+e;if(l==="undefined")throw o.setData(void 0),"Got a literal string containing 'undefined' for a long preference with name "+e;if(c>100)throw"This long preference is getting very long... ";r.GetPreference(n+"-"+c,"",s).setData(l.substr(0,255)),l=l.substr(255),c++}a.setData(""+c)});function u(l){if(Object.keys(r.preferences.data).length===0)return;const c=Number(l);if(c>100)throw"Length to long";let h="";for(let f=0;f<c;f++){const g=n+"-"+f;r.preferences.data[g]===void 0&&console.warn("Detected a broken combined preference:",g,"is undefined",r.preferences),h+=r.preferences.data[g]??""}o.setData(h)}return a.addCallback(l=>{u(Number(l))}),this.preferences.addCallbackAndRun(l=>{u(Number(a.data))}),o}GetPreference(e,t=void 0,o){const n=(o==null?void 0:o.prefix)??"mapcomplete-";if(e.startsWith(n)&&n!==""&&console.trace("A preference was requested which has a duplicate prefix in its key. This is probably a bug"),e=n+e,e=e.replace(/[:\\\/"' {}.%]/g,""),e.length>=255)throw"Preferences: key length to big";const s=this.preferenceSources.get(e);if(s!==void 0)return s;this.userDetails.data.loggedIn&&this.preferences.data[e]===void 0&&this.UpdatePreferences();const a=new m(this.preferences.data[e]??t,"osm-preference:"+e);return a.addCallback(r=>{this.UploadPreference(e,r)}),this.preferences.addCallbackD(r=>{const u=r[e];u!==void 0&&a.setData(u)}),this.preferenceSources.set(e,a),a}ClearPreferences(){let e=!1;const t=this;this.preferences.addCallback(o=>{if(console.log("Cleaning preferences..."),Object.keys(o).length==0||e)return;e=!0;const n=["mapcomplete-"];for(const s in o)n.some(r=>s.startsWith(r))&&(console.log("Clearing ",s),t.GetPreference(s,"",{prefix:""}).setData(""));e=!1})}UpdatePreferences(e){const t=this;this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},function(o,n){if(o){console.log("Could not load preferences",o);return}const s=n.getElementsByTagName("preference"),a=new Set;for(let r=0;r<s.length;r++){const u=s[r],l=u.getAttribute("k"),c=u.getAttribute("v");t.preferences.data[l]=c,a.add(l)}if(e)for(let r in t.preferences.data)a.has(r)||(console.log("Deleting key",r,"as we didn't find it upstream"),delete t.preferences.data[r]);t.preferenceSources.forEach((r,u)=>{const l=t.preferences.data[u];l===void 0&&r.data!==void 0?t.UploadPreference(u,r.data):r.setData(l)}),t.preferences.ping()})}UploadPreference(e,t){if(!this.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(this.preferences.data[e]===t)return;const o=this;if(console.debug("Updating preference",e," to ",p.EllipsesAfter(t,15)),t===void 0||t===""){this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}}},function(n){if(n){console.warn("Could not remove preference",n);return}delete o.preferences.data[e],o.preferences.ping(),console.debug("Preference ",e,"removed!")});return}this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}},content:t},function(n){if(n){console.warn(`Could not set preference "${e}"'`,n);return}o.preferences.data[e]=t,o.preferences.ping(),console.debug(`Preference ${e} written!`)})}removeAllWithPrefix(e){for(const t in this.preferences.data)t.startsWith(e)&&(this.GetPreference(t,"",{prefix:""}).setData(void 0),console.log("Clearing preference",t));this.preferences.ping()}}class R{constructor(e){d(this,"loggedIn",!1);d(this,"name","Not logged in");d(this,"uid");d(this,"csCount",0);d(this,"img");d(this,"unreadMessages",0);d(this,"totalMessages",0);d(this,"home");d(this,"backend");d(this,"account_created");d(this,"tracesCount",0);d(this,"description");d(this,"languages");this.backend=e}}class G{constructor(e){d(this,"auth");d(this,"userDetails");d(this,"isLoggedIn");d(this,"gpxServiceIsOnline",new m("unknown"));d(this,"apiIsOnline",new m("unknown"));d(this,"loadingStatus",new m("not-attempted"));d(this,"preferencesHandler");d(this,"_oauth_config");d(this,"_dryRun");d(this,"fakeUser");d(this,"_onLoggedIn",[]);d(this,"_iframeMode");d(this,"_singlePage");d(this,"isChecking",!1);d(this,"_userInfoCache",{});var o;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=x.osmAuthConfig,console.debug("Using backend",this._oauth_config.url),this._iframeMode=p.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new m(new R(this._oauth_config.url),"userDetails"),e.fakeUser){const n=this.userDetails.data;n.csCount=5678,n.uid=42,n.loggedIn=!0,n.unreadMessages=0,n.name="Fake user",n.totalMessages=42,n.languages=["en"]}const t=this;if(this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(n=>n.loggedIn&&(t.apiIsOnline.data==="unknown"||t.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(n=>{t.userDetails.data.loggedIn==!1&&n==!0&&t.AttemptLogin()}),this._dryRun=e.dryRun??new m(!1),this.updateAuthObject(),this.preferencesHandler=new N(this.auth,this),((o=e.oauth_token)==null?void 0:o.data)!==void 0){console.log(e.oauth_token.data);const n=this;this.auth.bootstrapToken(e.oauth_token.data,(s,a)=>{console.log("Bootstrap token called back",s,a),n.AttemptLogin()}),e.oauth_token.setData(void 0)}this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,t=void 0,o){return this.preferencesHandler.GetPreference(e,t,o)}GetLongPreference(e,t="mapcomplete-"){return this.preferencesHandler.GetLongPreference(e,t)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted"),this.preferencesHandler.preferences.setData(void 0)}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.data!=="logged-in"&&this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}const e=this;console.log("Trying to log in..."),this.updateAuthObject(),D.Get("location_before_login").setData(p.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},function(t,o){var c;if(t!=null){console.log(t),e.loadingStatus.setData("error"),t.status==401&&(console.log("Clearing tokens..."),e.auth.logout(),e.LogOut());return}if(o==null){e.loadingStatus.setData("error");return}e.CheckForMessagesContinuously();let n=o.getElementsByTagName("user")[0],s=e.userDetails.data;s.loggedIn=!0,console.log("Login completed, userinfo is ",n),s.name=n.getAttribute("display_name"),s.account_created=n.getAttribute("account_created"),s.uid=Number(n.getAttribute("id")),s.languages=Array.from(n.getElementsByTagName("languages")[0].getElementsByTagName("lang")).map(h=>h.textContent),s.csCount=Number.parseInt(n.getElementsByTagName("changesets")[0].getAttribute("count")??"0"),s.tracesCount=Number.parseInt(n.getElementsByTagName("traces")[0].getAttribute("count")??"0"),s.img=void 0;const a=n.getElementsByTagName("img");a!==void 0&&a[0]!==void 0&&(s.img=a[0].getAttribute("href"));const r=n.getElementsByTagName("description");r!==void 0&&r[0]!==void 0&&(s.description=(c=r[0])==null?void 0:c.innerHTML);const u=n.getElementsByTagName("home");if(u!==void 0&&u[0]!==void 0){const h=parseFloat(u[0].getAttribute("lat")),f=parseFloat(u[0].getAttribute("lon"));s.home={lat:h,lon:f}}e.loadingStatus.setData("logged-in");const l=n.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];s.unreadMessages=parseInt(l.getAttribute("unread")),s.totalMessages=parseInt(l.getAttribute("count")),e.userDetails.ping();for(const h of e._onLoggedIn)h(e.userDetails.data);e._onLoggedIn=[]})}async interact(e,t,o,n,s=!1){let a=this.auth;if(s&&!this.auth.authenticated()){const r=await p.downloadAdvanced(`${this.Backend()}/api/0.6/${e}`,o,t,n);if(r.content)return r.content;throw console.error(r),"Could not interact with OSM:"+r.error}return new Promise((r,u)=>{a.xhr({method:t,options:{header:o},content:n,path:`/api/0.6/${e}`},function(l,c){l!==null?u(l):r(c)})})}async post(e,t,o,n=!1){return await this.interact(e,"POST",o,t,n)}async put(e,t,o){return await this.interact(e,"PUT",o,t)}async get(e,t,o=!1){return await this.interact(e,"GET",t,void 0,o)}closeNote(e,t){let o="";return(t??"")!==""&&(o="?text="+encodeURIComponent(t)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",t),new Promise(n=>{n()})):this.post(`notes/${e}/close${o}`)}reopenNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",t),new Promise(n=>{n()});let o="";return(t??"")!==""&&(o="?text="+encodeURIComponent(t)),this.post(`notes/${e}/reopen${o}`)}async openNote(e,t,o){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",o),new Promise(u=>{window.setTimeout(()=>u({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const n=`lat=${e}&lon=${t}&text=${encodeURIComponent(o)}`,s=await this.post("notes.json",n,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},!0),a=JSON.parse(s);console.log("Got result:",a);const r=a.properties;return console.log("OPENED NOTE",r),r}async uploadGpxTrack(e,t){var l;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise(c=>{window.setTimeout(()=>c({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const o={file:e,description:t.description,tags:((l=t.labels)==null?void 0:l.join(","))??"",visibility:t.visibility};if(!o.description)throw"The description of a GPS-trace cannot be the empty string, undefined or null";const n={file:'; filename="'+(t.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},s="987654";let a="";for(const c in o)a+="--"+s+`\r
`,a+='Content-Disposition: form-data; name="'+c+'"',n[c]!==void 0&&(a+=n[c]),a+=`\r
\r
`,a+=o[c]+`\r
`;a+="--"+s+`--\r
`;const r=await this.post("gpx/create",a,{"Content-Type":"multipart/form-data; boundary="+s,"Content-Length":a.length}),u=JSON.parse(r);return console.log("Uploaded GPX track",u),{id:u}}addCommentToNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",t,"to  note ",e),new Promise(o=>{o()});if((t??"")==="")throw"Invalid text!";return new Promise((o,n)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(t)}`},function(s,a){s!==null?n(s):o()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const t=D.Get("location_before_login");e(t.data)})}updateAuthObject(){let e=!1;try{(p.runningFromConsole||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches)&&(e=!0)}catch(o){console.warn("Detecting standalone mode failed",o,". Assuming in browser and not worrying furhter")}const t=this._iframeMode||e||!this._singlePage;this.auth=new L({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes openid",redirect_uri:p.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!t,auto:!0})}CheckForMessagesContinuously(){const e=this;this.isChecking||(this.isChecking=!0,O.Chronic(5*60*1e3).addCallback(t=>{e.isLoggedIn.data&&e.AttemptLogin()}))}UpdateCapabilities(){const e=this;this.fakeUser||this.FetchCapabilities().then(({api:t,gpx:o})=>{e.apiIsOnline.setData(t),e.gpxServiceIsOnline.setData(o)})}async getInformationAboutUser(e){if(e===void 0)return;if(this._userInfoCache[e])return this._userInfoCache[e];const t=await this.get("user/"+e+".json",{accepts:"application/json"},!0),o=JSON.parse(t).user;return this._userInfoCache[e]=o,o}async FetchCapabilities(){if(p.runningFromConsole)return{api:"online",gpx:"online"};const e=await p.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const t=e.content,n=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("status")[0],s=n.getAttribute("api"),a=n.getAttribute("gpx");return{api:s,gpx:a}}}d(G,"GpxTrackVisibility",["private","public","trackable","identifiable"]);export{G as O};
//# sourceMappingURL=OsmConnection-f542813f.js.map
