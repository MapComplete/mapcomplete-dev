var $=Object.defineProperty;var y=(t,e,n)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var d=(t,e,n)=>(y(t,typeof e!="symbol"?e+"":e,n),n);import{c as commonjsGlobal,g as getDefaultExportFromCjs,C as Constants}from"./Constants-efeceece.js";import{U as UIEventSource,S as Stores}from"./UIEventSource-f1098d48.js";import{U as Utils}from"./Utils-1b2b31c0.js";import{L as LocalStorageSource}from"./LocalStorageSource-5fb0f923.js";var assign=make_assign(),create$1=make_create(),trim$1=make_trim(),Global$5=typeof window<"u"?window:commonjsGlobal,util$6={assign,create:create$1,trim:trim$1,bind:bind$1,slice:slice$1,each:each$7,map,pluck:pluck$1,isList:isList$1,isFunction:isFunction$1,isObject:isObject$1,Global:Global$5};function make_assign(){return Object.assign?Object.assign:function(e,n,a,r){for(var u=1;u<arguments.length;u++)each$7(Object(arguments[u]),function(s,o){e[o]=s});return e}}function make_create(){if(Object.create)return function(e,n,a,r){var u=slice$1(arguments,1);return assign.apply(this,[Object.create(e)].concat(u))};{let t=function(){};return function(n,a,r,u){var s=slice$1(arguments,1);return t.prototype=n,assign.apply(this,[new t].concat(s))}}}function make_trim(){return String.prototype.trim?function(e){return String.prototype.trim.call(e)}:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}function bind$1(t,e){return function(){return e.apply(t,Array.prototype.slice.call(arguments,0))}}function slice$1(t,e){return Array.prototype.slice.call(t,e||0)}function each$7(t,e){pluck$1(t,function(n,a){return e(n,a),!1})}function map(t,e){var n=isList$1(t)?[]:{};return pluck$1(t,function(a,r){return n[r]=e(a,r),!1}),n}function pluck$1(t,e){if(isList$1(t)){for(var n=0;n<t.length;n++)if(e(t[n],n))return t[n]}else for(var a in t)if(t.hasOwnProperty(a)&&e(t[a],a))return t[a]}function isList$1(t){return t!=null&&typeof t!="function"&&typeof t.length=="number"}function isFunction$1(t){return t&&{}.toString.call(t)==="[object Function]"}function isObject$1(t){return t&&{}.toString.call(t)==="[object Object]"}var util$5=util$6,slice=util$5.slice,pluck=util$5.pluck,each$6=util$5.each,bind=util$5.bind,create=util$5.create,isList=util$5.isList,isFunction=util$5.isFunction,isObject=util$5.isObject,storeEngine={createStore},storeAPI={version:"2.0.12",enabled:!1,get:function(t,e){var n=this.storage.read(this._namespacePrefix+t);return this._deserialize(n,e)},set:function(t,e){return e===void 0?this.remove(t):(this.storage.write(this._namespacePrefix+t,this._serialize(e)),e)},remove:function(t){this.storage.remove(this._namespacePrefix+t)},each:function(t){var e=this;this.storage.each(function(n,a){t.call(e,e._deserialize(n),(a||"").replace(e._namespaceRegexp,""))})},clearAll:function(){this.storage.clearAll()},hasNamespace:function(t){return this._namespacePrefix=="__storejs_"+t+"_"},createStore:function(){return createStore.apply(this,arguments)},addPlugin:function(t){this._addPlugin(t)},namespace:function(t){return createStore(this.storage,this.plugins,t)}};function _warn(){var t=typeof console>"u"?null:console;if(t){var e=t.warn?t.warn:t.log;e.apply(t,arguments)}}function createStore(t,e,n){n||(n=""),t&&!isList(t)&&(t=[t]),e&&!isList(e)&&(e=[e]);var a=n?"__storejs_"+n+"_":"",r=n?new RegExp("^"+a):null,u=/^[a-zA-Z0-9_\-]*$/;if(!u.test(n))throw new Error("store.js namespaces can only have alphanumerics + underscores and dashes");var s={_namespacePrefix:a,_namespaceRegexp:r,_testStorage:function(i){try{var c="__storejs__test__";i.write(c,c);var l=i.read(c)===c;return i.remove(c),l}catch{return!1}},_assignPluginFnProp:function(i,c){var l=this[c];this[c]=function(){var g=slice(arguments,0),p=this;function v(){if(l)return each$6(arguments,function(b,m){g[m]=b}),l.apply(p,g)}var _=[v].concat(g);return i.apply(p,_)}},_serialize:function(i){return JSON.stringify(i)},_deserialize:function(i,c){if(!i)return c;var l="";try{l=JSON.parse(i)}catch{l=i}return l!==void 0?l:c},_addStorage:function(i){this.enabled||this._testStorage(i)&&(this.storage=i,this.enabled=!0)},_addPlugin:function(i){var c=this;if(isList(i)){each$6(i,function(g){c._addPlugin(g)});return}var l=pluck(this.plugins,function(g){return i===g});if(!l){if(this.plugins.push(i),!isFunction(i))throw new Error("Plugins must be function values that return objects");var h=i.call(this);if(!isObject(h))throw new Error("Plugins must return an object of function properties");each$6(h,function(g,p){if(!isFunction(g))throw new Error("Bad plugin property: "+p+" from plugin "+i.name+". Plugins should only return functions.");c._assignPluginFnProp(g,p)})}},addStorage:function(i){_warn("store.addStorage(storage) is deprecated. Use createStore([storages])"),this._addStorage(i)}},o=create(s,storeAPI,{plugins:[]});return o.raw={},each$6(o,function(i,c){isFunction(i)&&(o.raw[c]=bind(o,i))}),each$6(t,function(i){o._addStorage(i)}),each$6(e,function(i){o._addPlugin(i)}),o}var util$4=util$6,Global$4=util$4.Global,localStorage_1={name:"localStorage",read:read$5,write:write$5,each:each$5,remove:remove$5,clearAll:clearAll$5};function localStorage(){return Global$4.localStorage}function read$5(t){return localStorage().getItem(t)}function write$5(t,e){return localStorage().setItem(t,e)}function each$5(t){for(var e=localStorage().length-1;e>=0;e--){var n=localStorage().key(e);t(read$5(n),n)}}function remove$5(t){return localStorage().removeItem(t)}function clearAll$5(){return localStorage().clear()}var util$3=util$6,Global$3=util$3.Global,oldFFGlobalStorage={name:"oldFF-globalStorage",read:read$4,write:write$4,each:each$4,remove:remove$4,clearAll:clearAll$4},globalStorage=Global$3.globalStorage;function read$4(t){return globalStorage[t]}function write$4(t,e){globalStorage[t]=e}function each$4(t){for(var e=globalStorage.length-1;e>=0;e--){var n=globalStorage.key(e);t(globalStorage[n],n)}}function remove$4(t){return globalStorage.removeItem(t)}function clearAll$4(){each$4(function(t,e){delete globalStorage[t]})}var util$2=util$6,Global$2=util$2.Global,oldIEUserDataStorage={name:"oldIE-userDataStorage",write:write$3,read:read$3,each:each$3,remove:remove$3,clearAll:clearAll$3},storageName="storejs",doc$1=Global$2.document,_withStorageEl=_makeIEStorageElFunction(),disable=(Global$2.navigator?Global$2.navigator.userAgent:"").match(/ (MSIE 8|MSIE 9|MSIE 10)\./);function write$3(t,e){if(!disable){var n=fixKey(t);_withStorageEl(function(a){a.setAttribute(n,e),a.save(storageName)})}}function read$3(t){if(!disable){var e=fixKey(t),n=null;return _withStorageEl(function(a){n=a.getAttribute(e)}),n}}function each$3(t){_withStorageEl(function(e){for(var n=e.XMLDocument.documentElement.attributes,a=n.length-1;a>=0;a--){var r=n[a];t(e.getAttribute(r.name),r.name)}})}function remove$3(t){var e=fixKey(t);_withStorageEl(function(n){n.removeAttribute(e),n.save(storageName)})}function clearAll$3(){_withStorageEl(function(t){var e=t.XMLDocument.documentElement.attributes;t.load(storageName);for(var n=e.length-1;n>=0;n--)t.removeAttribute(e[n].name);t.save(storageName)})}var forbiddenCharsRegex=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");function fixKey(t){return t.replace(/^\d/,"___$&").replace(forbiddenCharsRegex,"___")}function _makeIEStorageElFunction(){if(!doc$1||!doc$1.documentElement||!doc$1.documentElement.addBehavior)return null;var t="script",e,n,a;try{n=new ActiveXObject("htmlfile"),n.open(),n.write("<"+t+">document.w=window</"+t+'><iframe src="/favicon.ico"></iframe>'),n.close(),e=n.w.frames[0].document,a=e.createElement("div")}catch{a=doc$1.createElement("div"),e=doc$1.body}return function(r){var u=[].slice.call(arguments,0);u.unshift(a),e.appendChild(a),a.addBehavior("#default#userData"),a.load(storageName),r.apply(this,u),e.removeChild(a)}}var util$1=util$6,Global$1=util$1.Global,trim=util$1.trim,cookieStorage={name:"cookieStorage",read:read$2,write:write$2,each:each$2,remove:remove$2,clearAll:clearAll$2},doc=Global$1.document;function read$2(t){if(!t||!_has(t))return null;var e="(?:^|.*;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*";return unescape(doc.cookie.replace(new RegExp(e),"$1"))}function each$2(t){for(var e=doc.cookie.split(/; ?/g),n=e.length-1;n>=0;n--)if(trim(e[n])){var a=e[n].split("="),r=unescape(a[0]),u=unescape(a[1]);t(u,r)}}function write$2(t,e){t&&(doc.cookie=escape(t)+"="+escape(e)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")}function remove$2(t){!t||!_has(t)||(doc.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")}function clearAll$2(){each$2(function(t,e){remove$2(e)})}function _has(t){return new RegExp("(?:^|;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(doc.cookie)}var util=util$6,Global=util.Global,sessionStorage_1={name:"sessionStorage",read:read$1,write:write$1,each:each$1,remove:remove$1,clearAll:clearAll$1};function sessionStorage(){return Global.sessionStorage}function read$1(t){return sessionStorage().getItem(t)}function write$1(t,e){return sessionStorage().setItem(t,e)}function each$1(t){for(var e=sessionStorage().length-1;e>=0;e--){var n=sessionStorage().key(e);t(read$1(n),n)}}function remove$1(t){return sessionStorage().removeItem(t)}function clearAll$1(){return sessionStorage().clear()}var memoryStorage_1={name:"memoryStorage",read,write,each,remove,clearAll},memoryStorage={};function read(t){return memoryStorage[t]}function write(t,e){memoryStorage[t]=e}function each(t){for(var e in memoryStorage)memoryStorage.hasOwnProperty(e)&&t(memoryStorage[e],e)}function remove(t){delete memoryStorage[t]}function clearAll(t){memoryStorage={}}var all=[localStorage_1,oldFFGlobalStorage,oldIEUserDataStorage,cookieStorage,sessionStorage_1,memoryStorage_1],json2$1={},hasRequiredJson2;function requireJson2(){return hasRequiredJson2||(hasRequiredJson2=1,typeof JSON!="object"&&(JSON={}),function(){var rx_one=/^[\],:{}\s]*$/,rx_two=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,rx_three=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,rx_four=/(?:^|:|,)(?:\s*\[)+/g,rx_escapable=/[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,rx_dangerous=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;function f(t){return t<10?"0"+t:t}function this_value(){return this.valueOf()}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},Boolean.prototype.toJSON=this_value,Number.prototype.toJSON=this_value,String.prototype.toJSON=this_value);var gap,indent,meta,rep;function quote(t){return rx_escapable.lastIndex=0,rx_escapable.test(t)?'"'+t.replace(rx_escapable,function(e){var n=meta[e];return typeof n=="string"?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var n,a,r,u,s=gap,o,i=e[t];switch(i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(t)),typeof rep=="function"&&(i=rep.call(e,t,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,o=[],Object.prototype.toString.apply(i)==="[object Array]"){for(u=i.length,n=0;n<u;n+=1)o[n]=str(n,i)||"null";return r=o.length===0?"[]":gap?`[
`+gap+o.join(`,
`+gap)+`
`+s+"]":"["+o.join(",")+"]",gap=s,r}if(rep&&typeof rep=="object")for(u=rep.length,n=0;n<u;n+=1)typeof rep[n]=="string"&&(a=rep[n],r=str(a,i),r&&o.push(quote(a)+(gap?": ":":")+r));else for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(r=str(a,i),r&&o.push(quote(a)+(gap?": ":":")+r));return r=o.length===0?"{}":gap?`{
`+gap+o.join(`,
`+gap)+`
`+s+"}":"{"+o.join(",")+"}",gap=s,r}}typeof JSON.stringify!="function"&&(meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(t,e,n){var a;if(gap="",indent="",typeof n=="number")for(a=0;a<n;a+=1)indent+=" ";else typeof n=="string"&&(indent=n);if(rep=e,e&&typeof e!="function"&&(typeof e!="object"||typeof e.length!="number"))throw new Error("JSON.stringify");return str("",{"":t})}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){var j;function walk(t,e){var n,a,r=t[e];if(r&&typeof r=="object")for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(a=walk(r,n),a!==void 0?r[n]=a:delete r[n]);return reviver.call(t,e,r)}if(text=String(text),rx_dangerous.lastIndex=0,rx_dangerous.test(text)&&(text=text.replace(rx_dangerous,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),rx_one.test(text.replace(rx_two,"@").replace(rx_three,"]").replace(rx_four,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}()),json2$1}var json2=json2Plugin;function json2Plugin(){return requireJson2(),{}}var engine=storeEngine,storages=all,plugins=[json2],store_legacy=engine.createStore(storages,plugins);const store=getDefaultExportFromCjs(store_legacy);function osmAuth(t){var e={};e.authenticated=function(){return!!r("oauth2_access_token")},e.logout=function(){return r("oauth2_access_token",""),r("oauth_token",""),r("oauth_token_secret",""),r("oauth_request_token_secret",""),e},e.authenticate=function(s){if(e.authenticated()){s(null,e);return}e.logout(),_generatePkceChallenge(function(o){n(o,s)})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((s,o)=>{var i=(c,l)=>{c?o(new Error(c)):s(l)};_generatePkceChallenge(c=>n(c,i))}))};function n(s,o){var i=generateState(),c=t.url+"/oauth2/authorize?"+utilQsString({client_id:t.client_id,redirect_uri:t.redirect_uri,response_type:"code",scope:t.scope,state:i,code_challenge:s.code_challenge,code_challenge_method:s.code_challenge_method});if(t.singlepage){if(!store.enabled){var l=new Error("local storage unavailable, but require in singlepage mode");l.status="pkce-localstorage-unavailable",o(l);return}var h=utilStringQs(window.location.search.slice(1));h.code?e.bootstrapToken(h.code,o):(r("oauth2_state",i),r("oauth2_pkce_code_verifier",s.code_verifier),window.location=c)}else{var g=600,p=550,v=[["width",g],["height",p],["left",window.screen.width/2-g/2],["top",window.screen.height/2-p/2]].map(function(m){return m.join("=")}).join(","),_=window.open("about:blank","oauth_window",v);e.popupWindow=_,_.location=c,_||(l=new Error("Popup was blocked"),l.status="popup-blocked",o(l))}window.authComplete=function(m){var w=utilStringQs(m.split("?")[1]);if(w.state!==i){l=new Error("Invalid state"),l.status="invalid-state",o(l);return}a(w.code,s.code_verifier,b),delete window.authComplete};function b(m,w){if(t.done(),m){o(m);return}var S=JSON.parse(w.response);r("oauth2_access_token",S.access_token),o(null,e)}}function a(s,o,i){var c=t.url+"/oauth2/token?"+utilQsString({client_id:t.client_id,redirect_uri:t.redirect_uri,grant_type:"authorization_code",code:s,code_verifier:o});e.rawxhr("POST",c,null,null,null,i),t.loading()}e.bringPopupWindowToFront=function(){var s=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),s=!0)}catch{}return s},e.bootstrapToken=function(s,o){var i=r("oauth2_state");r("oauth2_state","");var c=utilStringQs(window.location.search.slice(1));if(c.state!==i){var l=new Error("Invalid state");l.status="invalid-state",o(l);return}var h=r("oauth2_pkce_code_verifier");r("oauth2_pkce_code_verifier",""),a(s,h,g);function g(p,v){if(t.done(),p){o(p);return}var _=JSON.parse(v.response);r("oauth2_access_token",_.access_token),o(null,e)}},e.fetch=function(s,o){if(e.authenticated())return i();return t.auto?e.authenticateAsync().then(i):Promise.reject(new Error("not authenticated"));function i(){return o=o||{},o.headers||(o.headers={"Content-Type":"application/x-www-form-urlencoded"}),o.headers.Authorization="Bearer "+r("oauth2_access_token"),fetch(s,o)}},e.xhr=function(s,o){if(e.authenticated())return i();if(t.auto){e.authenticate(i);return}else{o("not authenticated",null);return}function i(){var l=s.prefix!==!1?t.url+s.path:s.path;return e.rawxhr(s.method,l,r("oauth2_access_token"),s.content,s.headers,c)}function c(l,h){l?o(l):h.responseXML?o(l,h.responseXML):o(l,h.response)}},e.rawxhr=function(s,o,i,c,l,h){l=l||{"Content-Type":"application/x-www-form-urlencoded"},i&&(l.Authorization="Bearer "+i);var g=new XMLHttpRequest;g.onreadystatechange=function(){g.readyState===4&&g.status!==0&&(/^20\d$/.test(g.status)?h(null,g):h(g,null))},g.onerror=function(v){h(v,null)},g.open(s,o,!0);for(var p in l)g.setRequestHeader(p,l[p]);return g.send(c),g},e.preauth=function(s){return s&&s.access_token&&r("oauth2_access_token",s.access_token),e},e.options=function(s){return arguments.length?(t=s,t.url=t.url||"https://www.openstreetmap.org",t.auto=t.auto||!1,t.singlepage=t.singlepage||!1,t.loading=t.loading||function(){},t.done=t.done||function(){},e.preauth(t)):t};var r;if(store.enabled)r=function(s,o){if(arguments.length===1)return store.get(t.url+s);if(arguments.length===2)return store.set(t.url+s,o)};else{var u={};r=function(s,o){if(arguments.length===1)return u[t.url+s];if(arguments.length===2)return u[t.url+s]=o}}return e.options(t),e}function utilQsString(t){return Object.keys(t).filter(function(e){return t[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function utilStringQs(t){for(var e=0;e<t.length&&(t[e]==="?"||t[e]==="#");)e++;return t=t.slice(e),t.split("&").reduce(function(n,a){var r=a.split("=");return r.length===2&&(n[r[0]]=decodeURIComponent(r[1])),n},{})}function supportsWebCryptoAPI(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function _generatePkceChallenge(t){var e;if(supportsWebCryptoAPI()){var n=window.crypto.getRandomValues(new Uint8Array(32));e=base64(n.buffer);var a=Uint8Array.from(Array.from(e).map(function(s){return s.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",a).then(function(s){var o=base64(s);t({code_challenge:o,code_verifier:e,code_challenge_method:"S256"})})}else{var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var u=0;u<64;u++)e+=r[Math.floor(Math.random()*r.length)];t({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function generateState(){var t;if(supportsWebCryptoAPI()){var e=window.crypto.getRandomValues(new Uint8Array(32));t=base64(e.buffer)}else{var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";t="";for(var a=0;a<64;a++)t+=n[Math.floor(Math.random()*n.length)]}return t}function base64(t){return btoa(String.fromCharCode.apply(null,new Uint8Array(t))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class OsmPreferences{constructor(e,n){d(this,"preferences",LocalStorageSource.GetParsed("all-osm-preferences",{}));d(this,"preferenceSources",new Map);d(this,"auth");d(this,"userDetails");d(this,"longPreferences",{});this.auth=e,this.userDetails=n.userDetails;const a=this;n.OnLoggedIn(()=>(a.UpdatePreferences(!0),!0))}GetLongPreference(e,n="mapcomplete-"){if(this.longPreferences[n+e]!==void 0)return this.longPreferences[n+e];const a=new UIEventSource(void 0,"long-osm-preference:"+n+e);this.longPreferences[n+e]=a;const r=n+e+"-combined",u={prefix:""},s=this.GetPreference(r+"-length","",u);if((r+"-length").length>255)throw"This preference key is too long, it has "+e.length+" characters, but at most "+(255-7-9-n.length)+" characters are allowed";const o=this;a.addCallback(c=>{if(c===void 0||c==="")return;if(c===null){console.error("Deleting "+r);let h=parseInt(s.data);for(let g=0;g<h;g++)o.GetPreference(r+"-"+g,"",u).setData("");o.GetPreference(r+"-length","",u).setData("");return}let l=0;for(;c!=="";){if(c===void 0||c==="undefined")throw a.setData(void 0),"Got 'undefined' or a literal string containing 'undefined' for a long preference with name "+e;if(c==="undefined")throw a.setData(void 0),"Got a literal string containing 'undefined' for a long preference with name "+e;if(l>100)throw"This long preference is getting very long... ";o.GetPreference(r+"-"+l,"",u).setData(c.substr(0,255)),c=c.substr(255),l++}s.setData(""+l)});function i(c){if(Object.keys(o.preferences.data).length===0)return;const l=Number(c);if(l>100)throw"Length to long";let h="";for(let g=0;g<l;g++){const p=r+"-"+g;o.preferences.data[p]===void 0&&console.warn("Detected a broken combined preference:",p,"is undefined",o.preferences),h+=o.preferences.data[p]??""}a.setData(h)}return s.addCallback(c=>{i(Number(c))}),this.preferences.addCallbackAndRun(c=>{i(Number(s.data))}),a}GetPreference(e,n=void 0,a){const r=(a==null?void 0:a.prefix)??"mapcomplete-";if(e.startsWith(r)&&r!==""&&console.trace("A preference was requested which has a duplicate prefix in its key. This is probably a bug"),e=r+e,e=e.replace(/[:\\\/"' {}.%]/g,""),e.length>=255)throw"Preferences: key length to big";const u=this.preferenceSources.get(e);if(u!==void 0)return u;this.userDetails.data.loggedIn&&this.preferences.data[e]===void 0&&this.UpdatePreferences();const s=new UIEventSource(this.preferences.data[e]??n,"osm-preference:"+e);return s.addCallback(o=>{this.UploadPreference(e,o)}),this.preferences.addCallbackD(o=>{const i=o[e];i!==void 0&&s.setData(i)}),this.preferenceSources.set(e,s),s}ClearPreferences(){let e=!1;const n=this;this.preferences.addCallback(a=>{if(console.log("Cleaning preferences..."),Object.keys(a).length==0||e)return;e=!0;const r=["mapcomplete-"];for(const u in a)r.some(o=>u.startsWith(o))&&(console.log("Clearing ",u),n.GetPreference(u,"",{prefix:""}).setData(""));e=!1})}UpdatePreferences(e){const n=this;this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},function(a,r){if(a){console.log("Could not load preferences",a);return}const u=r.getElementsByTagName("preference"),s=new Set;for(let o=0;o<u.length;o++){const i=u[o],c=i.getAttribute("k"),l=i.getAttribute("v");n.preferences.data[c]=l,s.add(c)}if(e)for(let o in n.preferences.data)s.has(o)||(console.log("Deleting key",o,"as we didn't find it upstream"),delete n.preferences.data[o]);n.preferenceSources.forEach((o,i)=>{const c=n.preferences.data[i];c===void 0&&o.data!==void 0?n.UploadPreference(i,o.data):o.setData(c)}),n.preferences.ping()})}UploadPreference(e,n){if(!this.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(this.preferences.data[e]===n)return;const a=this;if(console.debug("Updating preference",e," to ",Utils.EllipsesAfter(n,15)),n===void 0||n===""){this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}}},function(r){if(r){console.warn("Could not remove preference",r);return}delete a.preferences.data[e],a.preferences.ping(),console.debug("Preference ",e,"removed!")});return}this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}},content:n},function(r){if(r){console.warn(`Could not set preference "${e}"'`,r);return}a.preferences.data[e]=n,a.preferences.ping(),console.debug(`Preference ${e} written!`)})}removeAllWithPrefix(e){for(const n in this.preferences.data)n.startsWith(e)&&(this.GetPreference(n,"",{prefix:""}).setData(void 0),console.log("Clearing preference",n));this.preferences.ping()}}class UserDetails{constructor(e){d(this,"loggedIn",!1);d(this,"name","Not logged in");d(this,"uid");d(this,"csCount",0);d(this,"img");d(this,"unreadMessages",0);d(this,"totalMessages",0);d(this,"home");d(this,"backend");d(this,"account_created");d(this,"tracesCount",0);d(this,"description");d(this,"languages");this.backend=e}}class OsmConnection{constructor(e){d(this,"auth");d(this,"userDetails");d(this,"isLoggedIn");d(this,"gpxServiceIsOnline",new UIEventSource("unknown"));d(this,"apiIsOnline",new UIEventSource("unknown"));d(this,"loadingStatus",new UIEventSource("not-attempted"));d(this,"preferencesHandler");d(this,"_oauth_config");d(this,"_dryRun");d(this,"fakeUser");d(this,"_onLoggedIn",[]);d(this,"_iframeMode");d(this,"_singlePage");d(this,"isChecking",!1);d(this,"_userInfoCache",{});var a;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=Constants.osmAuthConfig,console.debug("Using backend",this._oauth_config.url),this._iframeMode=Utils.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new UIEventSource(new UserDetails(this._oauth_config.url),"userDetails"),e.fakeUser){const r=this.userDetails.data;r.csCount=5678,r.uid=42,r.loggedIn=!0,r.unreadMessages=0,r.name="Fake user",r.totalMessages=42,r.languages=["en"]}const n=this;if(this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(r=>r.loggedIn&&(n.apiIsOnline.data==="unknown"||n.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(r=>{n.userDetails.data.loggedIn==!1&&r==!0&&n.AttemptLogin()}),this._dryRun=e.dryRun??new UIEventSource(!1),this.updateAuthObject(),this.preferencesHandler=new OsmPreferences(this.auth,this),((a=e.oauth_token)==null?void 0:a.data)!==void 0){console.log(e.oauth_token.data);const r=this;this.auth.bootstrapToken(e.oauth_token.data,(u,s)=>{console.log("Bootstrap token called back",u,s),r.AttemptLogin()}),e.oauth_token.setData(void 0)}this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,n=void 0,a){return this.preferencesHandler.GetPreference(e,n,a)}GetLongPreference(e,n="mapcomplete-"){return this.preferencesHandler.GetLongPreference(e,n)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted"),this.preferencesHandler.preferences.setData(void 0)}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.data!=="logged-in"&&this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}const e=this;console.log("Trying to log in..."),this.updateAuthObject(),LocalStorageSource.Get("location_before_login").setData(Utils.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},function(n,a){var l;if(n!=null){console.log(n),e.loadingStatus.setData("error"),n.status==401&&(console.log("Clearing tokens..."),e.auth.logout(),e.LogOut());return}if(a==null){e.loadingStatus.setData("error");return}e.CheckForMessagesContinuously();let r=a.getElementsByTagName("user")[0],u=e.userDetails.data;u.loggedIn=!0,console.log("Login completed, userinfo is ",r),u.name=r.getAttribute("display_name"),u.account_created=r.getAttribute("account_created"),u.uid=Number(r.getAttribute("id")),u.languages=Array.from(r.getElementsByTagName("languages")[0].getElementsByTagName("lang")).map(h=>h.textContent),u.csCount=Number.parseInt(r.getElementsByTagName("changesets")[0].getAttribute("count")??"0"),u.tracesCount=Number.parseInt(r.getElementsByTagName("traces")[0].getAttribute("count")??"0"),u.img=void 0;const s=r.getElementsByTagName("img");s!==void 0&&s[0]!==void 0&&(u.img=s[0].getAttribute("href"));const o=r.getElementsByTagName("description");o!==void 0&&o[0]!==void 0&&(u.description=(l=o[0])==null?void 0:l.innerHTML);const i=r.getElementsByTagName("home");if(i!==void 0&&i[0]!==void 0){const h=parseFloat(i[0].getAttribute("lat")),g=parseFloat(i[0].getAttribute("lon"));u.home={lat:h,lon:g}}e.loadingStatus.setData("logged-in");const c=r.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];u.unreadMessages=parseInt(c.getAttribute("unread")),u.totalMessages=parseInt(c.getAttribute("count")),e.userDetails.ping();for(const h of e._onLoggedIn)h(e.userDetails.data);e._onLoggedIn=[]})}async interact(e,n,a,r,u=!1){let s=this.auth;if(u&&!this.auth.authenticated()){const o=await Utils.downloadAdvanced(`${this.Backend()}/api/0.6/${e}`,a,n,r);if(o.content)return o.content;throw console.error(o),"Could not interact with OSM:"+o.error}return new Promise((o,i)=>{s.xhr({method:n,options:{header:a},content:r,path:`/api/0.6/${e}`},function(c,l){c!==null?i(c):o(l)})})}async post(e,n,a,r=!1){return await this.interact(e,"POST",a,n,r)}async put(e,n,a){return await this.interact(e,"PUT",a,n)}async get(e,n,a=!1){return await this.interact(e,"GET",n,void 0,a)}closeNote(e,n){let a="";return(n??"")!==""&&(a="?text="+encodeURIComponent(n)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",n),new Promise(r=>{r()})):this.post(`notes/${e}/close${a}`)}reopenNote(e,n){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",n),new Promise(r=>{r()});let a="";return(n??"")!==""&&(a="?text="+encodeURIComponent(n)),this.post(`notes/${e}/reopen${a}`)}async openNote(e,n,a){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",a),new Promise(i=>{window.setTimeout(()=>i({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const r=`lat=${e}&lon=${n}&text=${encodeURIComponent(a)}`,u=await this.post("notes.json",r,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},!0),s=JSON.parse(u);console.log("Got result:",s);const o=s.properties;return console.log("OPENED NOTE",o),o}async uploadGpxTrack(e,n){var c;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise((l,h)=>{window.setTimeout(()=>l({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const a={file:e,description:n.description??"",tags:((c=n.labels)==null?void 0:c.join(","))??"",visibility:n.visibility},r={file:'; filename="'+(n.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},u="987654";let s="";for(const l in a)s+="--"+u+`\r
`,s+='Content-Disposition: form-data; name="'+l+'"',r[l]!==void 0&&(s+=r[l]),s+=`\r
\r
`,s+=a[l]+`\r
`;s+="--"+u+`--\r
`;const o=await this.post("gpx/create",s,{"Content-Type":"multipart/form-data; boundary="+u,"Content-Length":s.length}),i=JSON.parse(o);return console.log("Uploaded GPX track",i),{id:i}}addCommentToNote(e,n){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",n,"to  note ",e),new Promise(a=>{a()});if((n??"")==="")throw"Invalid text!";return new Promise((a,r)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(n)}`},function(u,s){u!==null?r(u):a()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const n=LocalStorageSource.Get("location_before_login");e(n.data)})}updateAuthObject(){let e=!1;try{(Utils.runningFromConsole||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches)&&(e=!0)}catch(a){console.warn("Detecting standalone mode failed",a,". Assuming in browser and not worrying furhter")}const n=this._iframeMode||e||!this._singlePage;this.auth=new osmAuth({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes openid",redirect_uri:Utils.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!n,auto:!0})}CheckForMessagesContinuously(){const e=this;this.isChecking||(this.isChecking=!0,Stores.Chronic(5*60*1e3).addCallback(n=>{e.isLoggedIn.data&&e.AttemptLogin()}))}UpdateCapabilities(){const e=this;this.fakeUser||this.FetchCapabilities().then(({api:n,gpx:a})=>{e.apiIsOnline.setData(n),e.gpxServiceIsOnline.setData(a)})}async getInformationAboutUser(e){if(e===void 0)return;if(this._userInfoCache[e])return this._userInfoCache[e];const n=await this.get("user/"+e+".json",{accepts:"application/json"},!0),a=JSON.parse(n).user;return this._userInfoCache[e]=a,a}async FetchCapabilities(){if(Utils.runningFromConsole)return{api:"online",gpx:"online"};const e=await Utils.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const n=e.content,r=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("status")[0],u=r.getAttribute("api"),s=r.getAttribute("gpx");return{api:u,gpx:s}}}export{OsmConnection as O};
//# sourceMappingURL=OsmConnection-96b514da.js.map
