var E=Object.defineProperty;var O=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>(O(i,typeof e!="symbol"?e+"":e,t),t);import{s as C}from"./store.legacy-2a1c0432.js";import{L as T,U as m,S as k}from"./LocalStorageSource-c5c8bac2.js";import{U as p}from"./Utils-17869047.js";import{C as L}from"./Constants-88fd7050.js";function x(i){var e={};e.authenticated=function(){return!!n("oauth2_access_token")},e.logout=function(){return n("oauth2_access_token",""),n("oauth_token",""),n("oauth_token_secret",""),n("oauth_request_token_secret",""),e},e.authenticate=function(o){if(e.authenticated()){o(null,e);return}e.logout(),I(function(a){t(a,o)})},e.authenticateAsync=function(){return e.authenticated()?Promise.resolve(e):(e.logout(),new Promise((o,a)=>{var u=(l,c)=>{l?a(new Error(l)):o(c)};I(l=>t(l,u))}))};function t(o,a){var u=M(),l=i.url+"/oauth2/authorize?"+P({client_id:i.client_id,redirect_uri:i.redirect_uri,response_type:"code",scope:i.scope,state:u,code_challenge:o.code_challenge,code_challenge_method:o.code_challenge_method});if(i.singlepage){if(!C.enabled){var c=new Error("local storage unavailable, but require in singlepage mode");c.status="pkce-localstorage-unavailable",a(c);return}var f=y(window.location.search.slice(1));f.code?e.bootstrapToken(f.code,a):(n("oauth2_state",u),n("oauth2_pkce_code_verifier",o.code_verifier),window.location=l)}else{var h=600,g=550,w=[["width",h],["height",g],["left",window.screen.width/2-h/2],["top",window.screen.height/2-g/2]].map(function(_){return _.join("=")}).join(","),v=window.open("about:blank","oauth_window",w);e.popupWindow=v,v.location=l,v||(c=new Error("Popup was blocked"),c.status="popup-blocked",a(c))}window.authComplete=function(_){var b=y(_.split("?")[1]);if(b.state!==u){c=new Error("Invalid state"),c.status="invalid-state",a(c);return}r(b.code,o.code_verifier,S),delete window.authComplete};function S(_,b){if(i.done(),_){a(_);return}var U=JSON.parse(b.response);n("oauth2_access_token",U.access_token),a(null,e)}}function r(o,a,u){var l=i.url+"/oauth2/token?"+P({client_id:i.client_id,redirect_uri:i.redirect_uri,grant_type:"authorization_code",code:o,code_verifier:a});e.rawxhr("POST",l,null,null,null,u),i.loading()}e.bringPopupWindowToFront=function(){var o=!1;try{e.popupWindow&&!e.popupWindow.closed&&(e.popupWindow.focus(),o=!0)}catch{}return o},e.bootstrapToken=function(o,a){var u=n("oauth2_state");n("oauth2_state","");var l=y(window.location.search.slice(1));if(l.state!==u){var c=new Error("Invalid state");c.status="invalid-state",a(c);return}var f=n("oauth2_pkce_code_verifier");n("oauth2_pkce_code_verifier",""),r(o,f,h);function h(g,w){if(i.done(),g){a(g);return}var v=JSON.parse(w.response);n("oauth2_access_token",v.access_token),a(null,e)}},e.fetch=function(o,a){if(e.authenticated())return u();return i.auto?e.authenticateAsync().then(u):Promise.reject(new Error("not authenticated"));function u(){return a=a||{},a.headers||(a.headers={"Content-Type":"application/x-www-form-urlencoded"}),a.headers.Authorization="Bearer "+n("oauth2_access_token"),fetch(o,a)}},e.xhr=function(o,a){if(e.authenticated())return u();if(i.auto){e.authenticate(u);return}else{a("not authenticated",null);return}function u(){var c=o.prefix!==!1?i.url+o.path:o.path;return e.rawxhr(o.method,c,n("oauth2_access_token"),o.content,o.headers,l)}function l(c,f){c?a(c):f.responseXML?a(c,f.responseXML):a(c,f.response)}},e.rawxhr=function(o,a,u,l,c,f){c=c||{"Content-Type":"application/x-www-form-urlencoded"},u&&(c.Authorization="Bearer "+u);var h=new XMLHttpRequest;h.onreadystatechange=function(){h.readyState===4&&h.status!==0&&(/^20\d$/.test(h.status)?f(null,h):f(h,null))},h.onerror=function(w){f(w,null)},h.open(o,a,!0);for(var g in c)h.setRequestHeader(g,c[g]);return h.send(l),h},e.preauth=function(o){return o&&o.access_token&&n("oauth2_access_token",o.access_token),e},e.options=function(o){return arguments.length?(i=o,i.url=i.url||"https://www.openstreetmap.org",i.auto=i.auto||!1,i.singlepage=i.singlepage||!1,i.loading=i.loading||function(){},i.done=i.done||function(){},e.preauth(i)):i};var n;if(C.enabled)n=function(o,a){if(arguments.length===1)return C.get(i.url+o);if(arguments.length===2)return C.set(i.url+o,a)};else{var s={};n=function(o,a){if(arguments.length===1)return s[i.url+o];if(arguments.length===2)return s[i.url+o]=a}}return e.options(i),e}function P(i){return Object.keys(i).filter(function(e){return i[e]!==void 0}).sort().map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(i[e])}).join("&")}function y(i){for(var e=0;e<i.length&&(i[e]==="?"||i[e]==="#");)e++;return i=i.slice(e),i.split("&").reduce(function(t,r){var n=r.split("=");return n.length===2&&(t[n[0]]=decodeURIComponent(n[1])),t},{})}function A(){return window&&window.crypto&&window.crypto.getRandomValues&&window.crypto.subtle&&window.crypto.subtle.digest}function I(i){var e;if(A()){var t=window.crypto.getRandomValues(new Uint8Array(32));e=D(t.buffer);var r=Uint8Array.from(Array.from(e).map(function(o){return o.charCodeAt(0)}));window.crypto.subtle.digest("SHA-256",r).then(function(o){var a=D(o);i({code_challenge:a,code_verifier:e,code_challenge_method:"S256"})})}else{var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";e="";for(var s=0;s<64;s++)e+=n[Math.floor(Math.random()*n.length)];i({code_verifier:e,code_challenge:e,code_challenge_method:"plain"})}}function M(){var i;if(A()){var e=window.crypto.getRandomValues(new Uint8Array(32));i=D(e.buffer)}else{var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";i="";for(var r=0;r<64;r++)i+=t[Math.floor(Math.random()*t.length)]}return i}function D(i){return btoa(String.fromCharCode.apply(null,new Uint8Array(i))).replace(/\//g,"_").replace(/\+/g,"-").replace(/[=]/g,"")}class N{constructor(e,t){d(this,"preferences",T.GetParsed("all-osm-preferences",{}));d(this,"preferenceSources",new Map);d(this,"auth");d(this,"userDetails");d(this,"longPreferences",{});this.auth=e,this.userDetails=t.userDetails;const r=this;t.OnLoggedIn(()=>r.UpdatePreferences())}GetLongPreference(e,t="mapcomplete-"){if(this.longPreferences[t+e]!==void 0)return this.longPreferences[t+e];const r=new m(void 0,"long-osm-preference:"+t+e);this.longPreferences[t+e]=r;const n=t+e+"-combined",s={prefix:""},o=this.GetPreference(n+"-length","",s);if((n+"-length").length>255)throw"This preference key is too long, it has "+e.length+" characters, but at most "+(255-7-9-t.length)+" characters are allowed";const a=this;r.addCallback(l=>{if(l===void 0||l==="")return;if(l===null){console.error("Deleting "+n);let f=parseInt(o.data);for(let h=0;h<f;h++)a.GetPreference(n+"-"+h,"",s).setData("");a.GetPreference(n+"-length","",s).setData("");return}let c=0;for(;l!=="";){if(l===void 0||l==="undefined")throw"Got 'undefined' or a literal string containing 'undefined' for a long preference with name "+e;if(c>100)throw"This long preference is getting very long... ";a.GetPreference(n+"-"+c,"",s).setData(l.substr(0,255)),l=l.substr(255),c++}o.setData(""+c)});function u(l){if(Object.keys(a.preferences.data).length===0)return;const c=Number(l);if(c>100)throw"Length to long";let f="";for(let h=0;h<c;h++){const g=n+"-"+h;a.preferences.data[g]===void 0&&console.warn("Detected a broken combined preference:",g,"is undefined",a.preferences),f+=a.preferences.data[g]??""}r.setData(f)}return o.addCallback(l=>{u(Number(l))}),this.preferences.addCallbackAndRun(l=>{u(Number(o.data))}),r}GetPreference(e,t=void 0,r){const n=(r==null?void 0:r.prefix)??"mapcomplete-";if(e.startsWith(n)&&n!==""&&console.trace("A preference was requested which has a duplicate prefix in its key. This is probably a bug"),e=n+e,e=e.replace(/[:\\\/"' {}.%]/g,""),e.length>=255)throw"Preferences: key length to big";const s=this.preferenceSources.get(e);if(s!==void 0)return s;this.userDetails.data.loggedIn&&this.preferences.data[e]===void 0&&this.UpdatePreferences();const o=new m(this.preferences.data[e]??t,"osm-preference:"+e);return o.addCallback(a=>{this.UploadPreference(e,a)}),this.preferences.addCallbackD(a=>{const u=a[e];u!==void 0&&o.setData(u)}),this.preferenceSources.set(e,o),o}ClearPreferences(){let e=!1;const t=this;this.preferences.addCallback(r=>{if(console.log("Cleaning preferences..."),Object.keys(r).length==0||e)return;e=!0;const n=["mapcomplete-"];for(const s in r)n.some(a=>s.startsWith(a))&&(console.log("Clearing ",s),t.GetPreference(s,"",{prefix:""}).setData(""));e=!1})}UpdatePreferences(){const e=this;this.auth.xhr({method:"GET",path:"/api/0.6/user/preferences"},function(t,r){if(t){console.log("Could not load preferences",t);return}const n=r.getElementsByTagName("preference");for(let s=0;s<n.length;s++){const o=n[s],a=o.getAttribute("k"),u=o.getAttribute("v");e.preferences.data[a]=u}e.preferenceSources.forEach((s,o)=>{const a=e.preferences.data[o];a===void 0&&s.data!==void 0?e.UploadPreference(o,s.data):s.setData(a)}),e.preferences.ping()})}UploadPreference(e,t){if(!this.userDetails.data.loggedIn){console.debug(`Not saving preference ${e}: user not logged in`);return}if(this.preferences.data[e]===t)return;const r=this;if(console.debug("Updating preference",e," to ",p.EllipsesAfter(t,15)),t===void 0||t===""){this.auth.xhr({method:"DELETE",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}}},function(n){if(n){console.warn("Could not remove preference",n);return}delete r.preferences.data[e],r.preferences.ping(),console.debug("Preference ",e,"removed!")});return}this.auth.xhr({method:"PUT",path:"/api/0.6/user/preferences/"+encodeURIComponent(e),options:{header:{"Content-Type":"text/plain"}},content:t},function(n){if(n){console.warn(`Could not set preference "${e}"'`,n);return}r.preferences.data[e]=t,r.preferences.ping(),console.debug(`Preference ${e} written!`)})}}class R{constructor(e){d(this,"loggedIn",!1);d(this,"name","Not logged in");d(this,"uid");d(this,"csCount",0);d(this,"img");d(this,"unreadMessages",0);d(this,"totalMessages",0);d(this,"home");d(this,"backend");d(this,"account_created");d(this,"tracesCount",0);d(this,"description");this.backend=e}}class j{constructor(e){d(this,"auth");d(this,"userDetails");d(this,"isLoggedIn");d(this,"gpxServiceIsOnline",new m("unknown"));d(this,"apiIsOnline",new m("unknown"));d(this,"loadingStatus",new m("not-attempted"));d(this,"preferencesHandler");d(this,"_oauth_config");d(this,"_dryRun");d(this,"fakeUser");d(this,"_onLoggedIn",[]);d(this,"_iframeMode");d(this,"_singlePage");d(this,"isChecking",!1);var r;if(e??(e={}),this.fakeUser=(e==null?void 0:e.fakeUser)??!1,this._singlePage=(e==null?void 0:e.singlePage)??!0,this._oauth_config=L.osmAuthConfig,console.debug("Using backend",this._oauth_config.url),this._iframeMode=p.runningFromConsole?!1:window!==window.top,{}.VITE_OSM_OAUTH_CLIENT_ID!==void 0&&{}.VITE_OSM_OAUTH_SECRET!==void 0&&(console.debug("Using environment variables for oauth config"),this._oauth_config.oauth_client_id={}.VITE_OSM_OAUTH_CLIENT_ID,this._oauth_config.oauth_secret={}.VITE_OSM_OAUTH_SECRET),this.userDetails=new m(new R(this._oauth_config.url),"userDetails"),e.fakeUser){const n=this.userDetails.data;n.csCount=5678,n.loggedIn=!0,n.unreadMessages=0,n.name="Fake user",n.totalMessages=42}const t=this;if(this.UpdateCapabilities(),this.isLoggedIn=this.userDetails.map(n=>n.loggedIn&&(t.apiIsOnline.data==="unknown"||t.apiIsOnline.data==="online"),[this.apiIsOnline]),this.isLoggedIn.addCallback(n=>{t.userDetails.data.loggedIn==!1&&n==!0&&t.AttemptLogin()}),this._dryRun=e.dryRun??new m(!1),this.updateAuthObject(),this.preferencesHandler=new N(this.auth,this),((r=e.oauth_token)==null?void 0:r.data)!==void 0){console.log(e.oauth_token.data);const n=this;this.auth.bootstrapToken(e.oauth_token.data,(s,o)=>{console.log("Bootstrap token called back",s,o),n.AttemptLogin()}),e.oauth_token.setData(void 0)}this.auth.authenticated()&&e.attemptLogin!==!1?this.AttemptLogin():console.log("Not authenticated")}GetPreference(e,t=void 0,r){return this.preferencesHandler.GetPreference(e,t,r)}GetLongPreference(e,t="mapcomplete-"){return this.preferencesHandler.GetLongPreference(e,t)}OnLoggedIn(e){this._onLoggedIn.push(e)}LogOut(){this.auth.logout(),this.userDetails.data.loggedIn=!1,this.userDetails.data.csCount=0,this.userDetails.data.name="",this.userDetails.ping(),console.log("Logged out"),this.loadingStatus.setData("not-attempted")}Backend(){return this._oauth_config.url}AttemptLogin(){if(this.UpdateCapabilities(),this.loadingStatus.setData("loading"),this.fakeUser){this.loadingStatus.setData("logged-in"),console.log("AttemptLogin called, but ignored as fakeUser is set");return}const e=this;console.log("Trying to log in..."),this.updateAuthObject(),T.Get("location_before_login").setData(p.runningFromConsole?void 0:window.location.href),this.auth.xhr({method:"GET",path:"/api/0.6/user/details"},function(t,r){var c;if(t!=null){console.log(t),e.loadingStatus.setData("error"),t.status==401&&(console.log("Clearing tokens..."),e.auth.logout(),e.LogOut());return}if(r==null){e.loadingStatus.setData("error");return}e.CheckForMessagesContinuously();let n=r.getElementsByTagName("user")[0],s=e.userDetails.data;s.loggedIn=!0,console.log("Login completed, userinfo is ",n),s.name=n.getAttribute("display_name"),s.account_created=n.getAttribute("account_created"),s.uid=Number(n.getAttribute("id")),s.csCount=Number.parseInt(n.getElementsByTagName("changesets")[0].getAttribute("count")??0),s.tracesCount=Number.parseInt(n.getElementsByTagName("traces")[0].getAttribute("count")??0),s.img=void 0;const o=n.getElementsByTagName("img");o!==void 0&&o[0]!==void 0&&(s.img=o[0].getAttribute("href"));const a=n.getElementsByTagName("description");a!==void 0&&a[0]!==void 0&&(s.description=(c=a[0])==null?void 0:c.innerHTML);const u=n.getElementsByTagName("home");if(u!==void 0&&u[0]!==void 0){const f=parseFloat(u[0].getAttribute("lat")),h=parseFloat(u[0].getAttribute("lon"));s.home={lat:f,lon:h}}e.loadingStatus.setData("logged-in");const l=n.getElementsByTagName("messages")[0].getElementsByTagName("received")[0];s.unreadMessages=parseInt(l.getAttribute("unread")),s.totalMessages=parseInt(l.getAttribute("count")),e.userDetails.ping();for(const f of e._onLoggedIn)f(e.userDetails.data);e._onLoggedIn=[]})}async interact(e,t,r,n,s=!1){let o=this.auth;if(s&&!this.auth.authenticated()){const a=await p.downloadAdvanced(`${this.Backend()}/api/0.6/${e}`,r,t,n);if(a.content)return a.content;throw console.error(a),"Could not interact with OSM:"+a.error}return new Promise((a,u)=>{o.xhr({method:t,options:{header:r},content:n,path:`/api/0.6/${e}`},function(l,c){l!==null?u(l):a(c)})})}async post(e,t,r,n=!1){return await this.interact(e,"POST",r,t,n)}async put(e,t,r){return await this.interact(e,"PUT",r,t)}async get(e,t){return await this.interact(e,"GET",t)}closeNote(e,t){let r="";return(t??"")!==""&&(r="?text="+encodeURIComponent(t)),this._dryRun.data?(console.warn("Dryrun enabled - not actually closing note ",e," with text ",t),new Promise(n=>{n()})):this.post(`notes/${e}/close${r}`)}reopenNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually reopening note ",e," with text ",t),new Promise(n=>{n()});let r="";return(t??"")!==""&&(r="?text="+encodeURIComponent(t)),this.post(`notes/${e}/reopen${r}`)}async openNote(e,t,r){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually opening note with text ",r),new Promise(u=>{window.setTimeout(()=>u({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const n=`lat=${e}&lon=${t}&text=${encodeURIComponent(r)}`,s=await this.post("notes.json",n,{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},!0),o=JSON.parse(s);console.log("Got result:",o);const a=o.properties;return console.log("OPENED NOTE",a),a}async uploadGpxTrack(e,t){var l;if(this._dryRun.data)return console.warn("Dryrun enabled - not actually uploading GPX ",e),new Promise((c,f)=>{window.setTimeout(()=>c({id:Math.floor(Math.random()*1e3)}),Math.random()*5e3)});const r={file:e,description:t.description??"",tags:((l=t.labels)==null?void 0:l.join(","))??"",visibility:t.visibility},n={file:'; filename="'+(t.filename??"gpx_track_mapcomplete_"+new Date().toISOString())+`"\r
Content-Type: application/gpx+xml`},s="987654";let o="";for(const c in r)o+="--"+s+`\r
`,o+='Content-Disposition: form-data; name="'+c+'"',n[c]!==void 0&&(o+=n[c]),o+=`\r
\r
`,o+=r[c]+`\r
`;o+="--"+s+`--\r
`;const a=await this.post("gpx/create",o,{"Content-Type":"multipart/form-data; boundary="+s,"Content-Length":o.length}),u=JSON.parse(a);return console.log("Uploaded GPX track",u),{id:u}}addCommentToNote(e,t){if(this._dryRun.data)return console.warn("Dryrun enabled - not actually adding comment ",t,"to  note ",e),new Promise(r=>{r()});if((t??"")==="")throw"Invalid text!";return new Promise((r,n)=>{this.auth.xhr({method:"POST",path:`/api/0.6/notes/${e}/comment?text=${encodeURIComponent(t)}`},function(s,o){s!==null?n(s):r()})})}finishLogin(e){this.auth.authenticate(function(){console.log("Authentication successful!");const t=T.Get("location_before_login");e(t.data)})}updateAuthObject(){let e=!1;try{(p.runningFromConsole||window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches)&&(e=!0)}catch(r){console.warn("Detecting standalone mode failed",r,". Assuming in browser and not worrying furhter")}const t=this._iframeMode||e||!this._singlePage;this.auth=new x({client_id:this._oauth_config.oauth_client_id,url:this._oauth_config.url,scope:"read_prefs write_prefs write_api write_gpx write_notes openid",redirect_uri:p.runningFromConsole?"https://mapcomplete.org/land.html":window.location.protocol+"//"+window.location.host+"/land.html",singlepage:!t,auto:!0})}CheckForMessagesContinuously(){const e=this;this.isChecking||(this.isChecking=!0,k.Chronic(5*60*1e3).addCallback(t=>{e.isLoggedIn.data&&(console.log("Checking for messages"),e.AttemptLogin())}))}UpdateCapabilities(){const e=this;this.FetchCapabilities().then(({api:t,gpx:r})=>{e.apiIsOnline.setData(t),e.gpxServiceIsOnline.setData(r)})}async FetchCapabilities(){if(p.runningFromConsole)return{api:"online",gpx:"online"};const e=await p.downloadAdvanced(this.Backend()+"/api/0.6/capabilities");if(e.content===void 0)return console.log("Something went wrong:",e),{api:"unreachable",gpx:"unreachable"};const t=e.content,n=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("status")[0],s=n.getAttribute("api"),o=n.getAttribute("gpx");return{api:s,gpx:o}}}export{j as O};
