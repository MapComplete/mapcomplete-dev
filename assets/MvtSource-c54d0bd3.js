var N=Object.defineProperty;var R=(e,t,i)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var f=(e,t,i)=>(R(e,typeof t!="symbol"?t+"":t,i),i);import{U as I}from"./UIEventSource-b2e0ae35.js";import{g as U}from"./_commonjsHelpers-de833af9.js";import{i as G}from"./index-44f7831e.js";var L=o,y=G;function o(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}o.Varint=0;o.Fixed64=1;o.Bytes=2;o.Fixed32=5;var m=65536*65536,M=1/m,z=12,E=typeof TextDecoder>"u"?null:new TextDecoder("utf8");o.prototype={destroy:function(){this.buf=null},readFields:function(e,t,i){for(i=i||this.length;this.pos<i;){var r=this.readVarint(),s=r>>3,n=this.pos;this.type=r&7,e(s,t,this),this.pos===n&&this.skip(r)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=p(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=T(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=p(this.buf,this.pos)+p(this.buf,this.pos+4)*m;return this.pos+=8,e},readSFixed64:function(){var e=p(this.buf,this.pos)+T(this.buf,this.pos+4)*m;return this.pos+=8,e},readFloat:function(){var e=y.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=y.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t=this.buf,i,r;return r=t[this.pos++],i=r&127,r<128||(r=t[this.pos++],i|=(r&127)<<7,r<128)||(r=t[this.pos++],i|=(r&127)<<14,r<128)||(r=t[this.pos++],i|=(r&127)<<21,r<128)?i:(r=t[this.pos],i|=(r&15)<<28,H(i,e,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2===1?(e+1)/-2:e/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=z&&E?tt(this.buf,t,e):b(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==o.Bytes)return e.push(this.readVarint(t));var i=x(this);for(e=e||[];this.pos<i;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==o.Bytes)return e.push(this.readSVarint());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==o.Bytes)return e.push(this.readBoolean());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==o.Bytes)return e.push(this.readFloat());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==o.Bytes)return e.push(this.readDouble());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==o.Bytes)return e.push(this.readFixed32());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==o.Bytes)return e.push(this.readSFixed32());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==o.Bytes)return e.push(this.readFixed64());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==o.Bytes)return e.push(this.readSFixed64());var t=x(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=e&7;if(t===o.Varint)for(;this.buf[this.pos++]>127;);else if(t===o.Bytes)this.pos=this.readVarint()+this.pos;else if(t===o.Fixed32)this.pos+=4;else if(t===o.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+t)},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),w(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),w(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),w(this.buf,e&-1,this.pos),w(this.buf,Math.floor(e*M),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),w(this.buf,e&-1,this.pos),w(this.buf,Math.floor(e*M),this.pos+4),this.pos+=8},writeVarint:function(e){if(e=+e||0,e>268435455||e<0){O(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))},writeSVarint:function(e){this.writeVarint(e<0?-e*2-1:e*2)},writeBoolean:function(e){this.writeVarint(!!e)},writeString:function(e){e=String(e),this.realloc(e.length*4),this.pos++;var t=this.pos;this.pos=et(this.buf,e,this.pos);var i=this.pos-t;i>=128&&C(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i},writeFloat:function(e){this.realloc(4),y.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),y.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var i=0;i<t;i++)this.buf[this.pos++]=e[i]},writeRawMessage:function(e,t){this.pos++;var i=this.pos;e(t,this);var r=this.pos-i;r>=128&&C(i,r,this),this.pos=i-1,this.writeVarint(r),this.pos+=r},writeMessage:function(e,t,i){this.writeTag(e,o.Bytes),this.writeRawMessage(t,i)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,W,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,X,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,K,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,Y,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,$,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,Q,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,Z,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,q,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,j,t)},writeBytesField:function(e,t){this.writeTag(e,o.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,o.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,o.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,o.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,!!t)}};function H(e,t,i){var r=i.buf,s,n;if(n=r[i.pos++],s=(n&112)>>4,n<128||(n=r[i.pos++],s|=(n&127)<<3,n<128)||(n=r[i.pos++],s|=(n&127)<<10,n<128)||(n=r[i.pos++],s|=(n&127)<<17,n<128)||(n=r[i.pos++],s|=(n&127)<<24,n<128)||(n=r[i.pos++],s|=(n&1)<<31,n<128))return c(e,s,t);throw new Error("Expected varint not more than 10 bytes")}function x(e){return e.type===o.Bytes?e.readVarint()+e.pos:e.pos+1}function c(e,t,i){return i?t*4294967296+(e>>>0):(t>>>0)*4294967296+(e>>>0)}function O(e,t){var i,r;if(e>=0?(i=e%4294967296|0,r=e/4294967296|0):(i=~(-e%4294967296),r=~(-e/4294967296),i^4294967295?i=i+1|0:(i=0,r=r+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),A(i,r,t),J(r,t)}function A(e,t,i){i.buf[i.pos++]=e&127|128,e>>>=7,i.buf[i.pos++]=e&127|128,e>>>=7,i.buf[i.pos++]=e&127|128,e>>>=7,i.buf[i.pos++]=e&127|128,e>>>=7,i.buf[i.pos]=e&127}function J(e,t){var i=(e&7)<<4;t.buf[t.pos++]|=i|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127)))))}function C(e,t,i){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));i.realloc(r);for(var s=i.pos-1;s>=e;s--)i.buf[s+r]=i.buf[s]}function W(e,t){for(var i=0;i<e.length;i++)t.writeVarint(e[i])}function X(e,t){for(var i=0;i<e.length;i++)t.writeSVarint(e[i])}function Y(e,t){for(var i=0;i<e.length;i++)t.writeFloat(e[i])}function $(e,t){for(var i=0;i<e.length;i++)t.writeDouble(e[i])}function K(e,t){for(var i=0;i<e.length;i++)t.writeBoolean(e[i])}function Q(e,t){for(var i=0;i<e.length;i++)t.writeFixed32(e[i])}function Z(e,t){for(var i=0;i<e.length;i++)t.writeSFixed32(e[i])}function q(e,t){for(var i=0;i<e.length;i++)t.writeFixed64(e[i])}function j(e,t){for(var i=0;i<e.length;i++)t.writeSFixed64(e[i])}function p(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+e[t+3]*16777216}function w(e,t,i){e[i]=t,e[i+1]=t>>>8,e[i+2]=t>>>16,e[i+3]=t>>>24}function T(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}function b(e,t,i){for(var r="",s=t;s<i;){var n=e[s],a=null,u=n>239?4:n>223?3:n>191?2:1;if(s+u>i)break;var l,h,d;u===1?n<128&&(a=n):u===2?(l=e[s+1],(l&192)===128&&(a=(n&31)<<6|l&63,a<=127&&(a=null))):u===3?(l=e[s+1],h=e[s+2],(l&192)===128&&(h&192)===128&&(a=(n&15)<<12|(l&63)<<6|h&63,(a<=2047||a>=55296&&a<=57343)&&(a=null))):u===4&&(l=e[s+1],h=e[s+2],d=e[s+3],(l&192)===128&&(h&192)===128&&(d&192)===128&&(a=(n&15)<<18|(l&63)<<12|(h&63)<<6|d&63,(a<=65535||a>=1114112)&&(a=null))),a===null?(a=65533,u=1):a>65535&&(a-=65536,r+=String.fromCharCode(a>>>10&1023|55296),a=56320|a&1023),r+=String.fromCharCode(a),s+=u}return r}function tt(e,t,i){return E.decode(e.subarray(t,i))}function et(e,t,i){for(var r=0,s,n;r<t.length;r++){if(s=t.charCodeAt(r),s>55295&&s<57344)if(n)if(s<56320){e[i++]=239,e[i++]=191,e[i++]=189,n=s;continue}else s=n-55296<<10|s-56320|65536,n=null;else{s>56319||r+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):n=s;continue}else n&&(e[i++]=239,e[i++]=191,e[i++]=189,n=null);s<128?e[i++]=s:(s<2048?e[i++]=s>>6|192:(s<65536?e[i++]=s>>12|224:(e[i++]=s>>18|240,e[i++]=s>>12&63|128),e[i++]=s>>6&63|128),e[i++]=s&63|128)}return i}const it=U(L),F=class F{constructor(t,i,r,s){f(this,"_size");f(this,"_x0");f(this,"_y0");this._size=t*Math.pow(2,s),this._x0=t*i,this._y0=t*r}static signedArea(t){let i=0;const r=t.length;let s=r-1,n,a;for(let u=0;u<r;u++)n=t[u],a=t[s],i+=(a.x-n.x)*(n.y+a.y),s=u;return i}static classifyRings(t){if(t.length<=0)throw"Now rings in polygon found";if(t.length==1)return[t];const i=[];let r;for(let s=0;s<t.length;s++){let n=t[s];const a=this.signedArea(n);if(a===0)continue;a<0===a<0?(r&&i.push(r),r=[n]):r.push(n)}return r&&i.push(r),i}toGeoJson(t,i,r){let s=this.encodeGeometry(t),n;switch(i){case 1:const l=[];for(let h=0;h<s.length;h++)l[h]=s[h][0];s=l,this.project(s);break;case 2:for(let h=0;h<s.length;h++)this.project(s[h]);break;case 3:n=F.classifyRings(s);for(let h=0;h<n.length;h++)for(let d=0;d<n[h].length;d++)this.project(n[h][d]);break}let a=F.geom_types[i],u;return s.length===1?u=(n??s)[0]:(u=n??s,a="Multi"+a),{type:"Feature",geometry:{type:a,coordinates:u},properties:r}}encodeGeometry(t){let i=0,r=0,s=[],n=[];for(let a=0;a<t.length;a++){let u=t[a],l=u&7,h=u>>3;if(l===1&&n.length!==0&&(s.push(n),n=[]),l===1||l===2){for(let d=0;d<h;d++){const P=t[a+d*2+1];i+=P>>1^-(P&1);const D=t[a+d*2+2];r+=D>>1^-(D&1),n.push([i,r])}a+=h*2}l===7&&(n.push([...n[0]]),a++)}return n.length>0&&s.push(n),s}project(t){const i=this._y0,r=this._x0,s=this._size;for(let n=0;n<t.length;n++){let a=t[n],u=180-(a[1]+i)*360/s;t[n]=[(a[0]+r)*360/s-180,360/Math.PI*Math.atan(Math.exp(u*Math.PI/180))-90]}return t}};f(F,"geom_types",["Unknown","Point","LineString","Polygon"]);let B=F;class g{static read(t,i){return t.readFields(g._readField,{version:0,name:"",features:[],keys:[],values:[],extent:0},i)}static _readField(t,i,r){t===15?i.version=r.readVarint():t===1?i.name=r.readString():t===2?i.features.push(v.read(r,r.readVarint()+r.pos)):t===3?i.keys.push(r.readString()):t===4?i.values.push(_.read(r,r.readVarint()+r.pos)):t===5&&(i.extent=r.readVarint())}static write(t,i){if(t.version&&i.writeVarintField(15,t.version),t.name&&i.writeStringField(1,t.name),t.features)for(var r=0;r<t.features.length;r++)i.writeMessage(2,v.write,t.features[r]);if(t.keys)for(r=0;r<t.keys.length;r++)i.writeStringField(3,t.keys[r]);if(t.values)for(r=0;r<t.values.length;r++)i.writeMessage(4,_.write,t.values[r]);t.extent&&i.writeVarintField(5,t.extent)}}class v{static read(t,i){return t.readFields(v._readField,{id:0,tags:[],type:0,geometry:[]},i)}static _readField(t,i,r){t===1?i.id=r.readVarint():t===2?r.readPackedVarint(i.tags):t===3?i.type=r.readVarint():t===4&&r.readPackedVarint(i.geometry)}static write(t,i){t.id&&i.writeVarintField(1,t.id),t.tags&&i.writePackedVarint(2,t.tags),t.type&&i.writeVarintField(3,t.type),t.geometry&&i.writePackedVarint(4,t.geometry)}}const V=class V{static read(t,i){return t.readFields(V._readField,{string_value:"",float_value:0,double_value:0,int_value:0,uint_value:0,sint_value:0,bool_value:!1},i)}static write(t,i){t.string_value&&i.writeStringField(1,t.string_value),t.float_value&&i.writeFloatField(2,t.float_value),t.double_value&&i.writeDoubleField(3,t.double_value),t.int_value&&i.writeVarintField(4,t.int_value),t.uint_value&&i.writeVarintField(5,t.uint_value),t.sint_value&&i.writeSVarintField(6,t.sint_value),t.bool_value&&i.writeBooleanField(7,t.bool_value)}};f(V,"_readField",function(t,i,r){t===1?i.string_value=r.readString():t===2?i.float_value=r.readFloat():t===3?i.double_value=r.readDouble():t===4?i.int_value=r.readVarint(!0):t===5?i.uint_value=r.readVarint():t===6?i.sint_value=r.readSVarint():t===7&&(i.bool_value=r.readBoolean())});let _=V;const k=class k{static read(t,i){return t.readFields(k._readField,{layers:[]},i)}static _readField(t,i,r){t===3&&i.layers.push(g.read(r,r.readVarint()+r.pos))}static write(t,i){if(t.layers)for(var r=0;r<t.layers.length;r++)i.writeMessage(3,g.write,t.layers[r])}};f(k,"GeomType",{UNKNOWN:{value:0,options:{}},POINT:{value:1,options:{}},LINESTRING:{value:2,options:{}},POLYGON:{value:3,options:{}}});let S=k;class ot{constructor(t,i,r,s,n,a){f(this,"features");f(this,"x");f(this,"y");f(this,"z");f(this,"_url");f(this,"_layerName");f(this,"_features",new I([]));f(this,"currentlyRunning");this._url=t,this._layerName=n,this.x=i,this.y=r,this.z=s,this.updateAsync(),this.features=this._features.map(u=>u===void 0||(a==null?void 0:a.data)===!1?[]:u,[a])}async updateAsync(){this.currentlyRunning||(this.currentlyRunning=this.download()),await this.currentlyRunning}getValue(t){if(t.string_value!=="")return t.string_value;if(t.double_value!==0)return t.double_value;if(t.float_value!==0)return t.float_value;if(t.int_value!==0)return t.int_value;if(t.uint_value!==0)return t.uint_value;if(t.sint_value!==0)return t.sint_value;if(t.bool_value!==!1)return t.bool_value}async download(){try{const t=await fetch(this._url);if(t.status!==200){console.error("Could not download tile "+this._url);return}const i=await t.arrayBuffer(),r=S.read(new it(i),void 0),s=r.layers;let n=r.layers[0];if(s.length>1){if(!this._layerName)throw"Multiple layers in the downloaded tile, but no layername is given to choose from";n=s.find(l=>l.name===this._layerName)}if(!n)return;const a=new B(n.extent,this.x,this.y,this.z),u=[];for(const l of n.features){const h=this.inflateProperties(l.tags,n.keys,n.values);u.push(a.toGeoJson(l.geometry,l.type,h))}this._features.setData(u)}catch(t){console.error("Could not download MVT tile due to",t)}}inflateProperties(t,i,r){const s={};for(let a=0;a<t.length;a+=2)s[i[t[a]]]=this.getValue(r[t[a+1]]);let n;switch(s.osm_type){case"N":n="node";break;case"W":n="way";break;case"R":n="relation";break}return s.id=n+"/"+s.osm_id,delete s.osm_id,delete s.osm_type,s}}export{ot as M};
//# sourceMappingURL=MvtSource-c54d0bd3.js.map
